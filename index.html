<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Localizer v2 | NORIKS</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #0f0f0f; 
            color: #fff;
            min-height: 100vh;
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 30px;
        }
        
        header h1 { font-size: 24px; font-weight: 600; }
        header h1 span { color: #10b981; }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
        }
        
        .nav-tab {
            padding: 10px 20px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            cursor: pointer;
            color: #888;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .nav-tab:hover { border-color: #10b981; color: #fff; }
        .nav-tab.active { background: #10b981; border-color: #10b981; color: #000; font-weight: 600; }
        
        .section { display: none; }
        .section.active { display: block; }
        
        /* Upload Section */
        .upload-modes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .upload-mode {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 12px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-mode:hover { border-color: #10b981; }
        .upload-mode.selected { border-color: #10b981; background: #1a2f1a; }
        
        .upload-mode h3 { 
            font-size: 18px; 
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-mode p { color: #888; font-size: 14px; line-height: 1.6; }
        
        .upload-mode .mode-icon {
            font-size: 32px;
            margin-bottom: 15px;
        }
        
        .upload-zone {
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }
        
        .upload-zone:hover { border-color: #10b981; }
        .upload-zone.dragover { border-color: #10b981; background: #1a2f1a; }
        .upload-zone.has-file { border-color: #10b981; border-style: solid; }
        
        .upload-zone .icon { font-size: 48px; margin-bottom: 15px; }
        .upload-zone h4 { font-size: 16px; margin-bottom: 5px; }
        .upload-zone p { color: #666; font-size: 13px; }
        .upload-zone .filename { color: #10b981; font-weight: 600; margin-top: 10px; }
        
        .dual-upload {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .dual-upload.visible { display: grid; }
        
        .single-upload { display: none; }
        .single-upload.visible { display: block; }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .btn-primary { background: #10b981; color: #000; }
        .btn-primary:hover { background: #0ea572; }
        .btn-primary:disabled { background: #333; color: #666; cursor: not-allowed; }
        
        .btn-secondary { background: #333; color: #fff; }
        .btn-secondary:hover { background: #444; }
        
        .btn-outline { 
            background: transparent; 
            border: 1px solid #10b981; 
            color: #10b981; 
        }
        .btn-outline:hover { background: #10b981; color: #000; }
        
        /* Analysis Section */
        .analysis-progress {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
        }
        
        .progress-bar {
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #10b981;
            width: 0%;
            transition: width 0.3s;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Variants Table */
        .variants-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .variants-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .segment-card {
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .segment-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .segment-time {
            background: #333;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .segment-thumbnail {
            width: 80px;
            height: 45px;
            background: #333;
            border-radius: 4px;
            object-fit: cover;
        }
        
        .segment-description {
            color: #888;
            font-size: 13px;
            flex: 1;
        }
        
        .variant-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .variant-option {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .variant-option:hover { border-color: #666; }
        .variant-option.selected { border-color: #10b981; background: #1a2f1a; }
        
        .variant-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .variant-text {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .custom-text {
            width: 100%;
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            color: #fff;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        
        .custom-text.visible { display: block; }
        
        .edit-btn {
            background: none;
            border: none;
            color: #10b981;
            cursor: pointer;
            font-size: 13px;
            padding: 5px 10px;
        }
        
        /* Queue Section */
        .queue-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .queue-table th,
        .queue-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        .queue-table th {
            color: #888;
            font-weight: 500;
            font-size: 13px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-ready { background: #1a2f1a; color: #10b981; }
        .status-generating { background: #2f2a1a; color: #f59e0b; }
        .status-done { background: #1a2f1a; color: #10b981; }
        .status-error { background: #2f1a1a; color: #ef4444; }
        
        /* Downloads Section */
        .download-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .download-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .download-name {
            font-size: 16px;
            font-weight: 600;
        }
        
        .download-date {
            color: #666;
            font-size: 13px;
        }
        
        .download-flags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .flag-btn {
            padding: 8px 16px;
            background: #333;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .flag-btn:hover { background: #10b981; color: #000; }
        
        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }
        
        /* Schedule Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.visible { display: flex; }
        
        .modal {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
        }
        
        .modal h3 { margin-bottom: 20px; }
        
        .modal input[type="time"] {
            width: 100%;
            padding: 12px;
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 24px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* Video Preview */
        .preview-video {
            width: 100%;
            max-width: 400px;
            border-radius: 8px;
            margin: 20px auto;
            display: block;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon { font-size: 64px; margin-bottom: 20px; }
        
        .video-name-input {
            width: 100%;
            padding: 12px;
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }
        
        .step.active { color: #10b981; }
        .step.done { color: #10b981; }
        
        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
        }
        
        .step.active .step-number { background: #10b981; color: #000; }
        .step.done .step-number { background: #10b981; color: #000; }
        
        .step-line {
            width: 40px;
            height: 2px;
            background: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Video <span>Localizer</span> v2</h1>
            <div class="nav-tabs">
                <div class="nav-tab active" data-tab="upload">‚ûï Nov video</div>
                <div class="nav-tab" data-tab="queue">üìã Vrsta <span id="queue-count">(0)</span></div>
                <div class="nav-tab" data-tab="downloads">üì• Konƒçani</div>
            </div>
        </header>
        
        <!-- UPLOAD SECTION -->
        <section id="section-upload" class="section active">
            <div class="step-indicator">
                <div class="step active" id="step-1">
                    <div class="step-number">1</div>
                    <span>Upload</span>
                </div>
                <div class="step-line"></div>
                <div class="step" id="step-2">
                    <div class="step-number">2</div>
                    <span>Analiza</span>
                </div>
                <div class="step-line"></div>
                <div class="step" id="step-3">
                    <div class="step-number">3</div>
                    <span>Besedila</span>
                </div>
                <div class="step-line"></div>
                <div class="step" id="step-4">
                    <div class="step-number">4</div>
                    <span>Preview</span>
                </div>
            </div>
            
            <!-- Step 1: Mode Selection & Upload -->
            <div id="upload-step" class="step-content">
                <input type="text" class="video-name-input" id="video-name" placeholder="Ime videa (npr. majice-modra-v1)">
                
                <div class="upload-modes">
                    <div class="upload-mode" id="mode-clean" data-mode="clean">
                        <div class="mode-icon">üé¨</div>
                        <h3>Samo ƒçist video</h3>
                        <p>Nalo≈æim 1 video <strong>BREZ teksta</strong>.<br>AI bo analiziral kadre in predlagal nova besedila.</p>
                    </div>
                    <div class="upload-mode" id="mode-competitor" data-mode="competitor">
                        <div class="mode-icon">üîÑ</div>
                        <h3>Video konkurence</h3>
                        <p>Nalo≈æim 2 videa:<br>‚Ä¢ Video <strong>Z tekstom</strong> (za analizo)<br>‚Ä¢ Video <strong>BREZ teksta</strong> (za render)</p>
                    </div>
                </div>
                
                <div class="single-upload" id="single-upload">
                    <div class="upload-zone" id="zone-single">
                        <div class="icon">üìÅ</div>
                        <h4>Nalo≈æi video BREZ teksta</h4>
                        <p>Povleci sem ali klikni za izbiro</p>
                        <div class="filename" id="filename-single"></div>
                    </div>
                    <input type="file" id="file-single" accept="video/*" hidden>
                </div>
                
                <div class="dual-upload" id="dual-upload">
                    <div>
                        <div class="upload-zone" id="zone-text">
                            <div class="icon">üìù</div>
                            <h4>Video Z tekstom</h4>
                            <p>Konkurenƒçni / referenƒçni video</p>
                            <div class="filename" id="filename-text"></div>
                        </div>
                        <input type="file" id="file-text" accept="video/*" hidden>
                    </div>
                    <div>
                        <div class="upload-zone" id="zone-clean">
                            <div class="icon">üé¨</div>
                            <h4>Video BREZ teksta</h4>
                            <p>ƒåist video za finalni render</p>
                            <div class="filename" id="filename-clean"></div>
                        </div>
                        <input type="file" id="file-clean" accept="video/*" hidden>
                    </div>
                </div>
                
                <div class="actions-bar">
                    <div></div>
                    <button class="btn btn-primary" id="btn-analyze" disabled>Analiziraj video ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 2: Analysis Progress -->
            <div id="analysis-step" class="step-content" style="display:none">
                <div class="analysis-progress">
                    <div class="spinner"></div>
                    <h3 id="analysis-status">Analiziram video...</h3>
                    <p id="analysis-detail" style="color:#888; margin-top:10px">Ekstraktiram kadre</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="analysis-progress"></div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Text Variants Selection -->
            <div id="variants-step" class="step-content" style="display:none">
                <div class="variants-section">
                    <div class="variants-header">
                        <h3>Izberi besedila za vsak kader</h3>
                        <span style="color:#888">Izberi varianto A/B/C ali uredi</span>
                    </div>
                    <div id="segments-list"></div>
                </div>
                
                <div class="actions-bar">
                    <button class="btn btn-secondary" id="btn-back-upload">‚Üê Nazaj</button>
                    <button class="btn btn-primary" id="btn-preview">Generiraj SLO preview ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 4: Preview -->
            <div id="preview-step" class="step-content" style="display:none">
                <div class="variants-section" style="text-align:center">
                    <h3 style="margin-bottom:20px">Slovenski preview</h3>
                    <video id="preview-video" class="preview-video" controls></video>
                    <p style="color:#888; margin-top:15px">Preveri ali tekst ustreza kadrom in ƒçe je timing OK</p>
                </div>
                
                <div class="actions-bar">
                    <button class="btn btn-secondary" id="btn-back-variants">‚Üê Popravi besedila</button>
                    <div>
                        <button class="btn btn-outline" id="btn-add-queue">Dodaj v noƒçno vrsto</button>
                        <button class="btn btn-primary" id="btn-generate-now" style="margin-left:10px">Generiraj zdaj ‚Üí</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- QUEUE SECTION -->
        <section id="section-queue" class="section">
            <div class="variants-section">
                <div class="variants-header">
                    <h3>üìã Noƒçna vrsta</h3>
                    <div>
                        <button class="btn btn-secondary" id="btn-schedule">‚è∞ Nastavi ƒças</button>
                        <button class="btn btn-primary" id="btn-generate-all" style="margin-left:10px">Generiraj vse zdaj</button>
                    </div>
                </div>
                
                <div id="queue-empty" class="empty-state">
                    <div class="icon">üì≠</div>
                    <h3>Vrsta je prazna</h3>
                    <p>Dodaj video s klikom na "Nov video"</p>
                </div>
                
                <table class="queue-table" id="queue-table" style="display:none">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Video</th>
                            <th>Segmenti</th>
                            <th>Status</th>
                            <th>Akcija</th>
                        </tr>
                    </thead>
                    <tbody id="queue-body"></tbody>
                </table>
                
                <div id="schedule-info" style="margin-top:20px; padding:15px; background:#1a2f1a; border-radius:8px; display:none">
                    <strong>‚è∞ Naƒçrtovano generiranje:</strong> <span id="schedule-time">02:00</span>
                </div>
            </div>
        </section>
        
        <!-- DOWNLOADS SECTION -->
        <section id="section-downloads" class="section">
            <div id="downloads-empty" class="empty-state">
                <div class="icon">üì•</div>
                <h3>Ni konƒçanih videov</h3>
                <p>Konƒçani videi se bodo prikazali tukaj</p>
            </div>
            
            <div id="downloads-list"></div>
        </section>
    </div>
    
    <!-- Schedule Modal -->
    <div class="modal-overlay" id="schedule-modal">
        <div class="modal">
            <h3>‚è∞ Nastavi ƒças generiranja</h3>
            <input type="time" id="schedule-time-input" value="02:00">
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modal-cancel">Prekliƒçi</button>
                <button class="btn btn-primary" id="modal-confirm">Potrdi</button>
            </div>
        </div>
    </div>
    
    <script>
        // Safari-compatible POST request helper
        function postJSON(url, data) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', url, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            resolve(JSON.parse(xhr.responseText));
                        } catch(e) {
                            reject(new Error('Invalid JSON: ' + xhr.responseText.substring(0, 100)));
                        }
                    } else {
                        reject(new Error('Server error: ' + xhr.status));
                    }
                };
                xhr.onerror = function() {
                    reject(new Error('Network error'));
                };
                xhr.send(JSON.stringify(data));
            });
        }
        
        function getJSON(url) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', url, true);
                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            resolve(JSON.parse(xhr.responseText));
                        } catch(e) {
                            reject(new Error('Invalid JSON'));
                        }
                    } else {
                        reject(new Error('Server error: ' + xhr.status));
                    }
                };
                xhr.onerror = function() {
                    reject(new Error('Network error'));
                };
                xhr.send();
            });
        }
        
        // State
        let currentMode = null;
        let uploadedFiles = { single: null, text: null, clean: null };
        let uploadedFilenames = { single: null, text: null, clean: null };
        let segments = [];
        let selectedVariants = {};
        let queue = [];
        let downloads = [];
        
        // Load saved data
        function loadSavedData() {
            try {
                queue = JSON.parse(localStorage.getItem('videoQueue') || '[]');
                downloads = JSON.parse(localStorage.getItem('videoDownloads') || '[]');
                updateQueueDisplay();
                updateDownloadsDisplay();
            } catch(e) {}
        }
        
        function saveQueue() {
            localStorage.setItem('videoQueue', JSON.stringify(queue));
        }
        
        function saveDownloads() {
            localStorage.setItem('videoDownloads', JSON.stringify(downloads));
        }
        
        // Tab navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`section-${tab.dataset.tab}`).classList.add('active');
            });
        });
        
        // Mode selection
        document.querySelectorAll('.upload-mode').forEach(mode => {
            mode.addEventListener('click', () => {
                document.querySelectorAll('.upload-mode').forEach(m => m.classList.remove('selected'));
                mode.classList.add('selected');
                currentMode = mode.dataset.mode;
                
                if (currentMode === 'clean') {
                    document.getElementById('single-upload').classList.add('visible');
                    document.getElementById('dual-upload').classList.remove('visible');
                } else {
                    document.getElementById('single-upload').classList.remove('visible');
                    document.getElementById('dual-upload').classList.add('visible');
                }
                
                checkUploadReady();
            });
        });
        
        // File upload handling
        function setupUploadZone(zoneId, inputId, fileKey) {
            const zone = document.getElementById(zoneId);
            const input = document.getElementById(inputId);
            
            zone.addEventListener('click', () => input.click());
            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0], fileKey, zoneId);
                }
            });
            
            input.addEventListener('change', () => {
                if (input.files.length) {
                    handleFile(input.files[0], fileKey, zoneId);
                }
            });
        }
        
        async function handleFile(file, fileKey, zoneId) {
            uploadedFiles[fileKey] = file;
            
            const zone = document.getElementById(zoneId);
            zone.classList.add('has-file');
            zone.querySelector('.filename').textContent = '‚è≥ Nalagam... ' + file.name;
            
            // Upload to server using XMLHttpRequest for Safari compatibility
            const formData = new FormData();
            formData.append('video', file, file.name);
            
            try {
                const result = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/launches/api/upload-video', true);
                    
                    xhr.onload = function() {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch(e) {
                                reject(new Error('Invalid JSON response'));
                            }
                        } else {
                            reject(new Error('Server error: ' + xhr.status));
                        }
                    };
                    
                    xhr.onerror = function() {
                        reject(new Error('Network error'));
                    };
                    
                    xhr.upload.onprogress = function(e) {
                        if (e.lengthComputable) {
                            const pct = Math.round((e.loaded / e.total) * 100);
                            zone.querySelector('.filename').textContent = `‚è≥ ${pct}% - ${file.name}`;
                        }
                    };
                    
                    xhr.send(formData);
                });
                
                if (result.error) {
                    throw new Error(result.error);
                }
                uploadedFilenames[fileKey] = result.filename;
                zone.querySelector('.filename').textContent = '‚úÖ ' + file.name;
                console.log('Upload success:', fileKey, result.filename);
            } catch(e) {
                console.error('Upload error:', e);
                zone.classList.remove('has-file');
                zone.querySelector('.filename').textContent = '‚ùå Napaka: ' + e.message;
                uploadedFilenames[fileKey] = null;
            }
            
            checkUploadReady();
        }
        
        setupUploadZone('zone-single', 'file-single', 'single');
        setupUploadZone('zone-text', 'file-text', 'text');
        setupUploadZone('zone-clean', 'file-clean', 'clean');
        
        function checkUploadReady() {
            const btn = document.getElementById('btn-analyze');
            const name = document.getElementById('video-name').value.trim();
            
            let ready = false;
            if (currentMode === 'clean' && uploadedFilenames.single && name) {
                ready = true;
            } else if (currentMode === 'competitor' && uploadedFilenames.text && uploadedFilenames.clean && name) {
                ready = true;
            }
            
            btn.disabled = !ready;
            
            // Debug info
            console.log('checkUploadReady:', { 
                currentMode, 
                name, 
                single: uploadedFilenames.single,
                text: uploadedFilenames.text,
                clean: uploadedFilenames.clean,
                ready 
            });
            
            // Show what's missing
            if (!ready) {
                let missing = [];
                if (!currentMode) missing.push('izberi naƒçin');
                if (!name) missing.push('vpi≈°i ime');
                if (currentMode === 'clean' && !uploadedFilenames.single) missing.push('nalo≈æi video');
                if (currentMode === 'competitor' && !uploadedFilenames.text) missing.push('nalo≈æi video z tekstom');
                if (currentMode === 'competitor' && !uploadedFilenames.clean) missing.push('nalo≈æi ƒçist video');
                btn.textContent = missing.length ? `Manjka: ${missing.join(', ')}` : 'Analiziraj video ‚Üí';
            } else {
                btn.textContent = 'Analiziraj video ‚Üí';
            }
        }
        
        document.getElementById('video-name').addEventListener('input', checkUploadReady);
        
        // Analyze video
        document.getElementById('btn-analyze').addEventListener('click', async () => {
            const name = document.getElementById('video-name').value.trim();
            
            // Show analysis step
            document.getElementById('upload-step').style.display = 'none';
            document.getElementById('analysis-step').style.display = 'block';
            updateStepIndicator(2);
            
            const videoToAnalyze = currentMode === 'clean' ? uploadedFilenames.single : uploadedFilenames.text;
            
            try {
                // Step 1: Extract and analyze frames
                updateAnalysisStatus('Analiziram kadre...', 'GPT-4o Vision prebira vsebino', 20);
                
                const analyzeData = await postJSON('/launches/api/localizer/analyze', { 
                    filename: videoToAnalyze,
                    mode: currentMode
                });
                if (analyzeData.error) throw new Error(analyzeData.error);
                
                // Step 2: Generate text variants
                updateAnalysisStatus('Generiram besedila...', 'AI predlaga 3 variante za vsak kader', 60);
                
                const variantsData = await postJSON('/launches/api/localizer/variants', { 
                    segments: analyzeData.segments,
                    existingTexts: analyzeData.texts || []
                });
                if (variantsData.error) throw new Error(variantsData.error);
                
                segments = variantsData.segments;
                
                // Initialize selected variants
                segments.forEach((seg, i) => {
                    selectedVariants[i] = { variant: 'A', text: seg.variants.A };
                });
                
                updateAnalysisStatus('Pripravljam vmesnik...', 'Skoraj konƒçano', 90);
                
                // Show variants step
                setTimeout(() => {
                    document.getElementById('analysis-step').style.display = 'none';
                    document.getElementById('variants-step').style.display = 'block';
                    updateStepIndicator(3);
                    renderSegments();
                }, 500);
                
            } catch(e) {
                alert('Napaka: ' + e.message);
                document.getElementById('analysis-step').style.display = 'none';
                document.getElementById('upload-step').style.display = 'block';
                updateStepIndicator(1);
            }
        });
        
        function updateAnalysisStatus(title, detail, progress) {
            document.getElementById('analysis-status').textContent = title;
            document.getElementById('analysis-detail').textContent = detail;
            document.getElementById('analysis-progress').style.width = progress + '%';
        }
        
        function updateStepIndicator(step) {
            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById(`step-${i}`);
                el.classList.remove('active', 'done');
                if (i < step) el.classList.add('done');
                if (i === step) el.classList.add('active');
            }
        }
        
        function renderSegments() {
            const container = document.getElementById('segments-list');
            container.innerHTML = segments.map((seg, i) => `
                <div class="segment-card">
                    <div class="segment-header">
                        <span class="segment-time">${formatTime(seg.start)} - ${formatTime(seg.end)}</span>
                        <img class="segment-thumbnail" src="${seg.thumbnail || '/api/placeholder/80/45'}" alt="">
                        <span class="segment-description">${seg.description || 'Kader ' + (i+1)}</span>
                        <button class="edit-btn" onclick="toggleCustom(${i})">‚úèÔ∏è Uredi</button>
                    </div>
                    <div class="variant-options">
                        ${['A', 'B', 'C'].map(v => `
                            <div class="variant-option ${selectedVariants[i]?.variant === v ? 'selected' : ''}" 
                                 onclick="selectVariant(${i}, '${v}', '${escapeHtml(seg.variants[v])}')">
                                <div class="variant-label">Varianta ${v}</div>
                                <div class="variant-text">${seg.variants[v]}</div>
                            </div>
                        `).join('')}
                    </div>
                    <textarea class="custom-text" id="custom-${i}" 
                              placeholder="Vpi≈°i svoje besedilo..."
                              onchange="setCustomText(${i}, this.value)">${selectedVariants[i]?.custom || ''}</textarea>
                </div>
            `).join('');
        }
        
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }
        
        function escapeHtml(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }
        
        function selectVariant(segIndex, variant, text) {
            selectedVariants[segIndex] = { variant, text };
            document.getElementById(`custom-${segIndex}`).classList.remove('visible');
            renderSegments();
        }
        
        function toggleCustom(segIndex) {
            const textarea = document.getElementById(`custom-${segIndex}`);
            textarea.classList.toggle('visible');
            if (textarea.classList.contains('visible')) {
                textarea.focus();
            }
        }
        
        function setCustomText(segIndex, text) {
            if (text.trim()) {
                selectedVariants[segIndex] = { variant: 'custom', text: text.trim(), custom: text.trim() };
            }
        }
        
        // Back button
        document.getElementById('btn-back-upload').addEventListener('click', () => {
            document.getElementById('variants-step').style.display = 'none';
            document.getElementById('upload-step').style.display = 'block';
            updateStepIndicator(1);
        });
        
        // Preview
        document.getElementById('btn-preview').addEventListener('click', async () => {
            const videoClean = currentMode === 'clean' ? uploadedFilenames.single : uploadedFilenames.clean;
            const name = document.getElementById('video-name').value.trim();
            
            // Build texts array
            const texts = segments.map((seg, i) => ({
                start: seg.start,
                end: seg.end,
                text: selectedVariants[i].text
            }));
            
            // Show loading
            document.getElementById('variants-step').style.display = 'none';
            document.getElementById('analysis-step').style.display = 'block';
            updateAnalysisStatus('Generiram SLO preview...', 'Renderiranje video z besedili', 50);
            
            try {
                const data = await postJSON('/launches/api/localizer/preview', {
                    videoClean,
                    name,
                    texts,
                    language: 'SLO'
                });
                if (data.error) throw new Error(data.error);
                
                // Show preview
                document.getElementById('analysis-step').style.display = 'none';
                document.getElementById('preview-step').style.display = 'block';
                document.getElementById('preview-video').src = data.videoUrl;
                updateStepIndicator(4);
                
            } catch(e) {
                alert('Napaka: ' + e.message);
                document.getElementById('analysis-step').style.display = 'none';
                document.getElementById('variants-step').style.display = 'block';
                updateStepIndicator(3);
            }
        });
        
        // Back to variants
        document.getElementById('btn-back-variants').addEventListener('click', () => {
            document.getElementById('preview-step').style.display = 'none';
            document.getElementById('variants-step').style.display = 'block';
            updateStepIndicator(3);
        });
        
        // Add to queue
        document.getElementById('btn-add-queue').addEventListener('click', () => {
            const videoClean = currentMode === 'clean' ? uploadedFilenames.single : uploadedFilenames.clean;
            const name = document.getElementById('video-name').value.trim();
            
            const texts = segments.map((seg, i) => ({
                start: seg.start,
                end: seg.end,
                text: selectedVariants[i].text
            }));
            
            queue.push({
                id: Date.now(),
                name,
                videoClean,
                texts,
                segments: segments.length,
                status: 'ready',
                created: new Date().toISOString()
            });
            
            saveQueue();
            updateQueueDisplay();
            
            // Reset form
            resetUploadForm();
            
            // Show success message
            alert('‚úÖ Dodano v noƒçno vrsto!');
            
            // Switch to queue tab
            document.querySelector('[data-tab="queue"]').click();
        });
        
        // Generate now
        document.getElementById('btn-generate-now').addEventListener('click', async () => {
            const videoClean = currentMode === 'clean' ? uploadedFilenames.single : uploadedFilenames.clean;
            const name = document.getElementById('video-name').value.trim();
            
            const texts = segments.map((seg, i) => ({
                start: seg.start,
                end: seg.end,
                text: selectedVariants[i].text
            }));
            
            // Show loading
            document.getElementById('preview-step').style.display = 'none';
            document.getElementById('analysis-step').style.display = 'block';
            updateAnalysisStatus('Generiram 7 dr≈æav...', 'To lahko traja nekaj minut', 0);
            
            try {
                const data = await postJSON('/launches/api/localizer/generate', { videoClean, name, texts });
                if (data.error) throw new Error(data.error);
                
                // Poll for progress
                await pollJobProgress(data.jobId);
                
            } catch(e) {
                alert('Napaka: ' + e.message);
                document.getElementById('analysis-step').style.display = 'none';
                document.getElementById('preview-step').style.display = 'block';
            }
        });
        
        async function pollJobProgress(jobId) {
            while (true) {
                const job = await getJSON(`/launches/api/localizer/job/${jobId}`);
                
                if (job.status === 'done') {
                    // Add to downloads
                    downloads.unshift({
                        id: jobId,
                        name: job.name,
                        created: new Date().toISOString(),
                        outputs: job.outputs
                    });
                    saveDownloads();
                    updateDownloadsDisplay();
                    
                    // Reset and go to downloads
                    resetUploadForm();
                    document.querySelector('[data-tab="downloads"]').click();
                    break;
                    
                } else if (job.status === 'error') {
                    throw new Error(job.error);
                    
                } else {
                    updateAnalysisStatus(
                        `Generiram ${job.completed || 0}/7 dr≈æav...`,
                        job.currentLang || 'Prosim poƒçakaj',
                        (job.completed || 0) / 7 * 100
                    );
                    await new Promise(r => setTimeout(r, 2000));
                }
            }
        }
        
        function resetUploadForm() {
            document.getElementById('video-name').value = '';
            uploadedFiles = { single: null, text: null, clean: null };
            uploadedFilenames = { single: null, text: null, clean: null };
            segments = [];
            selectedVariants = {};
            currentMode = null;
            
            document.querySelectorAll('.upload-zone').forEach(z => {
                z.classList.remove('has-file');
                z.querySelector('.filename').textContent = '';
            });
            document.querySelectorAll('.upload-mode').forEach(m => m.classList.remove('selected'));
            document.getElementById('single-upload').classList.remove('visible');
            document.getElementById('dual-upload').classList.remove('visible');
            document.getElementById('btn-analyze').disabled = true;
            
            document.getElementById('preview-step').style.display = 'none';
            document.getElementById('variants-step').style.display = 'none';
            document.getElementById('analysis-step').style.display = 'none';
            document.getElementById('upload-step').style.display = 'block';
            updateStepIndicator(1);
        }
        
        function updateQueueDisplay() {
            document.getElementById('queue-count').textContent = `(${queue.length})`;
            
            if (queue.length === 0) {
                document.getElementById('queue-empty').style.display = 'block';
                document.getElementById('queue-table').style.display = 'none';
            } else {
                document.getElementById('queue-empty').style.display = 'none';
                document.getElementById('queue-table').style.display = 'table';
                
                document.getElementById('queue-body').innerHTML = queue.map((item, i) => `
                    <tr>
                        <td>${i + 1}</td>
                        <td><strong>${item.name}</strong></td>
                        <td>${item.segments} segmentov</td>
                        <td><span class="status-badge status-${item.status}">${
                            item.status === 'ready' ? '‚úÖ Pripravljen' :
                            item.status === 'generating' ? '‚è≥ Generira...' :
                            item.status === 'done' ? '‚úì Konƒçano' : '‚ùå Napaka'
                        }</span></td>
                        <td>
                            <button class="btn btn-secondary" style="padding:6px 12px; font-size:12px" 
                                    onclick="removeFromQueue(${item.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
            }
        }
        
        function removeFromQueue(id) {
            queue = queue.filter(q => q.id !== id);
            saveQueue();
            updateQueueDisplay();
        }
        
        function updateDownloadsDisplay() {
            if (downloads.length === 0) {
                document.getElementById('downloads-empty').style.display = 'block';
                document.getElementById('downloads-list').innerHTML = '';
            } else {
                document.getElementById('downloads-empty').style.display = 'none';
                
                document.getElementById('downloads-list').innerHTML = downloads.map(item => `
                    <div class="download-card">
                        <div class="download-header">
                            <div>
                                <div class="download-name">üìÅ ${item.name}</div>
                                <div class="download-date">${new Date(item.created).toLocaleString('sl-SI')}</div>
                            </div>
                            <a href="/launches/api/localizer/job/${item.id}/zip" class="btn btn-primary">‚¨áÔ∏è ZIP vse</a>
                        </div>
                        <div class="download-flags">
                            ${['HR', 'CZ', 'PL', 'GR', 'IT', 'HU', 'SK'].map(lang => `
                                <a href="/launches/api/localizer/job/${item.id}/video/${lang}" class="flag-btn">
                                    ${lang === 'HR' ? 'üá≠üá∑' : lang === 'CZ' ? 'üá®üáø' : lang === 'PL' ? 'üáµüá±' : 
                                      lang === 'GR' ? 'üá¨üá∑' : lang === 'IT' ? 'üáÆüáπ' : lang === 'HU' ? 'üá≠üá∫' : 'üá∏üá∞'} ${lang}
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // Schedule modal
        document.getElementById('btn-schedule').addEventListener('click', () => {
            document.getElementById('schedule-modal').classList.add('visible');
        });
        
        document.getElementById('modal-cancel').addEventListener('click', () => {
            document.getElementById('schedule-modal').classList.remove('visible');
        });
        
        document.getElementById('modal-confirm').addEventListener('click', () => {
            const time = document.getElementById('schedule-time-input').value;
            document.getElementById('schedule-time').textContent = time;
            document.getElementById('schedule-info').style.display = 'block';
            document.getElementById('schedule-modal').classList.remove('visible');
            
            // TODO: Save schedule to server
        });
        
        // Generate all queue
        document.getElementById('btn-generate-all').addEventListener('click', async () => {
            if (queue.length === 0) {
                alert('Vrsta je prazna!');
                return;
            }
            
            if (!confirm(`Generiraj ${queue.length} videov zdaj?`)) return;
            
            for (const item of queue) {
                if (item.status !== 'ready') continue;
                
                item.status = 'generating';
                updateQueueDisplay();
                
                try {
                    const data = await postJSON('/launches/api/localizer/generate', {
                        videoClean: item.videoClean,
                        name: item.name,
                        texts: item.texts
                    });
                    await pollQueueJobProgress(data.jobId, item);
                    
                } catch(e) {
                    item.status = 'error';
                    item.error = e.message;
                    saveQueue();
                    updateQueueDisplay();
                }
            }
        });
        
        async function pollQueueJobProgress(jobId, queueItem) {
            while (true) {
                const job = await getJSON(`/launches/api/localizer/job/${jobId}`);
                
                if (job.status === 'done') {
                    downloads.unshift({
                        id: jobId,
                        name: job.name,
                        created: new Date().toISOString(),
                        outputs: job.outputs
                    });
                    saveDownloads();
                    updateDownloadsDisplay();
                    
                    // Remove from queue
                    queue = queue.filter(q => q.id !== queueItem.id);
                    saveQueue();
                    updateQueueDisplay();
                    break;
                    
                } else if (job.status === 'error') {
                    queueItem.status = 'error';
                    queueItem.error = job.error;
                    saveQueue();
                    updateQueueDisplay();
                    break;
                    
                } else {
                    await new Promise(r => setTimeout(r, 3000));
                }
            }
        }
        
        // Initialize
        loadSavedData();
    </script>
</body>
</html>
