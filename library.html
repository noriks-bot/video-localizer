<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Localizer v2 | NORIKS</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #0f0f0f; 
            color: #fff;
            min-height: 100vh;
        }
        
        .container { max-width: 1500px; margin: 0 auto; padding: 20px; }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 30px;
        }
        
        header h1 { font-size: 24px; font-weight: 600; }
        header h1 span { color: #10b981; }
        
        /* Mode Tabs */
        .mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .mode-tab {
            padding: 15px 30px;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            text-align: center;
        }
        
        .mode-tab:hover { border-color: #10b981; }
        .mode-tab.active { border-color: #10b981; background: #1a2f1a; }
        .mode-tab h3 { font-size: 16px; margin-bottom: 5px; }
        .mode-tab p { font-size: 13px; color: #888; }
        
        .mode-content { display: none; }
        .mode-content.active { display: block; }
        
        .layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
        }
        
        /* Text Library Sidebar */
        .library {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
            max-height: 80vh;
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }
        
        .library h3 {
            font-size: 14px;
            color: #888;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .library-section {
            margin-bottom: 20px;
        }
        
        .library-section h4 {
            font-size: 12px;
            color: #10b981;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        
        .library-section h4:hover { color: #34d399; }
        
        .library-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .library-items.collapsed { display: none; }
        
        .text-item {
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 8px 10px;
            cursor: grab;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .text-item:hover {
            border-color: #10b981;
            background: #1a2f1a;
        }
        
        .text-item.dragging { opacity: 0.5; }
        
        .text-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        
        .text-item .text-content {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .text-item .delete-btn {
            opacity: 0;
            color: #f87171;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 4px;
            transition: opacity 0.2s;
        }
        
        .text-item:hover .delete-btn {
            opacity: 0.6;
        }
        
        .text-item .delete-btn:hover {
            opacity: 1;
        }
        
        /* Style Selector */
        .style-selector {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .style-selector h4 {
            font-size: 13px;
            color: #888;
            margin-bottom: 12px;
        }
        
        .style-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .style-option {
            padding: 15px 10px;
            background: #0f0f0f;
            border: 2px solid #333;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .style-option:hover { border-color: #666; }
        .style-option.selected { border-color: #10b981; background: #1a2f1a; }
        
        .style-preview {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 4px;
        }
        
        .style-preview.style-white { background: #fff; color: #000; }
        .style-preview.style-black { background: #000; color: #fff; border: 1px solid #333; }
        .style-preview.style-shadow { background: transparent; color: #fff; text-shadow: 2px 2px 4px rgba(0,0,0,0.9); }
        .style-preview.style-rounded { background: #fff; color: #000; border-radius: 20px; }
        .style-preview.style-gradient { background: linear-gradient(135deg, #10b981, #3b82f6); color: #fff; }
        .style-preview.style-outline { background: transparent; color: #fff; border: 2px solid #fff; }
        .style-preview.style-red { background: #ef4444; color: #fff; }
        .style-preview.style-orange { background: #f97316; color: #fff; }
        .style-preview.style-yellow { background: #eab308; color: #000; }
        .style-preview.style-fire { background: linear-gradient(135deg, #ef4444, #f97316, #eab308); color: #fff; }
        .style-preview.style-neon { background: #000; color: #0ff; text-shadow: 0 0 10px #0ff; }
        .style-preview.style-explosive { background: linear-gradient(135deg, #dc2626, #7c3aed); color: #fff; }
        .style-preview.style-green { background: #22c55e; color: #fff; }
        .style-preview.style-pulse { background: linear-gradient(135deg, #22c55e, #10b981); color: #fff; }
        .style-preview.style-urgent { background: #dc2626; color: #fff; border: 2px solid #fbbf24; }
        .style-preview.style-gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
        
        .style-name { font-size: 11px; color: #888; }
        
        /* Creative Items */
        .creative-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #0f0f0f;
            border: 2px solid #333;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        .creative-item:hover { border-color: #10b981; }
        .creative-item.active { border-color: #10b981; background: #1a2f1a; }
        .creative-item.ready { border-color: #22c55e; }
        .creative-item.ready::before { content: '‚úì'; color: #22c55e; margin-right: 4px; }
        .creative-item .remove-btn {
            color: #f87171;
            margin-left: 8px;
            opacity: 0.5;
            cursor: pointer;
        }
        .creative-item .remove-btn:hover { opacity: 1; }
        .creative-item.generating { border-color: #fbbf24; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* Upload Section */
        .upload-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
        }
        
        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .upload-zone {
            border: 2px dashed #444;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-zone:hover { border-color: #10b981; }
        .upload-zone.has-file { border-color: #10b981; border-style: solid; }
        .upload-zone .icon { font-size: 32px; margin-bottom: 10px; }
        .upload-zone h4 { font-size: 14px; margin-bottom: 5px; }
        .upload-zone p { font-size: 12px; color: #666; }
        
        .video-preview {
            width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        /* Timeline */
        .timeline-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .timeline {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .timeline-item {
            display: grid;
            grid-template-columns: 80px 80px 1fr auto;
            gap: 10px;
            align-items: center;
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
        }
        
        .timeline-time {
            font-size: 12px;
            color: #888;
            font-family: monospace;
        }
        
        .duration-control {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
        }
        
        .dur-btn {
            width: 20px;
            height: 20px;
            border: 1px solid #444;
            background: #333;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dur-btn:hover {
            background: #10b981;
            border-color: #10b981;
        }
        
        .dur-value {
            font-size: 11px;
            color: #10b981;
            min-width: 30px;
            text-align: center;
        }
        
        .timeline-thumb {
            width: 80px;
            height: 45px;
            background: #333;
            border-radius: 4px;
            object-fit: cover;
        }
        
        .timeline-dropzone {
            min-height: 45px;
            border: 2px dashed #333;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-wrap: wrap;
            padding: 4px;
            transition: all 0.2s;
        }
        
        .timeline-dropzone:hover,
        .timeline-dropzone.dragover {
            border-color: #10b981;
            background: #1a2f1a;
        }
        
        .timeline-dropzone .placeholder {
            color: #555;
            font-size: 12px;
        }
        
        .timeline-dropzone .text-content {
            background: #10b981;
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin: 2px;
        }
        
        .timeline-dropzone .text-content .remove {
            cursor: pointer;
            opacity: 0.7;
            font-size: 16px;
        }
        
        .timeline-dropzone .text-content .remove:hover { opacity: 1; }
        
        .timeline-dropzone.stacked {
            flex-direction: column;
            align-items: stretch;
        }
        
        .timeline-dropzone.stacked .text-content {
            width: 100%;
            justify-content: space-between;
        }
        
        .segment-options {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .simultaneous-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #888;
            cursor: pointer;
        }
        
        .simultaneous-toggle input {
            cursor: pointer;
        }
        
        .simultaneous-toggle:hover {
            color: #10b981;
        }
        
        .segment-desc {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .timeline-dropzone.suggested-hook { border-color: #a78bfa; background: #a78bfa10; }
        .timeline-dropzone.suggested-problem { border-color: #f87171; background: #f8717110; }
        .timeline-dropzone.suggested-solution { border-color: #34d399; background: #34d39910; }
        .timeline-dropzone.suggested-benefit { border-color: #60a5fa; background: #60a5fa10; }
        .timeline-dropzone.suggested-cta { border-color: #fbbf24; background: #fbbf2410; }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .btn-primary { background: #10b981; color: #000; }
        .btn-primary:hover { background: #0ea572; }
        .btn-primary:disabled { background: #333; color: #666; cursor: not-allowed; }
        
        .btn-secondary { background: #333; color: #fff; }
        .btn-secondary:hover { background: #444; }
        
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }
        
        .name-input {
            width: 100%;
            padding: 12px;
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .product-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .product-btn {
            padding: 8px 14px;
            background: #333;
            border: none;
            border-radius: 6px;
            color: #888;
            cursor: pointer;
            font-size: 12px;
        }
        
        .product-btn.active { background: #10b981; color: #000; }
        
        .gender-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .gender-btn {
            padding: 6px 10px;
            background: #333;
            border: none;
            border-radius: 6px;
            color: #888;
            cursor: pointer;
            font-size: 11px;
            flex: 1;
        }
        
        .gender-btn.active { background: #3b82f6; color: #fff; }
        
        .add-custom {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }
        
        .add-custom input {
            width: 100%;
            padding: 8px;
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        /* Mode 2 specific */
        .localize-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .detected-texts {
            margin-top: 20px;
        }
        
        .detected-text-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 8px;
        }
        
        .detected-text-item .time { color: #888; font-size: 12px; min-width: 30px; }
        .detected-text-item .text { flex: 1; margin: 0 15px; }
        
        .edit-text-input {
            flex: 1;
            margin: 0 10px;
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }
        
        .edit-text-input:focus {
            border-color: #10b981;
            outline: none;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-analyzing { background: #f59e0b20; color: #fbbf24; }
        .status-ready { background: #10b98120; color: #34d399; }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* Queue Panel */
        .queue-panel {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            border: 2px solid #333;
        }
        
        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        .queue-header h3 {
            font-size: 16px;
            margin: 0;
        }
        
        .queue-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #queue-count {
            color: #888;
            font-size: 13px;
        }
        
        .queue-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .queue-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }
        
        .queue-item-info {
            flex: 1;
        }
        
        .queue-item-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .queue-item-meta {
            font-size: 12px;
            color: #888;
        }
        
        .queue-item-status {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .queue-item-status.pending { background: #f59e0b20; color: #fbbf24; }
        .queue-item-status.processing { background: #3b82f620; color: #60a5fa; }
        .queue-item-status.done { background: #10b98120; color: #34d399; }
        .queue-item-status.error { background: #ef444420; color: #f87171; }
        
        .queue-schedule {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
            font-size: 13px;
            color: #888;
        }
        
        .font-size-control {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #1a1a1a;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .font-size-control label {
            font-size: 13px;
            color: #888;
        }
        
        .font-size-control input[type="range"] {
            flex: 1;
            max-width: 200px;
            accent-color: #10b981;
        }
        
        #font-size-value {
            font-size: 13px;
            color: #10b981;
            font-weight: 600;
            min-width: 45px;
        }
        
        .upload-preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .upload-preview-grid .upload-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
        }
        
        .preview-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            position: sticky;
            top: 20px;
        }
        
        .preview-section .video-preview {
            width: 100%;
            max-height: 350px;
            border-radius: 8px;
        }
        
        /* Login Modal */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .login-box {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 360px;
            border: 1px solid #333;
        }
        
        .login-box h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .login-box h2 span { color: #10b981; }
        
        .login-input {
            width: 100%;
            padding: 14px 16px;
            background: #0f0f0f;
            border: 2px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            margin-bottom: 15px;
            transition: border-color 0.2s;
        }
        
        .login-input:focus {
            outline: none;
            border-color: #10b981;
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: #10b981;
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .login-btn:hover { background: #34d399; }
        
        .login-error {
            color: #f87171;
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }
        
        .user-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #1a1a1a;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .user-badge .avatar {
            width: 28px;
            height: 28px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #000;
            text-transform: uppercase;
        }
        
        .user-badge .logout-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .user-badge .logout-btn:hover {
            background: #333;
            color: #f87171;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="login-overlay" class="login-overlay">
        <div class="login-box">
            <h2>üé¨ Video <span>Localizer</span></h2>
            <input type="text" id="login-username" class="login-input" placeholder="Uporabni≈°ko ime" autocomplete="off">
            <input type="password" id="login-password" class="login-input" placeholder="Geslo" autocomplete="off">
            <button class="login-btn" onclick="attemptLogin()">Prijava</button>
            <div id="login-error" class="login-error">Napaƒçno uporabni≈°ko ime ali geslo</div>
        </div>
    </div>
    
    <!-- Downloads Panel (Slide-in) -->
    <div id="downloads-panel" style="position:fixed; top:0; right:-450px; width:450px; height:100vh; background:#1a1a1a; border-left:1px solid #333; z-index:1000; transition:right 0.3s; overflow-y:auto; padding:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0;">üì• Downloads</h3>
            <button onclick="toggleDownloads()" style="background:none; border:none; color:#fff; font-size:24px; cursor:pointer;">‚úï</button>
        </div>
        
        <!-- Tabs -->
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <button id="tab-library" onclick="switchDownloadTab('library')" style="flex:1; padding:10px; background:#10b981; border:none; border-radius:6px 6px 0 0; color:#000; font-weight:600; cursor:pointer;">
                üìö Knji≈ænica
            </button>
            <button id="tab-localize" onclick="switchDownloadTab('localize')" style="flex:1; padding:10px; background:#333; border:none; border-radius:6px 6px 0 0; color:#888; cursor:pointer;">
                üîÑ Lokaliziraj
            </button>
        </div>
        
        <input type="text" id="downloads-search" placeholder="üîç I≈°ƒçi po ID..." style="width:100%; padding:10px; background:#0f0f0f; border:1px solid #333; border-radius:6px; color:#fff; margin-bottom:15px;" oninput="filterDownloads()">
        <div id="downloads-list">
            <div style="color:#666; text-align:center; padding:40px;">Nalagam...</div>
        </div>
    </div>
    <div id="downloads-overlay" onclick="toggleDownloads()" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; display:none;"></div>
    
    <div class="container">
        <header>
            <h1>Video <span>Localizer</span> v2</h1>
            <div style="display:flex; gap:15px; align-items:center;">
                <div id="user-badge" class="user-badge" style="display:none;">
                    <div class="avatar" id="user-avatar">?</div>
                    <span id="user-name">User</span>
                    <button class="logout-btn" onclick="logout()">Odjava</button>
                </div>
                <a href="downloads.html" class="btn" style="background: #10b981; text-decoration: none; display: inline-block;" onclick="if(typeof savePairMetadata==='function')savePairMetadata();if(typeof saveVideoPairsToStorage==='function')saveVideoPairsToStorage();">üì• Downloads</a>
            </div>
        </header>
        
        <!-- Mode Selection -->
        <div class="mode-tabs">
            <div class="mode-tab active" data-mode="library">
                <h3>üìö Knji≈ænica tekstov</h3>
                <p>Izberi in povleci tekste iz knji≈ænice na kadre</p>
            </div>
            <div class="mode-tab" data-mode="localize">
                <h3>üîÑ Lokaliziraj obstojeƒçi video</h3>
                <p>Nalo≈æi video z besedilom ‚Üí prevedi v 7 jezikov</p>
            </div>
        </div>
        
        <!-- MODE 1: Library -->
        <div class="mode-content active" id="mode-library">
            <div class="layout">
                <!-- Text Library Sidebar -->
                <div class="library">
                    <h3>üìö Tekst Knji≈ænica</h3>
                    <p style="font-size:11px; color:#666; margin-bottom:12px;">Dvojni klik = uredi | Povleci = dodaj na timeline</p>
                    
                    <div class="product-toggle">
                        <button class="product-btn active" data-product="tshirt">üëï Majice</button>
                        <button class="product-btn" data-product="boxers">ü©≤ Bokserice</button>
                    </div>
                    
                    <div id="library-content"></div>
                    
                    <div class="add-custom">
                        <select id="custom-category" style="width:100%; padding:8px; background:#0f0f0f; border:1px solid #333; border-radius:6px; color:#fff; font-size:12px; margin-bottom:8px;">
                            <option value="hook_problem">üéØ HOOK + PROBLEM</option>
                            <option value="solution_benefit" selected>‚úÖ RE≈†ITEV + BENEFIT</option>
                            <option value="trust">‚≠ê TRUST</option>
                            <option value="cta">üëÜ CTA</option>
                        </select>
                        <input type="text" id="custom-text" placeholder="Dodaj svoj tekst...">
                        <button class="btn btn-secondary btn-sm" onclick="addCustomText()" style="width:100%">+ Dodaj</button>
                    </div>
                </div>
                
                <!-- Main Content -->
                <div class="main-content">
                    <!-- 1. Video Naming Convention -->
                    <div class="naming-section" style="background:#1a1a1a; border-radius:10px; padding:15px; margin-bottom:20px;">
                        <h4 style="margin-bottom:12px; font-size:14px; color:#888;">üìù Poimenovanje</h4>
                        <div style="display:grid; grid-template-columns: 100px 120px 130px 130px 80px; gap:10px; align-items:center;">
                            <div>
                                <label style="font-size:11px; color:#666; display:block; margin-bottom:4px;">ID</label>
                                <input type="text" id="video-id" placeholder="ID333" style="width:100%; padding:8px; background:#0f0f0f; border:1px solid #333; border-radius:6px; color:#fff; font-size:13px;">
                            </div>
                            <div>
                                <label style="font-size:11px; color:#666; display:block; margin-bottom:4px;">Datum</label>
                                <input type="text" id="video-date" readonly style="width:100%; padding:8px; background:#0f0f0f; border:1px solid #333; border-radius:6px; color:#fff; font-size:13px;">
                            </div>
                            <div>
                                <label style="font-size:11px; color:#666; display:block; margin-bottom:4px;">Produkt</label>
                                <select id="video-product" style="width:100%; padding:8px; background:#0f0f0f; border:1px solid #333; border-radius:6px; color:#fff; font-size:13px;">
                                    <option value="BOXERS">BOXERS</option>
                                    <option value="SHIRTS">SHIRTS</option>
                                    <option value="STARTER_PACK">STARTER_PACK</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:11px; color:#666; display:block; margin-bottom:4px;">Tip kreative</label>
                                <select id="video-type" style="width:100%; padding:8px; background:#0f0f0f; border:1px solid #333; border-radius:6px; color:#fff; font-size:13px;">
                                    <option value="NEW">NEW</option>
                                    <option value="MIX">MIX</option>
                                    <option value="PIRAT">PIRAT</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:11px; color:#666; display:block; margin-bottom:4px;">Avtor</label>
                                <input type="text" id="video-author" placeholder="DD" maxlength="4" style="width:100%; padding:8px; background:#0f0f0f; border:1px solid #333; border-radius:6px; color:#fff; font-size:13px; text-transform:uppercase;">
                            </div>
                        </div>
                        <div style="margin-top:10px; padding:10px; background:#0f0f0f; border-radius:6px; font-family:monospace; font-size:12px; color:#10b981;">
                            Preview: <span id="name-preview">ID_DD-MM-YY_HR_PRODUCT_TYPE_AUTHOR</span>
                        </div>
                    </div>
                    
                    <!-- 2. Bulk Upload Zone (Kreative) -->
                    <div class="bulk-upload-section" style="background:#1a1a1a; border-radius:10px; padding:15px; margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <h4 style="font-size:14px; color:#888;">üì¶ Kreative</h4>
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('file-input-bulk').click()">+ Nalo≈æi veƒç</button>
                        </div>
                        <input type="file" id="file-input-bulk" accept="video/*" multiple hidden>
                        <div id="creatives-list" style="display:flex; flex-wrap:wrap; gap:8px; min-height:40px;">
                            <div class="empty-state" style="font-size:13px; color:#666; padding:10px;">Nalo≈æi enega ali veƒç videov</div>
                        </div>
                    </div>
                    
                    <!-- 3. Upload + Preview Side by Side -->
                    <div class="upload-preview-grid" id="single-upload-section">
                        <div class="upload-section">
                            <div class="upload-zone" id="upload-zone">
                                <div class="icon">üìÅ</div>
                                <h4>Nalo≈æi ƒçist video (brez teksta)</h4>
                                <p>Povleci sem ali klikni (ali uporabi bulk upload zgoraj)</p>
                            </div>
                            <input type="file" id="file-input" accept="video/*" hidden>
                        </div>
                        <div class="preview-section" id="preview-section" style="display:none">
                            <h4 style="margin-bottom:10px">üëÅÔ∏è Preview</h4>
                            <video id="video-preview" class="video-preview" controls></video>
                        </div>
                    </div>
                    
                    <!-- 4. Timeline -->
                    <div class="timeline-section">
                        <div class="timeline-header">
                            <h3>üìπ Timeline</h3>
                            <button class="btn btn-secondary btn-sm" onclick="addSegment()">+ Dodaj kader</button>
                        </div>
                        <div class="timeline" id="timeline">
                            <div class="empty-state">Najprej nalo≈æi video</div>
                        </div>
                    </div>
                    
                    <!-- 5. Live Style Preview (9:16) -->
                    <div class="style-preview-box" style="background:#1a1a1a; border-radius:10px; padding:15px; margin-top:20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <h4 style="font-size:14px; color:#888; margin:0;">üëÅÔ∏è Preview stila</h4>
                            <input type="text" id="preview-text-input" value="NORIKS" placeholder="Vnesi tekst..." 
                                   style="width:150px; padding:6px 10px; background:#0f0f0f; border:1px solid #333; border-radius:6px; color:#fff; font-size:13px; text-align:center;"
                                   oninput="updateStylePreview()">
                        </div>
                        <div id="style-preview-container" style="background:#000; border-radius:8px; aspect-ratio:9/16; max-height:400px; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;">
                            <div id="style-preview-text" style="font-family: Arial, sans-serif; font-weight: bold; padding: 10px 20px;">
                                NORIKS
                            </div>
                        </div>
                    </div>
                    
                    <!-- 6. Font Size Control -->
                    <div class="font-size-control" style="margin-top:20px;">
                        <label>üî§ Velikost teksta:</label>
                        <input type="range" id="font-size" min="40" max="200" value="130" oninput="updateFontSize(this.value)">
                        <span id="font-size-value">105px</span>
                    </div>
                    
                    <!-- 7. Style Selector -->
                    <div class="style-selector" style="margin-top:20px;">
                        <h4>üé® Stil okvirƒçka (vse)</h4>
                        <div class="style-options" id="main-style-options">
                            <div class="style-option selected" data-style="white">
                                <div class="style-preview style-white">Tekst</div>
                                <div class="style-name">Bela + ƒçrna</div>
                            </div>
                            <div class="style-option" data-style="black">
                                <div class="style-preview style-black">Tekst</div>
                                <div class="style-name">ƒårna + bela</div>
                            </div>
                            <div class="style-option" data-style="shadow">
                                <div class="style-preview style-shadow">Tekst</div>
                                <div class="style-name">Samo senca</div>
                            </div>
                            <div class="style-option" data-style="rounded">
                                <div class="style-preview style-rounded">Tekst</div>
                                <div class="style-name">Zaobljeno</div>
                            </div>
                            <div class="style-option" data-style="gradient">
                                <div class="style-preview style-gradient">Tekst</div>
                                <div class="style-name">Gradient</div>
                            </div>
                            <div class="style-option" data-style="outline">
                                <div class="style-preview style-outline">Tekst</div>
                                <div class="style-name">Obroba</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 8. Hook Style Selector -->
                    <div class="style-selector" style="margin-top:15px;">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                            <input type="checkbox" id="use-hook-style" onchange="toggleHookStyle(this.checked)">
                            <h4 style="margin:0;">üéØ Drugaƒçen stil za HOOK</h4>
                        </div>
                        <div class="style-options" id="hook-style-options" style="display:none;">
                            <div class="style-option" data-style="red">
                                <div class="style-preview style-red">Tekst</div>
                                <div class="style-name">üî¥ Rdeƒça</div>
                            </div>
                            <div class="style-option" data-style="orange">
                                <div class="style-preview style-orange">Tekst</div>
                                <div class="style-name">üü† Oran≈æna</div>
                            </div>
                            <div class="style-option" data-style="yellow">
                                <div class="style-preview style-yellow">Tekst</div>
                                <div class="style-name">üü° Rumena</div>
                            </div>
                            <div class="style-option" data-style="fire">
                                <div class="style-preview style-fire">Tekst</div>
                                <div class="style-name">üî• Ogenj</div>
                            </div>
                            <div class="style-option" data-style="neon">
                                <div class="style-preview style-neon">Tekst</div>
                                <div class="style-name">‚ö° Neon</div>
                            </div>
                            <div class="style-option" data-style="explosive">
                                <div class="style-preview style-explosive">Tekst</div>
                                <div class="style-name">üí• Eksplozija</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 9. CTA Style Selector -->
                    <div class="style-selector" style="margin-top:15px;">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                            <input type="checkbox" id="use-cta-style" onchange="toggleCtaStyle(this.checked)">
                            <h4 style="margin:0;">üëÜ Drugaƒçen stil za CTA</h4>
                        </div>
                        <div class="style-options" id="cta-style-options" style="display:none;">
                            <div class="style-option" data-style="red">
                                <div class="style-preview style-red">Tekst</div>
                                <div class="style-name">üî¥ Rdeƒça</div>
                            </div>
                            <div class="style-option" data-style="green">
                                <div class="style-preview style-green">Tekst</div>
                                <div class="style-name">üü¢ Zelena</div>
                            </div>
                            <div class="style-option" data-style="yellow">
                                <div class="style-preview style-yellow">Tekst</div>
                                <div class="style-name">üü° Rumena</div>
                            </div>
                            <div class="style-option" data-style="pulse">
                                <div class="style-preview style-pulse">Tekst</div>
                                <div class="style-name">üíö Pulse</div>
                            </div>
                            <div class="style-option" data-style="urgent">
                                <div class="style-preview style-urgent">Tekst</div>
                                <div class="style-name">üö® Nujno</div>
                            </div>
                            <div class="style-option" data-style="gold">
                                <div class="style-preview style-gold">Tekst</div>
                                <div class="style-name">‚ú® Zlato</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 10. Uppercase Toggle -->
                    <div class="uppercase-control" style="background:#1a1a1a; border-radius:10px; padding:12px 15px; margin-top:15px; display:flex; align-items:center; gap:12px;">
                        <input type="checkbox" id="uppercase-toggle" onchange="toggleUppercase(this.checked)" style="width:18px; height:18px; accent-color:#10b981;">
                        <label for="uppercase-toggle" style="cursor:pointer; font-size:14px;">üî† VSE VELIKE ƒåRKE</label>
                        <span id="uppercase-preview" style="margin-left:auto; font-size:12px; color:#666;">primer ‚Üí PRIMER</span>
                    </div>
                    
                    <!-- Actions -->
                    <div class="actions-bar">
                        <button class="btn btn-secondary" onclick="clearAll()">üóëÔ∏è Poƒçisti</button>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <button class="btn btn-secondary" id="btn-preview" onclick="previewSLO()">üëÅÔ∏è SLO Preview</button>
                            
                            <!-- Country Dropdown -->
                            <div class="country-dropdown" style="position:relative;">
                                <button class="btn btn-secondary" onclick="toggleCountryDropdown(event)" id="btn-countries">üåç Dr≈æave (7)</button>
                                <div id="country-dropdown-menu" style="display:none; position:absolute; bottom:100%; left:0; margin-bottom:5px; background:#1a1a1a; border:1px solid #333; border-radius:8px; padding:10px; min-width:200px; z-index:100; box-shadow: 0 -4px 20px rgba(0,0,0,0.5);">
                                    <div style="display:flex; flex-direction:column; gap:6px;">
                                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:6px 8px; border-radius:4px;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="country-check" value="HR" checked style="width:16px; height:16px;"> üá≠üá∑ Hrva≈°ka
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:6px 8px; border-radius:4px;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="country-check" value="CZ" checked style="width:16px; height:16px;"> üá®üáø ƒåe≈°ka
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:6px 8px; border-radius:4px;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="country-check" value="PL" checked style="width:16px; height:16px;"> üáµüá± Poljska
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:6px 8px; border-radius:4px;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="country-check" value="GR" checked style="width:16px; height:16px;"> üá¨üá∑ Grƒçija
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:6px 8px; border-radius:4px;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="country-check" value="IT" checked style="width:16px; height:16px;"> üáÆüáπ Italija
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:6px 8px; border-radius:4px;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="country-check" value="HU" checked style="width:16px; height:16px;"> üá≠üá∫ Mad≈æarska
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:6px 8px; border-radius:4px;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="country-check" value="SK" checked style="width:16px; height:16px;"> üá∏üá∞ Slova≈°ka
                                        </label>
                                    </div>
                                    <div style="display:flex; gap:8px; margin-top:10px; padding-top:10px; border-top:1px solid #333;">
                                        <button onclick="selectAllCountries(); event.stopPropagation();" class="btn btn-secondary btn-sm" style="flex:1;">‚úÖ Vse</button>
                                        <button onclick="deselectAllCountries(); event.stopPropagation();" class="btn btn-secondary btn-sm" style="flex:1;">‚ùå Nobena</button>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-secondary" onclick="queueAllCreatives()" id="btn-queue" disabled>üåô Dodaj v vrsto</button>
                            <button class="btn btn-primary" onclick="generateAllCreatives()" id="btn-generate" disabled>üöÄ Generiraj</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MODE 2: Localize (Bulk) -->
        <div class="mode-content" id="mode-localize">
            <div class="layout">
                <!-- Left Sidebar: Video Pairs List -->
                <div class="library" id="pairs-sidebar">
                    <h3>üìÅ Video pari</h3>
                    
                    <!-- Bulk Upload Zone -->
                    <div class="upload-zone" id="bulk-upload-zone" style="margin-bottom:15px; padding:20px; min-height:100px;">
                        <div class="icon">üì§</div>
                        <h4>Nalo≈æi videe</h4>
                        <p style="font-size:11px;">ID123_text.mp4 + ID123_clean.mp4</p>
                    </div>
                    <input type="file" id="bulk-file-input" accept="video/*" multiple hidden>
                    
                    <!-- Pairs List -->
                    <div id="pairs-list" style="margin-top:15px;">
                        <div style="color:#666; font-size:13px; text-align:center; padding:20px;">
                            Nalo≈æi videe za zaƒçetek
                        </div>
                    </div>
                    
                    <!-- Analysis Progress Bar (hidden by default) -->
                    <div id="analysis-progress-section" style="display:none; margin-top:15px; padding:15px; background:#1a2a1a; border:1px solid #10b981; border-radius:8px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span style="font-size:13px; font-weight:600;">‚è≥ Analiziram...</span>
                            <span id="analysis-countdown" style="font-size:14px; color:#fbbf24; font-weight:bold;">--:--</span>
                        </div>
                        <div style="background:#333; border-radius:10px; height:8px; overflow:hidden;">
                            <div id="analysis-progress-bar" style="background:linear-gradient(90deg, #10b981, #3b82f6); height:100%; width:0%; transition:width 0.3s;"></div>
                        </div>
                        <div id="analysis-progress-text" style="font-size:11px; color:#888; margin-top:6px; text-align:center;">0 / 0 kreativ</div>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div style="margin-top:15px; padding-top:15px; border-top:1px solid #333;">
                        <button onclick="analyzeAllPairs()" class="btn btn-secondary btn-sm" style="width:100%; margin-bottom:8px;" id="btn-analyze-all" disabled>
                            üîç Analiziraj vse
                        </button>
                        <button onclick="clearAllPairs()" class="btn btn-secondary btn-sm" style="width:100%;">
                            üóëÔ∏è Poƒçisti vse
                        </button>
                    </div>
                </div>
                
                <!-- Right: Edit Panel -->
                <div class="main-area">
                    <!-- Pair Info & Naming -->
                    <div id="pair-edit-panel" style="display:none;">
                        <div class="naming-section" style="background:#1a1a1a; border-radius:10px; padding:15px; margin-bottom:20px;">
                            <h4 style="margin-bottom:12px; font-size:14px; color:#888;">üìù Poimenovanje</h4>
                            <div style="display:grid; grid-template-columns: 100px 120px 130px 130px 80px; gap:10px; align-items:center;">
                                <div>
                                    <label style="font-size:11px; color:#666; display:block; margin-bottom:4px;">ID</label>
                                    <input type="text" id="video-id-2" readonly style="width:100%; padding:8px; background:#0f0f0f; border:1px solid #333; border-radius:6px; color:#10b981; font-size:13px; font-weight:bold;">
                                </div>
                                <div>
                                    <label style="font-size:11px; color:#666; display:block; margin-bottom:4px;">Datum</label>
                                    <input type="text" id="video-date-2" readonly style="width:100%; padding:8px; background:#0f0f0f; border:1px solid #333; border-radius:6px; color:#fff; font-size:13px;">
                                </div>
                                <div>
                                    <label style="font-size:11px; color:#666; display:block; margin-bottom:4px;">Produkt</label>
                                    <select id="video-product-2" onchange="savePairMetadata()" style="width:100%; padding:8px; background:#0f0f0f; border:1px solid #333; border-radius:6px; color:#fff; font-size:13px;">
                                        <option value="BOXERS">BOXERS</option>
                                        <option value="SHIRTS">SHIRTS</option>
                                        <option value="STARTER_PACK">STARTER_PACK</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:11px; color:#666; display:block; margin-bottom:4px;">Tip kreative</label>
                                    <select id="video-type-2" onchange="savePairMetadata()" style="width:100%; padding:8px; background:#0f0f0f; border:1px solid #333; border-radius:6px; color:#fff; font-size:13px;">
                                        <option value="NEW">NEW</option>
                                        <option value="MIX">MIX</option>
                                        <option value="PIRAT">PIRAT</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:11px; color:#666; display:block; margin-bottom:4px;">Avtor</label>
                                    <input type="text" id="video-author-2" placeholder="DD" maxlength="4" onchange="savePairMetadata()" style="width:100%; padding:8px; background:#0f0f0f; border:1px solid #333; border-radius:6px; color:#fff; font-size:13px; text-transform:uppercase;">
                                </div>
                            </div>
                            <div style="margin-top:10px; padding:10px; background:#0f0f0f; border-radius:6px; font-family:monospace; font-size:12px; color:#10b981;">
                                Preview: <span id="name-preview-2">ID_DD-MM-YY_PRODUCT_TYPE_AUTHOR_HR</span>
                            </div>
                        </div>
                        
                        <!-- Status -->
                        <div style="display:flex; gap:15px; margin-bottom:20px;">
                            <div style="flex:1; background:#1a1a1a; border-radius:8px; padding:12px; text-align:center;">
                                <div style="font-size:11px; color:#888;">Video Z tekstom</div>
                                <div id="pair-text-status" style="font-size:13px; margin-top:4px;">-</div>
                            </div>
                            <div style="flex:1; background:#1a1a1a; border-radius:8px; padding:12px; text-align:center;">
                                <div style="font-size:11px; color:#888;">Video BREZ teksta</div>
                                <div id="pair-clean-status" style="font-size:13px; margin-top:4px;">-</div>
                            </div>
                            <div style="flex:1; background:#1a1a1a; border-radius:8px; padding:12px; text-align:center;">
                                <div style="font-size:11px; color:#888;">Analiza</div>
                                <div id="pair-analysis-status" style="font-size:13px; margin-top:4px;">-</div>
                            </div>
                        </div>
                        
                        <!-- Video Preview -->
                        <div id="video-preview-section-2" style="display:none; margin-bottom:20px;">
                            <h4 style="margin-bottom:10px; font-size:14px; color:#888;">üé¨ Video Z tekstom (original)</h4>
                            <video id="video-preview-2" controls style="width:100%; max-height:350px; border-radius:8px; background:#000;"></video>
                        </div>
                        
                        <!-- Analyze Button (single pair) -->
                        <button onclick="analyzeSinglePair()" class="btn btn-secondary" id="btn-analyze-single" style="width:100%; margin-bottom:20px;" disabled>
                            üîç Analiziraj ta video
                        </button>
                        
                        <!-- Detected Texts -->
                        <div class="detected-texts" id="detected-texts" style="display:none;">
                            <h4 style="margin-bottom:15px">üìã Zaznani teksti (originalni jezik)</h4>
                            <div id="texts-list"></div>
                            
                            <!-- Style Selector with labels -->
                            <div style="margin-top:20px; padding-top:20px; border-top:1px solid #333;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                    <h4 style="margin:0;">üé® Stil podnapisa</h4>
                                    <button onclick="applyStyleToAllTexts()" style="padding:6px 12px; background:#10b981; border:none; border-radius:6px; color:#fff; font-size:12px; cursor:pointer;">
                                        ‚úÖ Dodaj na vse sekcije
                                    </button>
                                </div>
                                <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin-bottom:15px;">
                                    <div class="style-box-2" data-style="white" onclick="selectGlobalStyle2('white')" style="cursor:pointer; padding:8px; border:2px solid #10b981; border-radius:6px; text-align:center;">
                                        <div style="background:#fff; color:#000; padding:8px 4px; border-radius:3px; font-weight:bold; font-size:14px;">NORIKS</div>
                                        <div style="font-size:10px; color:#888; margin-top:4px;">‚¨ú Bela</div>
                                    </div>
                                    <div class="style-box-2" data-style="black" onclick="selectGlobalStyle2('black')" style="cursor:pointer; padding:8px; border:2px solid #333; border-radius:6px; text-align:center;">
                                        <div style="background:#000; color:#fff; padding:8px 4px; border-radius:3px; font-weight:bold; font-size:14px; border:1px solid #333;">NORIKS</div>
                                        <div style="font-size:10px; color:#888; margin-top:4px;">‚¨õ ƒårna</div>
                                    </div>
                                    <div class="style-box-2" data-style="red" onclick="selectGlobalStyle2('red')" style="cursor:pointer; padding:8px; border:2px solid #333; border-radius:6px; text-align:center;">
                                        <div style="background:#ef4444; color:#fff; padding:8px 4px; border-radius:3px; font-weight:bold; font-size:14px;">NORIKS</div>
                                        <div style="font-size:10px; color:#888; margin-top:4px;">üî¥ Rdeƒça</div>
                                    </div>
                                    <div class="style-box-2" data-style="yellow" onclick="selectGlobalStyle2('yellow')" style="cursor:pointer; padding:8px; border:2px solid #333; border-radius:6px; text-align:center;">
                                        <div style="background:#eab308; color:#000; padding:8px 4px; border-radius:3px; font-weight:bold; font-size:14px;">NORIKS</div>
                                        <div style="font-size:10px; color:#888; margin-top:4px;">üü° Rumena</div>
                                    </div>
                                    <div class="style-box-2" data-style="green" onclick="selectGlobalStyle2('green')" style="cursor:pointer; padding:8px; border:2px solid #333; border-radius:6px; text-align:center;">
                                        <div style="background:#22c55e; color:#fff; padding:8px 4px; border-radius:3px; font-weight:bold; font-size:14px;">NORIKS</div>
                                        <div style="font-size:10px; color:#888; margin-top:4px;">üü¢ Zelena</div>
                                    </div>
                                    <div class="style-box-2" data-style="fire" onclick="selectGlobalStyle2('fire')" style="cursor:pointer; padding:8px; border:2px solid #333; border-radius:6px; text-align:center;">
                                        <div style="background:linear-gradient(135deg, #ff6600, #ff0000); color:#fff; padding:8px 4px; border-radius:3px; font-weight:bold; font-size:14px;">NORIKS</div>
                                        <div style="font-size:10px; color:#888; margin-top:4px;">üî• Ogenj</div>
                                    </div>
                                    <div class="style-box-2" data-style="neon" onclick="selectGlobalStyle2('neon')" style="cursor:pointer; padding:8px; border:2px solid #333; border-radius:6px; text-align:center;">
                                        <div style="background:#000; color:#0ff; padding:8px 4px; border-radius:3px; font-weight:bold; font-size:14px; text-shadow:0 0 8px #0ff;">NORIKS</div>
                                        <div style="font-size:10px; color:#888; margin-top:4px;">‚ö° Neon</div>
                                    </div>
                                    <div class="style-box-2" data-style="gold" onclick="selectGlobalStyle2('gold')" style="cursor:pointer; padding:8px; border:2px solid #333; border-radius:6px; text-align:center;">
                                        <div style="background:#fbbf24; color:#000; padding:8px 4px; border-radius:3px; font-weight:bold; font-size:14px;">NORIKS</div>
                                        <div style="font-size:10px; color:#888; margin-top:4px;">‚ú® Zlato</div>
                                    </div>
                                </div>
                                <input type="hidden" id="style-select-2" value="white">
                                
                                <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                                    <label style="font-size:12px; color:#888;">Velikost:</label>
                                    <input type="range" id="font-size-2" min="40" max="120" value="105" oninput="updatePreviewMode2()" style="flex:1;">
                                    <span id="font-size-value-2" style="font-size:12px; min-width:45px;">105px</span>
                                </div>
                                <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                                        <input type="checkbox" id="uppercase-2" onchange="toggleUppercase(this.checked)">
                                        <span style="font-size:12px; color:#888;">VSE VELIKE ƒåRKE</span>
                                    </label>
                                </div>
                                
                                <!-- Live Preview 9:16 -->
                                <div style="margin-top:15px; padding-top:15px; border-top:1px solid #333;">
                                    <div style="font-size:12px; color:#888; margin-bottom:8px;">üëÅÔ∏è Preview (kako bo izgledalo):</div>
                                    <div id="texts-preview-container" style="background:#000; border-radius:8px; aspect-ratio:9/16; max-height:450px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; overflow:hidden;">
                                        <div style="color:#666; font-size:13px;">Analiziraj video za preview</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- No pair selected state -->
                    <div id="no-pair-selected" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:300px; color:#666;">
                        <div style="font-size:48px; margin-bottom:15px;">üìÅ</div>
                        <div>Izberi video par iz seznama</div>
                        <div style="font-size:13px; margin-top:5px;">ali nalo≈æi nove videe</div>
                    </div>
                    
                    <!-- Actions Bar -->
                    <div class="actions-bar" style="margin-top:20px;">
                        <div></div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <!-- Country Dropdown Mode 2 -->
                            <div class="country-dropdown" style="position:relative;">
                                <button class="btn btn-secondary" onclick="toggleCountryDropdown2(event)" id="btn-countries-2">üåç Dr≈æave (7)</button>
                                <div id="country-dropdown-menu-2" style="display:none; position:absolute; bottom:100%; left:0; margin-bottom:5px; background:#1a1a1a; border:1px solid #333; border-radius:8px; padding:10px; min-width:200px; z-index:100; box-shadow:0 -4px 20px rgba(0,0,0,0.5);">
                                    <div style="display:flex; flex-direction:column; gap:6px;">
                                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:6px 8px; border-radius:4px;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="country-check-2" value="HR" checked style="width:16px; height:16px;"> üá≠üá∑ HR
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:6px 8px; border-radius:4px;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="country-check-2" value="CZ" checked style="width:16px; height:16px;"> üá®üáø CZ
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:6px 8px; border-radius:4px;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="country-check-2" value="PL" checked style="width:16px; height:16px;"> üáµüá± PL
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:6px 8px; border-radius:4px;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="country-check-2" value="GR" checked style="width:16px; height:16px;"> üá¨üá∑ GR
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:6px 8px; border-radius:4px;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="country-check-2" value="IT" checked style="width:16px; height:16px;"> üáÆüáπ IT
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:6px 8px; border-radius:4px;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="country-check-2" value="HU" checked style="width:16px; height:16px;"> üá≠üá∫ HU
                                        </label>
                                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:6px 8px; border-radius:4px;" onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
                                            <input type="checkbox" class="country-check-2" value="SK" checked style="width:16px; height:16px;"> üá∏üá∞ SK
                                        </label>
                                    </div>
                                    <div style="display:flex; gap:8px; margin-top:10px; padding-top:10px; border-top:1px solid #333;">
                                        <button onclick="selectAllCountries2(); event.stopPropagation();" class="btn btn-secondary btn-sm" style="flex:1;">‚úÖ Vse</button>
                                        <button onclick="deselectAllCountries2(); event.stopPropagation();" class="btn btn-secondary btn-sm" style="flex:1;">‚ùå Nobena</button>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-secondary" onclick="addAllToQueue()" id="btn-queue-all" disabled>üåô Dodaj vse v vrsto</button>
                            <button class="btn btn-primary" onclick="generateAllPairs()" id="btn-generate-all" disabled>üöÄ Generiraj vse</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Night Queue Panel -->
        <div class="queue-panel" id="queue-panel">
            <div class="queue-header">
                <h3>üåô Noƒçna ƒçakalna vrsta</h3>
                <div class="queue-actions">
                    <span id="queue-count">0 v vrsti</span>
                    <button class="btn btn-secondary btn-sm" onclick="refreshQueue()">üîÑ</button>
                    <button class="btn btn-primary btn-sm" onclick="processQueueNow()" id="btn-process-now">‚ñ∂Ô∏è Procesiraj zdaj</button>
                </div>
            </div>
            <div class="queue-list" id="queue-list">
                <div class="empty-state">ƒåakalna vrsta je prazna</div>
            </div>
            <div class="queue-schedule">
                <span>‚è∞ Avtomatsko procesiranje: <strong>02:00</strong></span>
            </div>
        </div>
    </div>
    
    <script>
        // ============ AUTHENTICATION SYSTEM ============
        const VALID_USERS = {
            'david': 'david',
            'grega': 'grega',
            'teja': 'teja'
        };
        
        let currentUser = null;
        
        // Get storage key with user prefix
        function userKey(key) {
            return currentUser ? `${currentUser}_${key}` : key;
        }
        
        // Check if logged in
        function checkAuth() {
            const savedUser = localStorage.getItem('videoLocalizer_currentUser');
            if (savedUser && VALID_USERS[savedUser]) {
                currentUser = savedUser;
                showLoggedIn();
                return true;
            }
            showLoginModal();
            return false;
        }
        
        function showLoginModal() {
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('login-username').focus();
        }
        
        function hideLoginModal() {
            document.getElementById('login-overlay').style.display = 'none';
        }
        
        function showLoggedIn() {
            hideLoginModal();
            document.getElementById('user-badge').style.display = 'flex';
            document.getElementById('user-name').textContent = currentUser.charAt(0).toUpperCase() + currentUser.slice(1);
            document.getElementById('user-avatar').textContent = currentUser.charAt(0).toUpperCase();
        }
        
        function attemptLogin() {
            const username = document.getElementById('login-username').value.trim().toLowerCase();
            const password = document.getElementById('login-password').value;
            
            if (VALID_USERS[username] && VALID_USERS[username] === password) {
                currentUser = username;
                localStorage.setItem('videoLocalizer_currentUser', username);
                showLoggedIn();
                loadUserData();
                document.getElementById('login-error').style.display = 'none';
            } else {
                document.getElementById('login-error').style.display = 'block';
                document.getElementById('login-password').value = '';
            }
        }
        
        function logout() {
            // Save current data before logout
            saveUserData();
            currentUser = null;
            localStorage.removeItem('videoLocalizer_currentUser');
            document.getElementById('user-badge').style.display = 'none';
            showLoginModal();
            // Clear current session data
            creatives = [];
            currentCreativeIndex = -1;
            segments = [];
            renderCreativesList();
            renderTimeline();
        }
        
        // Save user-specific data
        function saveUserData() {
            if (!currentUser) return;
            const data = {
                creatives: creatives,
                textLibrary: textLibrary,
                downloadedItems: downloadedItems
            };
            localStorage.setItem(userKey('sessionData'), JSON.stringify(data));
        }
        
        // Load user-specific data
        function loadUserData() {
            if (!currentUser) return;
            const saved = localStorage.getItem(userKey('sessionData'));
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.creatives && Array.isArray(data.creatives)) {
                        creatives = data.creatives;
                    }
                    if (data.textLibrary) {
                        Object.assign(textLibrary, data.textLibrary);
                    }
                    if (data.downloadedItems) {
                        downloadedItems = data.downloadedItems;
                    }
                    
                    console.log('Loaded user data for:', currentUser, 'creatives:', creatives.length);
                    
                    // Restore UI after a small delay to ensure DOM is ready
                    setTimeout(() => {
                        if (typeof renderLibrary === 'function') renderLibrary();
                        if (typeof renderCreativesList === 'function') renderCreativesList();
                        if (creatives.length > 0 && typeof loadCreative === 'function') {
                            console.log('[loadUserData] Loading creative 0 from localStorage, segments:', creatives[0]?.segments?.length, 'first:', JSON.stringify(creatives[0]?.segments?.[0]));
                            loadCreative(0);
                        }
                    }, 100);
                } catch(e) {
                    console.error('Failed to load user data:', e);
                }
            } else {
                console.log('No saved data for user:', currentUser);
            }
        }
        
        // Auto-save periodically
        setInterval(() => {
            if (currentUser) saveUserData();
        }, 30000); // Every 30 seconds
        
        // Save on page unload
        window.addEventListener('beforeunload', () => {
            if (currentUser) saveUserData();
        });
        
        // Login on Enter key
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') attemptLogin();
            });
            document.getElementById('login-username').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('login-password').focus();
            });
        });
        
        // ============ END AUTHENTICATION ============
        
        // Text Library - organized by product and category
        const textLibrary = {
            tshirt: {
                hook_problem: [
                    "Visi kot vreƒça?",
                    "Spet prekratka majica?",
                    "Preozke v trebuhu?",
                    "Majice ti ne pristajajo?",
                    "Pozabi na prekratke majice.",
                    "Izgledaj 10 kg manj v 2 sekundah",
                    "Konƒçaj sramoto prekratkih majic",
                    "Prekratka majica?",
                    "Se ti majica vedno zavihne ƒçez trebuh?",
                    "Vsako pranje uniƒçi obliko?",
                    "Ima≈° dovolj poceni krojev?",
                    "Izgleda≈° kot v pi≈æami?",
                    "Se tvoja majica vedno prehitro obrabi?",
                    "Se ne poƒçuti≈° samozavestno?",
                    "Se majica po pranju skrƒçi?",
                    "Se v njej preveƒç poti≈°?",
                    "Nobena majica ti ne stoji.",
                    "Se ti majica vedno rola ƒçez trebuh?",
                    "2+1 GRATIS!",
                    "AKCIJA 2+1 GRATIS!",
                    "Te majice prejemajo neverjetno veliko kritik ≈æensk",
                    "Izgleda≈° kot v vreƒçi?",
                    "Se poƒçuti≈° nesamozavestno?",
                    "Ti trebuh gleda ven?",
                    "Ti ≈°ivi re≈æejo v ko≈æo?",
                    "Spoznaj majice NORIKS",
                    "Odkrij NORIKS",
                    "Najmehkej≈°a majica na trgu",
                    "AKCIJA MESECA",
                    "NAJBOLJ≈†A MAJICA 2026",
                    "Ti je znan ta obƒçutek?",
                    "Pozna≈° ta problem?",
                    "Prekratka?"
                ],
                solution_benefit: [
                    "NORIKS majica ki ostane na mestu",
                    "Poudari roke in prsa.",
                    "Samozavest v trenutku.",
                    "Kroj za moƒçnej≈°e mo≈°ke.",
                    "NORIKS: Kroj za prave mo≈°ke",
                    "Skrije trebuh, poudari mi≈°ice",
                    "Vrhunski bomba≈æ, ki dr≈æi obliko",
                    "Material, ki dr≈æi obliko cel dan",
                    "Udobje od jutra do veƒçera.",
                    "Prilagojeno tvoji vi≈°ini in te≈æi",
                    "Tvoja nova najljub≈°a majica",
                    "Kvaliteta, ki jo ƒçuti≈° na ko≈æi",
                    "Narejeno iz premium materiala MODAL",
                    "Majica, ki ti da samozavest",
                    "Material, ki dejansko diha",
                    "ƒåisto udobje ves dan",
                    "Izgledaj fit v 2 sekundah.",
                    "Majica za moƒçnej≈°e mo≈°ke.",
                    "Premium MODAL, ki dr≈æi svojo obliko.",
                    "Majica, ki diha",
                    "Niƒç veƒç neudobnih majic",
                    "Ta majica vam poveƒça roke in prsi",
                    "Skrij svoj trebuh",
                    "Mehke in zraƒçne",
                    "Kroj, ki se ne skrƒçi.",
                    "Material, ki dejansko diha.",
                    "Modal: 2x mehkej≈°i, 3x bolj zraƒçen.",
                    "Mehka, lahka, trpe≈æna",
                    "Poveƒçajte si samozavest",
                    "Udobje skozi celi dan",
                    "Mehka kot druga ko≈æa"
                ],
                trust: [
                    "Zaupa nam 100.000+ mo≈°kih.",
                    "30-dnevno jamstvo za menjavo velikosti",
                    "Izberi si svojo velikost",
                    "Brezplaƒçna zamenjava v 30 dneh",
                    "Najbolje ocenjena majica za moƒçnej≈°e.",
                    "Veƒç tisoƒç ocen s 5 zvezdicami.",
                    "Hitra dostava do tvojih vrat",
                    "Velikost do 4XL",
                    "Najbolje ocenjena majica",
                    "Osve≈æi svoj stil z NORIKS",
                    "Ne zamudite te prilo≈ænosti",
                    "Na voljo v veƒç barvah",
                    "1300 Strank je ocenilo z 5 zvezdicami",
                    "Zaloga je omejena",
                    "Visoko zadovoljstvo kupcev",
                    "Brez skrbi - 30 dni mo≈ænosti vraƒçila"
                ],
                cta: [
                    "‚Äì30 % POPUST!",
                    "Akcija samo danes",
                    "-30% Samo ta teden ‚Äì zaloge kopnijo.",
                    "Klikni spodaj in izberi svojo barvo",
                    "‚Äì30 % POPUST | Samo ta teden!",
                    "Zagotovi si svoj paket zdaj.",
                    "Ne zamudi najveƒçje razprodaje.",
                    "Zaloge kopnijo ‚Äì pohiti!",
                    "Samo ≈°e nekaj kosov na zalogi!",
                    "Zadnja prilo≈ænost za ‚Äì30 %.",
                    "‚Äì20 % popust velja samo do polnoƒçi!",
                    "Vzemi svojo majico, preden poidejo.",
                    "Naroƒçi zdaj in prihrani",
                    "Klikni in naroƒçi takoj.",
                    "Najveƒçji popust sezone",
                    "Samo do konca dneva ‚Äì20 % ceneje!"
                ]
            },
            boxers: {
                hook_problem: [
                    "Te re≈æejo?",
                    "Se ti rolajo?",
                    "Preozke v trebuhu?",
                    "Dovolj potenja in smradu?",
                    "Te drgnejo?",
                    "Se po enem pranju uniƒçijo?",
                    "Te ti≈°ƒçijo?",
                    "So neudobne?",
                    "Neudobno spodnje perilo?",
                    "Vsako pranje uniƒçi obliko?",
                    "Ima≈° dovolj poceni krojev?",
                    "Boksarice, ki ne dihajo?",
                    "2+1 GRATIS!",
                    "AKCIJA 2+1 GRATIS!",
                    "Spoznaj boksarice NORIKS",
                    "Odkrij NORIKS",
                    "Najmehkej≈°e boksarice na trgu",
                    "AKCIJA MESECA",
                    "NAJBOLJ≈†E BOKSARICE 2026",
                    "Ti je znan ta obƒçutek?",
                    "Pozna≈° ta problem?",
                    "Ti je znano to?",
                    "Dra≈æijo ko≈æo?",
                    "Po 2 dneh ≈æe luknja?",
                    "Neudobne?",
                    "Te drgnejo med nogami?",
                    "Hitro smrdijo?"
                ],
                solution_benefit: [
                    "NORIKS: Boksarice, ki ostanejo na mestu.",
                    "Premium Modal: Mehkej≈°e od bomba≈æa",
                    "Samozavest v trenutku.",
                    "Kroj za moƒçnej≈°e mo≈°ke.",
                    "Hladi ko≈æo in prepreƒçuje potenje.",
                    "Mehki kroj, ki ne re≈æe v trebuh.",
                    "Vrhunski bomba≈æ, ki dr≈æi obliko",
                    "Brez neprijetnih ≈°ivov, ki dra≈æijo ko≈æo",
                    "Udobje od jutra do veƒçera.",
                    "Prilagojeno tvoji vi≈°ini in te≈æi",
                    "Prilagojeno za moƒçnej≈°e mo≈°ke",
                    "Kvaliteta, ki jo ƒçuti≈° na ko≈æi",
                    "Narejeno iz premium materiala MODAL",
                    "Vrhunska zraƒçnost skozi cel dan",
                    "Material, ki dejansko diha",
                    "Udobje ves dan",
                    "Boksarice za moƒçnej≈°e mo≈°ke.",
                    "Niƒç veƒç neudobnih boksaric",
                    "Mehke in zraƒçne",
                    "Kroj, ki se ne skrƒçi.",
                    "Modal: 2x mehkej≈°i, 3x bolj zraƒçen.",
                    "Mehke, lahke, trpe≈æne",
                    "Udobje skozi celi dan",
                    "Mehko kot druga ko≈æa",
                    "Narejene za maksimalno udobje",
                    "Cel dan sve≈æe",
                    "Obƒçutek, kot da si brez",
                    "Neuniƒçljive tudi po 100 pranjih.",
                    "Hladi, ko je vroƒçe, greje, ko je hladno.",
                    "Premium obƒçutek",
                    "Ne ƒçuti≈°, da nosi≈°"
                ],
                trust: [
                    "Zaupa nam 100.000+ mo≈°kih.",
                    "30-dnevno jamstvo za menjavo velikosti",
                    "Izberi si svojo velikost",
                    "Brezplaƒçna zamenjava v 30 dneh",
                    "Najbolje ocenjene boksarice za moƒçnej≈°e.",
                    "Veƒç tisoƒç ocen s 5 zvezdicami.",
                    "Hitra dostava do tvojih vrat",
                    "Velikost do 4XL",
                    "Najbolje ocenjene boksarice",
                    "Osve≈æi svoj stil z NORIKS",
                    "Ne zamudite te prilo≈ænosti",
                    "Na voljo v veƒç barvah",
                    "1300 Strank je ocenilo z 5 zvezdicami",
                    "Zaloga je omejena",
                    "Visoko zadovoljstvo kupcev",
                    "Brez skrbi - 30 dni mo≈ænosti vraƒçila",
                    "Najbolj udobne boksarice"
                ],
                cta: [
                    "‚Äì30 % POPUST!",
                    "Akcija samo danes",
                    "-30% Samo ta teden ‚Äì zaloge kopnijo.",
                    "Klikni spodaj in izberi svojo barvo",
                    "‚Äì30 % POPUST | Samo ta teden!",
                    "Zagotovi si svoj paket zdaj.",
                    "Ne zamudi najveƒçje razprodaje.",
                    "Zaloge kopnijo ‚Äì pohiti!",
                    "Samo ≈°e nekaj kosov na zalogi!",
                    "Zadnja prilo≈ænost za ‚Äì30 %.",
                    "‚Äì20 % popust velja samo do polnoƒçi!",
                    "Vzemi svoje boksarice, preden poidejo.",
                    "Naroƒçi zdaj in prihrani",
                    "Klikni in naroƒçi takoj.",
                    "Najveƒçji popust sezone",
                    "Samo do konca dneva ‚Äì20 % ceneje!"
                ]
            }
        };
        
        // Categories for display
        const roleLabels = {
            hook_problem: 'üéØ HOOK + PROBLEM',
            solution_benefit: '‚úÖ RE≈†ITEV + BENEFIT',
            trust: '‚≠ê TRUST',
            cta: 'üëÜ CTA'
        };
        
        const roleColors = { 
            hook_problem: '#a78bfa', 
            solution_benefit: '#34d399', 
            trust: '#60a5fa',
            cta: '#fbbf24' 
        };
        
        // Usage tracking - stored in localStorage
        let textUsageHistory = JSON.parse(localStorage.getItem('textUsageHistory') || '{}');
        
        function trackTextUsage(text) {
            textUsageHistory[text] = (textUsageHistory[text] || 0) + 1;
            localStorage.setItem('textUsageHistory', JSON.stringify(textUsageHistory));
        }
        
        function getTextUsageCount(text) {
            return textUsageHistory[text] || 0;
        }
        
        // Track used texts in current creative
        function getUsedTextsInCurrentCreative() {
            const used = new Set();
            segments.forEach(seg => {
                (seg.texts || []).forEach(t => used.add(t.text));
            });
            return used;
        }
        
        let currentProduct = 'tshirt';
        let currentGender = 'male'; // male = mo≈°ki kupuje, female = ≈æenska kupuje zanj
        let selectedStyle = 'white';
        let hookStyle = 'white'; // Separate style for hooks
        let ctaStyleValue = 'white'; // Separate style for CTA
        let previewStyleType = 'main'; // Which style to preview: main, hook, or cta
        let fontSize = 130;
        let useUppercase = false; // All caps mode
        let segments = [];
        let uploadedFilename = null;
        let videoDuration = 0;
        let isInitialLoad = false; // Flag to track initial video load
        
        // ============ BULK CREATIVES MANAGEMENT ============
        let creatives = []; // Array of creative objects
        let currentCreativeIndex = -1; // Index of currently selected creative
        
        // Creative object structure:
        // { id, filename, originalName, segments, namingParts: {id, date, product, type, author}, style, fontSize, videoUrl }
        
        function saveCurrentCreative() {
            if (currentCreativeIndex < 0 || !creatives[currentCreativeIndex]) return;
            
            const creative = creatives[currentCreativeIndex];
            creative.segments = JSON.parse(JSON.stringify(segments));
            creative.style = selectedStyle;
            creative.fontSize = fontSize;
            creative.uppercase = useUppercase;
            creative.hookStyle = hookStyle;
            creative.ctaStyle = ctaStyleValue;
            creative.useHookStyle = useHookStyle;
            creative.useCtaStyle = useCtaStyle;
            creative.namingParts = {
                id: document.getElementById('video-id').value,
                date: document.getElementById('video-date').value,
                product: document.getElementById('video-product').value,
                type: document.getElementById('video-type').value,
                author: document.getElementById('video-author').value
            };
        }
        
        function loadCreative(index) {
            if (index < 0 || !creatives[index]) return;
            
            // Save current before switching
            saveCurrentCreative();
            
            currentCreativeIndex = index;
            const creative = creatives[index];
            
            console.log('[loadCreative]', index, 'creative.segments:', creative.segments?.length, 'first:', JSON.stringify(creative.segments?.[0]));
            
            // Load creative data
            uploadedFilename = creative.filename;
            segments = JSON.parse(JSON.stringify(creative.segments || []));
            selectedStyle = creative.style || 'white';
            fontSize = creative.fontSize || 105;
            useUppercase = creative.uppercase || false;
            hookStyle = creative.hookStyle || 'white';
            ctaStyleValue = creative.ctaStyle || 'white';
            useHookStyle = creative.useHookStyle || false;
            useCtaStyle = creative.useCtaStyle || false;
            videoDuration = creative.duration || 0;
            
            // Update UI
            document.getElementById('video-id').value = creative.namingParts?.id || '';
            document.getElementById('video-date').value = creative.namingParts?.date || getTodayDate();
            document.getElementById('video-product').value = creative.namingParts?.product || 'BOXERS';
            document.getElementById('video-type').value = creative.namingParts?.type || 'NEW';
            document.getElementById('video-author').value = creative.namingParts?.author || '';
            updateNamePreview();
            
            // Update style selection
            document.querySelectorAll('.style-option').forEach(o => o.classList.remove('selected'));
            document.querySelector(`.style-option[data-style="${selectedStyle}"]`)?.classList.add('selected');
            
            // Update font size
            document.getElementById('font-size').value = fontSize;
            document.getElementById('font-size-value').textContent = fontSize + 'px';
            
            // Update uppercase checkbox
            document.getElementById('uppercase-toggle').checked = useUppercase;
            document.getElementById('uppercase-preview').style.color = useUppercase ? '#10b981' : '#666';
            
            // Update hook style checkbox and selection
            document.getElementById('use-hook-style').checked = useHookStyle;
            document.getElementById('hook-style-options').style.display = useHookStyle ? 'grid' : 'none';
            document.querySelectorAll('#hook-style-options .style-option').forEach(o => o.classList.remove('selected'));
            document.querySelector(`#hook-style-options .style-option[data-style="${hookStyle}"]`)?.classList.add('selected');
            
            // Update CTA style checkbox and selection
            document.getElementById('use-cta-style').checked = useCtaStyle;
            document.getElementById('cta-style-options').style.display = useCtaStyle ? 'grid' : 'none';
            document.querySelectorAll('#cta-style-options .style-option').forEach(o => o.classList.remove('selected'));
            document.querySelector(`#cta-style-options .style-option[data-style="${ctaStyleValue}"]`)?.classList.add('selected');
            
            // Update style preview box
            updateStylePreview();
            
            // Update video preview - show SLO preview if available, otherwise original video
            document.getElementById('preview-section').style.display = 'block';
            if (creative.previewUrl && creative.previewStatus === 'done') {
                document.getElementById('video-preview').src = creative.previewUrl;
                document.getElementById('preview-section').querySelector('h4').textContent = 'üëÅÔ∏è SLO Preview';
            } else {
                document.getElementById('video-preview').src = creative.videoUrl;
                document.getElementById('preview-section').querySelector('h4').textContent = 'üëÅÔ∏è Original';
            }
            
            // Update preview button state
            if (creative.previewStatus === 'generating') {
                document.getElementById('btn-preview').textContent = '‚è≥ V ozadju...';
                document.getElementById('btn-preview').disabled = true;
            } else {
                document.getElementById('btn-preview').textContent = 'üëÅÔ∏è SLO Preview';
                document.getElementById('btn-preview').disabled = false;
            }
            
            // Update upload zone
            document.getElementById('upload-zone').innerHTML = `<div class="icon">‚úÖ</div><h4>${creative.originalName}</h4>`;
            document.getElementById('upload-zone').classList.add('has-file');
            
            // Render timeline
            renderTimeline();
            renderCreativesList();
            checkReady();
        }
        
        function getTodayDate() {
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yy = String(today.getFullYear()).slice(-2);
            return `${dd}-${mm}-${yy}`;
        }
        
        function renderCreativesList() {
            const container = document.getElementById('creatives-list');
            if (creatives.length === 0) {
                container.innerHTML = '<div class="empty-state" style="font-size:13px; color:#666; padding:10px;">Nalo≈æi enega ali veƒç videov</div>';
                document.getElementById('btn-generate').disabled = true;
                return;
            }
            
            container.innerHTML = creatives.map((c, i) => {
                const isActive = i === currentCreativeIndex;
                const hasTexts = c.segments?.some(s => s.texts?.length > 0);
                const isReady = hasTexts && c.namingParts?.id && c.namingParts?.author;
                
                // Preview status indicator
                let statusIcon = '';
                if (c.previewStatus === 'generating') {
                    statusIcon = '<span style="color:#fbbf24; margin-right:6px;">‚è≥</span>';
                } else if (c.previewStatus === 'done') {
                    statusIcon = '<span style="color:#22c55e; margin-right:6px;">üëÅÔ∏è</span>';
                } else if (c.previewStatus === 'error') {
                    statusIcon = '<span style="color:#f87171; margin-right:6px;">‚ùå</span>';
                }
                
                return `
                    <div class="creative-item ${isActive ? 'active' : ''} ${isReady ? 'ready' : ''} ${c.previewStatus === 'generating' ? 'generating' : ''}" onclick="loadCreative(${i})">
                        ${statusIcon}<span>${c.namingParts?.id || c.originalName}</span>
                        <span class="remove-btn" onclick="event.stopPropagation(); removeCreative(${i})">‚úï</span>
                    </div>
                `;
            }).join('');
            
            // Enable queue all if at least one creative is ready
            const anyReady = creatives.some(c => {
                const hasTexts = c.segments?.some(s => s.texts?.length > 0);
                return hasTexts && c.namingParts?.id && c.namingParts?.author;
            });
            document.getElementById('btn-generate').disabled = !anyReady;
        }
        
        function removeCreative(index) {
            creatives.splice(index, 1);
            if (currentCreativeIndex >= creatives.length) {
                currentCreativeIndex = creatives.length - 1;
            }
            if (currentCreativeIndex >= 0) {
                loadCreative(currentCreativeIndex);
            } else {
                // Reset to empty state
                uploadedFilename = null;
                segments = [];
                document.getElementById('preview-section').style.display = 'none';
                document.getElementById('upload-zone').innerHTML = '<div class="icon">üìÅ</div><h4>Nalo≈æi ƒçist video (brez teksta)</h4><p>Povleci sem ali klikni</p>';
                document.getElementById('upload-zone').classList.remove('has-file');
                document.getElementById('video-id').value = '';
                renderTimeline();
            }
            renderCreativesList();
            checkReady();
        }
        
        async function addCreativeFromFile(file) {
            const formData = new FormData();
            formData.append('video', file, file.name);
            
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/launches/api/upload-video', true);
                xhr.onload = async function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        const data = JSON.parse(xhr.responseText);
                        
                        // Get video duration
                        const video = document.createElement('video');
                        video.src = URL.createObjectURL(file);
                        
                        video.onerror = () => {
                            console.error('Video metadata load error for:', file.name);
                            // Use ffprobe duration from server instead
                            reject(new Error('Video metadata load failed for: ' + file.name));
                        };
                        
                        video.onloadedmetadata = async () => {
                            const creative = {
                                id: `creative-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,
                                filename: data.filename,
                                originalName: file.name,
                                videoUrl: URL.createObjectURL(file),
                                duration: video.duration,
                                segments: [],
                                style: 'white',
                                fontSize: 105,
                                namingParts: {
                                    id: extractIdFromFilename(file.name),
                                    date: getTodayDate(),
                                    product: 'BOXERS',
                                    type: 'NEW',
                                    author: ''
                                }
                            };
                            
                            // Auto-detect scene cuts
                            try {
                                console.log('[Mode1] Calling smart-analyze for:', data.filename);
                                const saResp = await fetch('/launches/api/localizer/smart-analyze', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ filename: data.filename })
                                });
                                const analysis = await saResp.json();
                                console.log('[Mode1] smart-analyze result:', analysis.segments?.length, 'segments, first:', JSON.stringify(analysis.segments?.[0]));
                                if (analysis.segments?.length > 0) {
                                    creative.segments = analysis.segments.map(s => ({
                                        start: s.start,
                                        end: s.end,
                                        texts: s.texts || []
                                    }));
                                    creative.duration = analysis.duration || video.duration;
                                    creative._sceneDetected = true;
                                    console.log('[Mode1] ‚úÖ Using', creative.segments.length, 'scene-detected segments. First:', JSON.stringify(creative.segments[0]));
                                } else {
                                    // Fallback: create 2-second segments if no scenes detected
                                    console.warn('[Mode1] ‚ö†Ô∏è No segments from smart-analyze, using 2s fallback');
                                    const dur = video.duration;
                                    creative.segments = [];
                                    for (let t = 0; t < dur; t += 2) {
                                        creative.segments.push({ start: t, end: Math.min(t + 2, dur), texts: [] });
                                    }
                                    creative.duration = dur;
                                }
                            } catch (e) {
                                console.error('[Mode1] ‚ùå Scene detection failed:', e.message, e);
                                // Fallback on error: try fetching segments directly
                                try {
                                    const resp = await fetch('/launches/api/localizer/smart-analyze', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ filename: data.filename })
                                    });
                                    const analysis2 = await resp.json();
                                    if (analysis2.segments?.length > 0) {
                                        creative.segments = analysis2.segments.map(s => ({ start: s.start, end: s.end, texts: [] }));
                                        creative.duration = analysis2.duration || video.duration;
                                        creative._sceneDetected = true;
                                        console.log('[Mode1] ‚úÖ Retry worked:', creative.segments.length, 'segments');
                                    } else {
                                        throw new Error('No segments on retry');
                                    }
                                } catch (e2) {
                                    console.error('[Mode1] ‚ùå Retry also failed:', e2.message);
                                    const dur = video.duration;
                                    creative.segments = [];
                                    for (let t = 0; t < dur; t += 2) {
                                        creative.segments.push({ start: t, end: Math.min(t + 2, dur), texts: [] });
                                    }
                                    creative.duration = dur;
                                }
                            }
                            
                            creatives.push(creative);
                            resolve(creative);
                        };
                    } else {
                        reject(new Error('Upload failed'));
                    }
                };
                xhr.onerror = () => reject(new Error('Network error'));
                xhr.send(formData);
            });
        }
        
        // Bulk upload handler
        document.getElementById('file-input-bulk').addEventListener('change', async function() {
            const files = Array.from(this.files);
            if (files.length === 0) return;
            
            const container = document.getElementById('creatives-list');
            const total = files.length;
            let completed = 0;
            
            function updateProgress() {
                const percent = Math.round((completed / total) * 100);
                container.innerHTML = `
                    <div style="width:100%; padding:10px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <span style="color:#10b981;">‚è≥ Nalagam kreative...</span>
                            <span style="color:#fff; font-weight:600;">${completed}/${total} (${percent}%)</span>
                        </div>
                        <div style="background:#333; border-radius:4px; height:8px; overflow:hidden;">
                            <div style="background:#10b981; height:100%; width:${percent}%; transition:width 0.3s;"></div>
                        </div>
                    </div>
                `;
            }
            
            updateProgress();
            
            for (const file of files) {
                try {
                    await addCreativeFromFile(file);
                    completed++;
                    updateProgress();
                } catch (e) {
                    console.error('Failed to upload:', file.name, e);
                    completed++;
                    updateProgress();
                }
            }
            
            // Select first creative if none selected
            if (currentCreativeIndex < 0 && creatives.length > 0) {
                loadCreative(0);
            } else {
                renderCreativesList();
            }
            
            this.value = ''; // Reset input
        });
        
        // Queue all ready creatives
        // Generate all creatives immediately (not queue for later)
        window.generateAllCreatives = async function() {
            saveCurrentCreative(); // Save current first
            
            const readyCreatives = creatives.filter(c => {
                const hasTexts = c.segments?.some(s => s.texts?.length > 0);
                return hasTexts && c.namingParts?.id && c.namingParts?.author;
            });
            
            if (readyCreatives.length === 0) {
                alert('Nobena kreativa ni pripravljena! Dodaj besedila in izpolni ID + Avtor.');
                return;
            }
            
            document.getElementById('btn-generate').textContent = '‚è≥ 0%';
            document.getElementById('btn-generate').disabled = true;
            
            let started = 0;
            for (const creative of readyCreatives) {
                try {
                    // Flatten segments (with empty segment handling and simultaneous support)
                    const texts = [];
                    let lastTextEntry = null;
                    const creativeUppercase = creative.uppercase || false;
                    const MIN_DUR = 1.0;
                    creative.segments.forEach(seg => {
                        const segTexts = seg.texts || [];
                        if (segTexts.length === 0) {
                            if (lastTextEntry) lastTextEntry.end = seg.end;
                            return;
                        }
                        
                        // Use per-segment style if set, otherwise use creative default style
                        const segStyle = seg.style || creative.style || 'white';
                        
                        if (seg.simultaneous && segTexts.length > 1) {
                            // Simultaneous: all texts visible at same time, stacked vertically
                            let segEnd = seg.end;
                            if (segEnd - seg.start < MIN_DUR) segEnd = seg.start + MIN_DUR;
                            segTexts.forEach((t, i) => {
                                const entry = {
                                    start: seg.start,
                                    end: segEnd,
                                    text: creativeUppercase ? t.text.toUpperCase() : t.text,
                                    role: t.role || 'solution_benefit',
                                    position: i === 0 ? 'center-top' : 'center-bottom',
                                    style: segStyle
                                };
                                texts.push(entry);
                                lastTextEntry = entry;
                            });
                        } else {
                            // Sequential
                            const duration = seg.end - seg.start;
                            const perText = Math.max(duration / segTexts.length, MIN_DUR);
                            segTexts.forEach((t, i) => {
                                const entry = {
                                    start: seg.start + (i * perText),
                                    end: seg.start + ((i + 1) * perText),
                                    text: creativeUppercase ? t.text.toUpperCase() : t.text,
                                    role: t.role || 'solution_benefit',
                                    style: segStyle
                                };
                                texts.push(entry);
                                lastTextEntry = entry;
                            });
                        }
                    });
                    
                    if (texts.length === 0) continue;
                    
                    const { id, date, product, type, author } = creative.namingParts;
                    const name = id + '_' + date + '_' + product + '_' + type + '_' + author;
                    
                    // Get selected countries
                    const selectedCountries = getSelectedCountries();
                    if (selectedCountries.length === 0) {
                        alert('Izberi vsaj eno dr≈æavo!');
                        document.getElementById('btn-generate').textContent = 'üöÄ Generiraj';
                        document.getElementById('btn-generate').disabled = false;
                        return;
                    }
                    
                    // Call generate API (starts in background, doesn't wait to finish)
                    const response = await postJSON('/launches/api/localizer/generate', {
                        videoClean: creative.filename,
                        name: name,
                        namingParts: creative.namingParts,
                        texts: texts,
                        style: creative.style || 'white',
                        fontSize: creative.fontSize || 105,
                        hookStyle: creative.useHookStyle ? (creative.hookStyle || 'white') : null,
                        ctaStyle: creative.useCtaStyle ? (creative.ctaStyle || 'white') : null,
                        countries: selectedCountries,
                        source: 'library',
                        perTextStyles: true,
                        uppercase: creative.uppercase || false
                    });
                    console.log('Started generation for:', name, response);
                    
                    started++;
                    document.getElementById('btn-generate').textContent = `‚è≥ Startal ${started}/${readyCreatives.length}`;
                } catch (e) {
                    console.error('Failed to start:', creative.originalName, e);
                }
            }
            
            // Generation started - user can click Downloads to see progress
            // Don't auto-open panel
            
            // Start countdown timer and polling for progress
            const numCountries = getSelectedCountries().length;
            const totalVideos = started * numCountries;
            const estimatedSecondsPerVideo = 45; // ~45s per video
            let remainingSeconds = totalVideos * estimatedSecondsPerVideo;
            const startTime = Date.now();
            
            // Update countdown every second
            const countdownInterval = setInterval(() => {
                remainingSeconds = Math.max(0, remainingSeconds - 1);
                const mins = Math.floor(remainingSeconds / 60);
                const secs = remainingSeconds % 60;
                const timeStr = `${mins}:${secs.toString().padStart(2, '0')}`;
                document.getElementById('btn-generate').textContent = `‚è≥ ${timeStr}`;
            }, 1000);
            
            const pollProgress = setInterval(async () => {
                try {
                    const data = await getJSON('/launches/api/localizer/jobs');
                    const activeJobs = (data.jobs || []).filter(j => j.status === 'translating' || j.status === 'generating');
                    const doneJobs = (data.jobs || []).filter(j => j.status === 'done');
                    
                    const completedVideos = doneJobs.length * numCountries + activeJobs.reduce((sum, j) => sum + (j.completed || 0), 0);
                    
                    // Recalculate remaining time based on actual progress
                    if (completedVideos > 0) {
                        const elapsed = (Date.now() - startTime) / 1000;
                        const avgTimePerVideo = elapsed / completedVideos;
                        const remaining = totalVideos - completedVideos;
                        remainingSeconds = Math.round(remaining * avgTimePerVideo);
                    }
                    
                    if (activeJobs.length === 0) {
                        clearInterval(pollProgress);
                        clearInterval(countdownInterval);
                        document.getElementById('btn-generate').textContent = '‚úÖ Konƒçano!';
                        setTimeout(() => {
                            document.getElementById('btn-generate').textContent = 'üöÄ Generiraj';
                            document.getElementById('btn-generate').disabled = false;
                        }, 2000);
                    }
                } catch (e) { console.error('Poll error:', e); }
            }, 3000);
            
            // Stop polling after 10 minutes max
            setTimeout(() => {
                clearInterval(pollProgress);
                clearInterval(countdownInterval);
                document.getElementById('btn-generate').textContent = 'üöÄ Generiraj';
                document.getElementById('btn-generate').disabled = false;
            }, 600000);
            
            // Don't clear - keep creatives so user can edit and regenerate
            renderCreativesList();
        };
        
        // Queue all creatives for night processing (2 AM)
        window.queueAllCreatives = async function() {
            saveCurrentCreative();
            
            const readyCreatives = creatives.filter(c => {
                const hasTexts = c.segments?.some(s => s.texts?.length > 0);
                return hasTexts && c.namingParts?.id && c.namingParts?.author;
            });
            
            if (readyCreatives.length === 0) {
                alert('Nobena kreativa ni pripravljena! Dodaj besedila in izpolni ID + Avtor.');
                return;
            }
            
            let added = 0;
            const MIN_DUR = 1.0;
            for (const creative of readyCreatives) {
                try {
                    const texts = [];
                    let lastTextEntry = null;
                    const creativeUppercase = creative.uppercase || false;
                    creative.segments.forEach(seg => {
                        const segTexts = seg.texts || [];
                        if (segTexts.length === 0) {
                            if (lastTextEntry) lastTextEntry.end = seg.end;
                            return;
                        }
                        
                        if (seg.simultaneous && segTexts.length > 1) {
                            // Simultaneous: stacked vertically with spacing
                            let segEnd = seg.end;
                            if (segEnd - seg.start < MIN_DUR) segEnd = seg.start + MIN_DUR;
                            segTexts.forEach((t, i) => {
                                const entry = { 
                                    start: seg.start, 
                                    end: segEnd, 
                                    text: creativeUppercase ? t.text.toUpperCase() : t.text, 
                                    role: t.role || 'solution_benefit',
                                    position: i === 0 ? 'center-top' : 'center-bottom'
                                };
                                texts.push(entry);
                                lastTextEntry = entry;
                            });
                        } else {
                            // Sequential
                            const duration = seg.end - seg.start;
                            const perText = Math.max(duration / segTexts.length, MIN_DUR);
                            segTexts.forEach((t, i) => {
                                const entry = { start: seg.start + (i * perText), end: seg.start + ((i + 1) * perText), text: creativeUppercase ? t.text.toUpperCase() : t.text, role: t.role || 'solution_benefit' };
                                texts.push(entry);
                                lastTextEntry = entry;
                            });
                        }
                    });
                    
                    if (texts.length === 0) continue;
                    
                    const { id, date, product, type, author } = creative.namingParts;
                    const name = id + '_' + date + '_' + product + '_' + type + '_' + author;
                    
                    await postJSON('/launches/api/queue/add', {
                        mode: 'library',
                        name: name,
                        namingParts: creative.namingParts,
                        videoClean: creative.filename,
                        texts: texts,
                        style: creative.style || 'white',
                        fontSize: creative.fontSize || 105,
                        hookStyle: creative.useHookStyle ? (creative.hookStyle || 'white') : null,
                        ctaStyle: creative.useCtaStyle ? (creative.ctaStyle || 'white') : null
                    });
                    added++;
                } catch (e) {
                    console.error('Failed to queue:', creative.originalName, e);
                }
            }
            
            alert('‚úÖ Dodano ' + added + ' kreativ v noƒçno vrsto!\n\nProcesirale se bodo ob 2:00.');
            refreshQueue();
            
            // Clear queued creatives
            creatives = creatives.filter(c => {
                const hasTexts = c.segments?.some(s => s.texts?.length > 0);
                return !(hasTexts && c.namingParts?.id && c.namingParts?.author);
            });
            
            if (creatives.length > 0) {
                loadCreative(0);
            } else {
                currentCreativeIndex = -1;
                uploadedFilename = null;
                segments = [];
                document.getElementById('preview-section').style.display = 'none';
                document.getElementById('upload-zone').innerHTML = '<div class="icon">üìÅ</div><h4>Nalo≈æi ƒçist video (brez teksta)</h4><p>Povleci sem ali klikni</p>';
                document.getElementById('upload-zone').classList.remove('has-file');
                document.getElementById('video-id').value = '';
                renderTimeline();
            }
            renderCreativesList();
        };
        
        // ============ END BULK CREATIVES ============
        
        // Naming convention - init on load
        function initNaming() {
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yy = String(today.getFullYear()).slice(-2);
            document.getElementById('video-date').value = `${dd}-${mm}-${yy}`;
            updateNamePreview();
        }
        
        function updateNamePreview() {
            const id = document.getElementById('video-id')?.value || 'ID';
            const date = document.getElementById('video-date')?.value || 'DD-MM-YY';
            const product = document.getElementById('video-product')?.value || 'PRODUCT';
            const type = document.getElementById('video-type')?.value || 'TYPE';
            const author = document.getElementById('video-author')?.value.toUpperCase() || 'XX';
            
            // Preview shows HR as example, actual country code added during generation
            const preview = `${id}_${date}_HR_${product}_${type}_${author}`;
            const el = document.getElementById('name-preview');
            if (el) el.textContent = preview;
        }
        
        function getVideoName(countryCode) {
            const id = document.getElementById('video-id')?.value || 'ID';
            const date = document.getElementById('video-date')?.value || 'DD-MM-YY';
            const product = document.getElementById('video-product')?.value || 'PRODUCT';
            const type = document.getElementById('video-type')?.value || 'TYPE';
            const author = document.getElementById('video-author')?.value.toUpperCase() || 'XX';
            return `${id}_${date}_${countryCode}_${product}_${type}_${author}`;
        }
        
        function extractIdFromFilename(filename) {
            // Extract "ID" + numbers pattern (e.g., "ID345" from "ID345_boxer_promo.mp4")
            const match = filename.match(/ID\d+/i);
            return match ? match[0].toUpperCase() : '';
        }
        
        // Init naming on load
        setTimeout(initNaming, 100);
        
        // Add event listeners for naming fields
        ['video-id', 'video-product', 'video-type', 'video-author'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', updateNamePreview);
            if (el) el.addEventListener('change', updateNamePreview);
        });
        
        // Mode 2 state - Bulk
        let videoPairs = []; // Array of { id, textFile, cleanFile, textFilename, cleanFilename, texts, analyzed, product, type, author, style, fontSize }
        let currentPairIndex = -1;
        let isAnalyzingBulk = false; // Global flag to prevent parallel analysis
        
        // Persist videoPairs to localStorage
        function saveVideoPairsToStorage() {
            try {
                // Don't save file objects, just metadata
                const toSave = videoPairs.map(p => ({
                    id: p.id,
                    textFilename: p.textFilename,
                    cleanFilename: p.cleanFilename,
                    texts: p.texts,
                    analyzed: p.analyzed,
                    product: p.product,
                    type: p.type,
                    author: p.author,
                    style: p.style,
                    fontSize: p.fontSize,
                    uppercase: p.uppercase
                }));
                localStorage.setItem('videoPairs', JSON.stringify(toSave));
                localStorage.setItem('currentPairIndex', currentPairIndex);
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }
        
        // Load videoPairs from localStorage
        function loadVideoPairsFromStorage() {
            try {
                const saved = localStorage.getItem('videoPairs');
                const savedIndex = localStorage.getItem('currentPairIndex');
                if (saved) {
                    videoPairs = JSON.parse(saved);
                    // Ensure all pairs have proper structure
                    videoPairs = videoPairs.map(p => ({
                        ...p,
                        texts: p.texts || [],
                        analyzed: p.analyzed || false
                    }));
                    currentPairIndex = savedIndex ? parseInt(savedIndex) : -1;
                    console.log('Loaded', videoPairs.length, 'pairs from localStorage');
                    return true;
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
            }
            return false;
        }
        
        // Legacy single video state (kept for compatibility)
        let uploadedTextVideo = null;
        let uploadedCleanVideo = null;
        let detectedTexts = [];
        
        // Mode tabs
        document.querySelectorAll('.mode-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.mode-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`mode-${tab.dataset.mode}`).classList.add('active');
            });
        });
        
        // Style selector - main styles
        document.querySelectorAll('#main-style-options .style-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('#main-style-options .style-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                selectedStyle = opt.dataset.style;
                previewStyleType = 'main';
                // Update all segment style dropdowns to match
                segments.forEach((seg, i) => {
                    seg.style = selectedStyle;
                });
                document.querySelectorAll('.segment-style-select').forEach(sel => {
                    sel.value = selectedStyle;
                });
                updateStylePreview();
            });
        });
        
        // Style selector - hook styles
        document.querySelectorAll('#hook-style-options .style-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('#hook-style-options .style-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                hookStyle = opt.dataset.style;
                previewStyleType = 'hook';
                updateStylePreview();
            });
        });
        
        let useHookStyle = false;
        window.toggleHookStyle = function(enabled) {
            useHookStyle = enabled;
            const hookOptions = document.getElementById('hook-style-options');
            hookOptions.style.display = enabled ? 'grid' : 'none';
            if (enabled && !document.querySelector('#hook-style-options .style-option.selected')) {
                document.querySelector('#hook-style-options .style-option').classList.add('selected');
                hookStyle = document.querySelector('#hook-style-options .style-option').dataset.style;
            }
        };
        
        // CTA style selector (uses ctaStyleValue defined above)
        let useCtaStyle = false;
        
        document.querySelectorAll('#cta-style-options .style-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('#cta-style-options .style-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                ctaStyleValue = opt.dataset.style;
                previewStyleType = 'cta';
                updateStylePreview();
            });
        });
        
        window.toggleCtaStyle = function(enabled) {
            useCtaStyle = enabled;
            const ctaOptions = document.getElementById('cta-style-options');
            ctaOptions.style.display = enabled ? 'grid' : 'none';
            if (enabled && !document.querySelector('#cta-style-options .style-option.selected')) {
                document.querySelector('#cta-style-options .style-option').classList.add('selected');
                ctaStyleValue = document.querySelector('#cta-style-options .style-option').dataset.style;
            }
        };
        
        window.updateFontSize = function(value) {
            fontSize = parseInt(value);
            document.getElementById('font-size-value').textContent = fontSize + 'px';
            updateStylePreview();
        };
        
        window.toggleUppercase = function(enabled) {
            if (enabled === undefined) enabled = document.getElementById('uppercase-toggle')?.checked || document.getElementById('uppercase-2')?.checked || false;
            useUppercase = enabled;
            console.log('[toggleUppercase] useUppercase set to:', useUppercase);
            // Update preview indicator
            const preview = document.getElementById('uppercase-preview');
            if (preview) {
                preview.style.color = enabled ? '#10b981' : '#666';
            }
            // Re-render timeline to show uppercase preview
            renderTimeline();
            updateStylePreview();
        };
        
        window.updateStylePreview = function() {
            const previewEl = document.getElementById('style-preview-text');
            const inputEl = document.getElementById('preview-text-input');
            const previewHeader = document.querySelector('.style-preview-box h4');
            if (!previewEl || !inputEl) return;
            
            let text = inputEl.value || 'NORIKS';
            if (useUppercase) text = text.toUpperCase();
            
            // Determine which style to preview
            let styleToPreview = selectedStyle;
            let headerText = 'üëÅÔ∏è Preview stila';
            if (previewStyleType === 'hook') {
                styleToPreview = hookStyle;
                headerText = 'üéØ Preview HOOK stila';
            } else if (previewStyleType === 'cta') {
                styleToPreview = ctaStyle;
                headerText = 'üëÜ Preview CTA stila';
            }
            if (previewHeader) previewHeader.textContent = headerText;
            
            // Scale font size for preview - calculate exact ratio based on preview vs video width
            const previewContainer = document.getElementById('style-preview-container');
            const previewWidth = previewContainer ? previewContainer.offsetWidth : 225;
            const videoWidth = 1080; // Actual video width in pixels
            const scale = previewWidth / videoWidth;
            const scaledSize = Math.round(fontSize * scale);
            
            // Reset styles - use Noto Sans to match actual video output
            previewEl.style.cssText = `
                font-family: 'Noto Sans', Arial, sans-serif;
                font-weight: bold;
                padding: 10px 20px;
                font-size: ${scaledSize}px;
                line-height: 1.2;
                text-align: center;
                max-width: 90%;
                word-wrap: break-word;
            `;
            
            // Apply style based on styleToPreview
            switch(styleToPreview) {
                case 'white':
                    previewEl.style.background = '#fff';
                    previewEl.style.color = '#000';
                    previewEl.style.borderRadius = '4px';
                    break;
                case 'black':
                    previewEl.style.background = '#000';
                    previewEl.style.color = '#fff';
                    previewEl.style.border = '2px solid #333';
                    previewEl.style.borderRadius = '4px';
                    break;
                case 'shadow':
                    previewEl.style.background = 'transparent';
                    previewEl.style.color = '#fff';
                    previewEl.style.textShadow = '3px 3px 6px rgba(0,0,0,0.9), -1px -1px 3px rgba(0,0,0,0.5)';
                    break;
                case 'rounded':
                    previewEl.style.background = '#fff';
                    previewEl.style.color = '#000';
                    previewEl.style.borderRadius = '30px';
                    previewEl.style.padding = '12px 25px';
                    break;
                case 'gradient':
                    previewEl.style.background = 'linear-gradient(135deg, #10b981, #3b82f6)';
                    previewEl.style.color = '#fff';
                    previewEl.style.borderRadius = '4px';
                    break;
                case 'outline':
                    previewEl.style.background = 'transparent';
                    previewEl.style.color = '#fff';
                    previewEl.style.border = '3px solid #fff';
                    previewEl.style.borderRadius = '4px';
                    break;
                // Explosive styles for Hook/CTA
                case 'red':
                    previewEl.style.background = '#ef4444';
                    previewEl.style.color = '#fff';
                    previewEl.style.borderRadius = '4px';
                    break;
                case 'orange':
                    previewEl.style.background = '#f97316';
                    previewEl.style.color = '#fff';
                    previewEl.style.borderRadius = '4px';
                    break;
                case 'yellow':
                    previewEl.style.background = '#eab308';
                    previewEl.style.color = '#000';
                    previewEl.style.borderRadius = '4px';
                    break;
                case 'fire':
                    previewEl.style.background = 'linear-gradient(135deg, #ef4444, #f97316, #eab308)';
                    previewEl.style.color = '#fff';
                    previewEl.style.borderRadius = '4px';
                    break;
                case 'neon':
                    previewEl.style.background = '#000';
                    previewEl.style.color = '#0ff';
                    previewEl.style.textShadow = '0 0 10px #0ff, 0 0 20px #0ff';
                    previewEl.style.borderRadius = '4px';
                    break;
                case 'explosive':
                    previewEl.style.background = 'linear-gradient(135deg, #dc2626, #7c3aed)';
                    previewEl.style.color = '#fff';
                    previewEl.style.borderRadius = '4px';
                    break;
                case 'green':
                    previewEl.style.background = '#22c55e';
                    previewEl.style.color = '#fff';
                    previewEl.style.borderRadius = '4px';
                    break;
                case 'pulse':
                    previewEl.style.background = 'linear-gradient(135deg, #22c55e, #10b981)';
                    previewEl.style.color = '#fff';
                    previewEl.style.borderRadius = '4px';
                    break;
                case 'urgent':
                    previewEl.style.background = '#dc2626';
                    previewEl.style.color = '#fff';
                    previewEl.style.border = '3px solid #fbbf24';
                    previewEl.style.borderRadius = '4px';
                    break;
                case 'gold':
                    previewEl.style.background = 'linear-gradient(135deg, #fbbf24, #f59e0b)';
                    previewEl.style.color = '#000';
                    previewEl.style.borderRadius = '4px';
                    break;
            }
            
            previewEl.textContent = text;
        };
        
        // Render library with sections and usage tracking
        function renderLibrary() {
            const content = document.getElementById('library-content');
            const library = textLibrary[currentProduct] || {};
            const usedTexts = getUsedTextsInCurrentCreative();
            
            // Categories directly from library
            const categories = {
                hook_problem: library.hook_problem || [],
                solution_benefit: library.solution_benefit || [],
                trust: library.trust || [],
                cta: library.cta || []
            };
            
            content.innerHTML = Object.entries(categories).map(([role, texts]) => `
                <div class="library-section">
                    <h4 onclick="toggleSection(this)" style="color:${roleColors[role]}">
                        ${roleLabels[role]} <span style="font-size:10px">(${texts.length})</span> ‚ñº
                    </h4>
                    <div class="library-items">
                        ${texts.map((text, idx) => {
                            const isUsed = usedTexts.has(text);
                            const usageCount = getTextUsageCount(text);
                            return `
                                <div class="text-item ${isUsed ? 'used' : ''}" draggable="true" data-text="${text}" data-role="${role}" data-index="${idx}"
                                     ondblclick="editLibraryText('${role}', ${idx}, this)"
                                     style="${isUsed ? 'background:#7f1d1d; border-color:#ef4444;' : ''}">
                                    <span class="text-content">${text}</span>
                                    <span style="display:flex; align-items:center; gap:4px;">
                                        ${usageCount > 0 ? `<span style="font-size:10px; color:#888; background:#333; padding:1px 5px; border-radius:10px;">${usageCount}√ó</span>` : ''}
                                        <span class="delete-btn" onclick="deleteLibraryText(event, '${role}', ${idx})">‚úï</span>
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
            
            document.querySelectorAll('.text-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });
        }
        
        function toggleSection(header) {
            const items = header.nextElementSibling;
            items.classList.toggle('collapsed');
            header.querySelector('span:last-child') || (header.innerHTML = header.innerHTML.replace('‚ñº', '‚ñ∂').replace('‚ñ∂', items.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº'));
        }
        
        // Product toggle
        document.querySelectorAll('.product-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.product-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentProduct = btn.dataset.product;
                renderLibrary();
            });
        });
        
        // Drag and drop
        let draggedText = null;
        let draggedRole = null;
        
        function handleDragStart(e) {
            draggedText = e.target.dataset.text;
            draggedRole = e.target.dataset.role;
            e.target.classList.add('dragging');
        }
        
        function handleDragEnd(e) { e.target.classList.remove('dragging'); }
        
        window.handleDragOver = function(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        };
        
        window.handleDragLeave = function(e) {
            e.currentTarget.classList.remove('dragover');
        };
        
        window.handleDrop = function(e, index) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            if (draggedText) {
                // Support multiple texts per segment
                if (!segments[index].texts) segments[index].texts = [];
                segments[index].texts.push({ text: draggedText, role: draggedRole });
                
                // Track usage
                trackTextUsage(draggedText);
                
                renderTimeline();
                renderLibrary(); // Refresh to show used texts in red
                checkReady();
            }
        };
        
        function renderTimeline() {
            const timeline = document.getElementById('timeline');
            if (segments.length === 0) {
                timeline.innerHTML = '<div class="empty-state">Najprej nalo≈æi video</div>';
                return;
            }
            
            // Auto-fix: if segments are uniform 2s but creative has scene-detected segments, use those
            const isUniform2s = segments.length > 2 && segments.every((s, i) => {
                const dur = Math.round((s.end - s.start) * 10) / 10;
                return dur === 2 || (i === segments.length - 1 && dur <= 2);
            });
            if (isUniform2s && currentCreativeIndex >= 0 && creatives[currentCreativeIndex]) {
                const creative = creatives[currentCreativeIndex];
                const creativeHasSceneSegments = creative.segments?.length > 0 && !creative.segments.every((s, i) => {
                    const dur = Math.round((s.end - s.start) * 10) / 10;
                    return dur === 2 || (i === creative.segments.length - 1 && dur <= 2);
                });
                if (creativeHasSceneSegments) {
                    console.log('[renderTimeline] üîÑ Fixing: replacing 2s fallback with scene segments from creative');
                    segments = JSON.parse(JSON.stringify(creative.segments));
                }
            }
            console.log('[renderTimeline] segments:', segments.length, 'first:', JSON.stringify(segments[0]));
            
            const styleOptions = `
                <option value="white">‚¨ú Bela</option>
                <option value="black">‚¨õ ƒårna</option>
                <option value="shadow">üå´Ô∏è Senca</option>
                <option value="rounded">üîò Zaobljeno</option>
                <option value="red">üî¥ Rdeƒça</option>
                <option value="orange">üü† Oran≈æna</option>
                <option value="yellow">üü° Rumena</option>
                <option value="green">üü¢ Zelena</option>
                <option value="neon">‚ö° Neon</option>
            `;
            
            timeline.innerHTML = segments.map((seg, i) => {
                const texts = seg.texts || [];
                const isSimultaneous = seg.simultaneous || false;
                const segStyle = seg.style || selectedStyle || 'white';
                
                const textsHtml = texts.length > 0 
                    ? texts.map((t, ti) => `
                        <div class="text-content" style="background:${roleColors[t.role] || '#10b981'}">
                            ${useUppercase ? t.text.toUpperCase() : t.text}
                            <span class="remove" onclick="removeText(${i}, ${ti})">‚úï</span>
                        </div>
                    `).join('')
                    : '<span class="placeholder">Povleci tekst sem...</span>';
                
                const duration = (seg.end - seg.start).toFixed(1);
                return `
                    <div class="timeline-item">
                        <div class="timeline-time">
                            ${formatTime(seg.start)} - ${formatTime(seg.end)}
                            <div class="duration-control">
                                <button class="dur-btn" onclick="adjustDuration(${i}, -0.5)" title="-0.5s">‚àí</button>
                                <span class="dur-value">${duration}s</span>
                                <button class="dur-btn" onclick="adjustDuration(${i}, 0.5)" title="+0.5s">+</button>
                            </div>
                        </div>
                        <div style="width:80px;height:45px;background:#333;border-radius:4px"></div>
                        <div class="timeline-dropzone ${isSimultaneous ? 'stacked' : ''}" 
                             ondragover="handleDragOver(event)" 
                             ondragleave="handleDragLeave(event)" 
                             ondrop="handleDrop(event, ${i})">
                            ${textsHtml}
                        </div>
                        <div class="segment-options">
                            <select class="segment-style-select" onchange="setSegmentStyle(${i}, this.value)" 
                                    style="padding:4px 6px; background:#0f0f0f; border:1px solid #333; border-radius:4px; color:#fff; font-size:11px;">
                                ${styleOptions.replace(`value="${segStyle}"`, `value="${segStyle}" selected`)}
                            </select>
                            ${texts.length > 1 ? `
                                <label class="simultaneous-toggle" title="Oba teksta vidna hkrati">
                                    <input type="checkbox" ${isSimultaneous ? 'checked' : ''} onchange="toggleSimultaneous(${i}, this.checked)">
                                    <span>Hkrati</span>
                                </label>
                            ` : ''}
                            <button class="btn btn-secondary btn-sm" onclick="removeSegment(${i})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = (sec % 60).toFixed(1);
            return `${m}:${parseFloat(s) < 10 ? '0' : ''}${s}`;
        }
        
        window.removeText = function(segIndex, textIndex) { 
            if (segments[segIndex].texts) {
                segments[segIndex].texts.splice(textIndex, 1);
            }
            renderTimeline();
            renderLibrary(); // Refresh to update used texts highlighting
            checkReady(); 
        };
        
        window.toggleSimultaneous = function(segIndex, checked) {
            segments[segIndex].simultaneous = checked;
            renderTimeline();
        };
        
        window.adjustDuration = function(segIndex, delta) {
            const seg = segments[segIndex];
            const currentDuration = seg.end - seg.start;
            const newDuration = Math.max(0.5, currentDuration + delta); // Min 0.5s
            const change = newDuration - currentDuration;
            
            // Update this segment's end
            seg.end = seg.start + newDuration;
            
            // Shift all following segments
            for (let i = segIndex + 1; i < segments.length; i++) {
                segments[i].start += change;
                segments[i].end += change;
            }
            
            renderTimeline();
            checkReady();
        };
        window.removeSegment = function(i) { segments.splice(i, 1); renderTimeline(); checkReady(); };
        window.setSegmentStyle = function(i, style) {
            if (segments[i]) {
                segments[i].style = style;
            }
        };
        window.addSegment = function() {
            const lastEnd = segments.length > 0 ? segments[segments.length - 1].end : 0;
            if (lastEnd >= videoDuration) { alert('Video prekratek'); return; }
            segments.push({ start: lastEnd, end: Math.min(lastEnd + 2, videoDuration), texts: [] });
            renderTimeline();
        };
        
        // ============ COUNTRY SELECTION FUNCTIONS ============
        
        // Mode 1 country functions
        window.getSelectedCountries = function() {
            const checked = document.querySelectorAll('.country-check:checked');
            return Array.from(checked).map(cb => cb.value);
        };
        
        window.selectAllCountries = function() {
            document.querySelectorAll('.country-check').forEach(cb => cb.checked = true);
            updateCountryCount();
        };
        
        window.deselectAllCountries = function() {
            document.querySelectorAll('.country-check').forEach(cb => cb.checked = false);
            updateCountryCount();
        };
        
        window.updateCountryCount = function() {
            const count = getSelectedCountries().length;
            document.getElementById('btn-countries').textContent = `üåç Dr≈æave (${count})`;
        };
        
        window.toggleCountryDropdown = function(e) {
            e && e.stopPropagation();
            const menu = document.getElementById('country-dropdown-menu');
            const menu2 = document.getElementById('country-dropdown-menu-2');
            if (menu2) menu2.style.display = 'none';
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        };
        
        // Mode 2 country functions
        window.getSelectedCountries2 = function() {
            const checked = document.querySelectorAll('.country-check-2:checked');
            return Array.from(checked).map(cb => cb.value);
        };
        
        window.selectAllCountries2 = function() {
            document.querySelectorAll('.country-check-2').forEach(cb => cb.checked = true);
            updateCountryCount2();
        };
        
        window.deselectAllCountries2 = function() {
            document.querySelectorAll('.country-check-2').forEach(cb => cb.checked = false);
            updateCountryCount2();
        };
        
        window.updateCountryCount2 = function() {
            const count = getSelectedCountries2().length;
            document.getElementById('btn-countries-2').textContent = `üåç Dr≈æave (${count})`;
        };
        
        window.toggleCountryDropdown2 = function(e) {
            e && e.stopPropagation();
            const menu = document.getElementById('country-dropdown-menu');
            const menu2 = document.getElementById('country-dropdown-menu-2');
            if (menu) menu.style.display = 'none';
            menu2.style.display = menu2.style.display === 'none' ? 'block' : 'none';
        };
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.country-dropdown')) {
                const menu = document.getElementById('country-dropdown-menu');
                const menu2 = document.getElementById('country-dropdown-menu-2');
                if (menu) menu.style.display = 'none';
                if (menu2) menu2.style.display = 'none';
            }
        });
        
        // Add event listeners for checkbox changes (defer to avoid timing issues)
        setTimeout(() => {
            document.querySelectorAll('.country-check').forEach(cb => {
                cb.addEventListener('change', updateCountryCount);
            });
            document.querySelectorAll('.country-check-2').forEach(cb => {
                cb.addEventListener('change', updateCountryCount2);
            });
        }, 100);
        
        // ============ END COUNTRY SELECTION ============
        
        window.clearAll = function() { 
            if (confirm('Pobri≈°i vse kreative in tekste na timeline?')) { 
                // Clear all creatives
                creatives = [];
                currentCreativeIndex = -1;
                
                // Clear current session
                segments = [];
                uploadedFilename = null;
                videoDuration = 0;
                
                // Reset styles to defaults
                selectedStyle = 'white';
                hookStyle = 'white';
                ctaStyleValue = 'white';
                useHookStyle = false;
                useCtaStyle = false;
                fontSize = 130;
                useUppercase = false;
                
                // Reset style UI
                document.querySelectorAll('#main-style-options .style-option').forEach(o => o.classList.remove('selected'));
                document.querySelector('#main-style-options .style-option[data-style="white"]')?.classList.add('selected');
                document.querySelectorAll('#hook-style-options .style-option').forEach(o => o.classList.remove('selected'));
                document.querySelectorAll('#cta-style-options .style-option').forEach(o => o.classList.remove('selected'));
                document.getElementById('use-hook-style').checked = false;
                document.getElementById('use-cta-style').checked = false;
                document.getElementById('hook-style-options').style.display = 'none';
                document.getElementById('cta-style-options').style.display = 'none';
                
                // Reset font size
                document.getElementById('font-size').value = 105;
                document.getElementById('font-size-value').textContent = '105px';
                
                // Reset uppercase
                document.getElementById('uppercase-toggle').checked = false;
                document.getElementById('uppercase-preview').style.color = '#666';
                
                // Reset UI
                document.getElementById('preview-section').style.display = 'none';
                document.getElementById('upload-zone').innerHTML = '<div class="icon">üìÅ</div><h4>Nalo≈æi ƒçist video (brez teksta)</h4><p>Povleci sem ali klikni</p>';
                document.getElementById('upload-zone').classList.remove('has-file');
                document.getElementById('video-id').value = '';
                document.getElementById('video-author').value = '';
                
                // Update style preview
                updateStylePreview();
                
                // Re-render
                renderTimeline();
                renderCreativesList();
                checkReady();
                
                // Save cleared state
                if (currentUser) saveUserData();
            } 
        };
        
        window.addCustomText = function() {
            const input = document.getElementById('custom-text');
            const category = document.getElementById('custom-category').value;
            const text = input.value.trim();
            if (text) { 
                if (!textLibrary[currentProduct][category]) textLibrary[currentProduct][category] = [];
                textLibrary[currentProduct][category].push(text); 
                input.value = ''; 
                renderLibrary(); 
            }
        };
        
        // Edit text in library (double-click to edit, ‚úï to delete)
        window.editLibraryText = function(role, index, element) {
            // Skip if already editing
            if (element.querySelector('input')) return;
            const currentText = textLibrary[currentProduct][role][index];
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.style.cssText = 'width:100%; padding:6px; background:#1a1a1a; border:2px solid #10b981; border-radius:4px; color:#fff; font-size:13px;';
            
            const saveEdit = () => {
                const newText = input.value.trim();
                if (newText && newText !== currentText) {
                    textLibrary[currentProduct][role][index] = newText;
                }
                renderLibrary();
            };
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); saveEdit(); }
                if (e.key === 'Escape') { renderLibrary(); }
            });
            
            element.innerHTML = '';
            element.appendChild(input);
            element.draggable = false;
            input.focus();
            input.select();
        };
        
        // Delete text from library
        window.deleteLibraryText = function(e, role, index) {
            e.stopPropagation();
            if (confirm('Izbri≈°i ta tekst?')) {
                textLibrary[currentProduct][role].splice(index, 1);
                renderLibrary();
            }
        };
        
        // File upload - Mode 1
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        const videoPreview = document.getElementById('video-preview');
        
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.style.borderColor = '#10b981'; });
        uploadZone.addEventListener('dragleave', () => uploadZone.style.borderColor = '#444');
        uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.style.borderColor = '#444'; if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', () => { if (fileInput.files.length) handleFile(fileInput.files[0]); });
        
        // Only create segments on initial video upload, not preview playback
        videoPreview.addEventListener('loadedmetadata', () => {
            if (isInitialLoad) {
                videoDuration = videoPreview.duration;
                segments = [];
                for (let t = 0; t < videoDuration; t += 2) {
                    segments.push({ start: t, end: Math.min(t + 2, videoDuration), texts: [] });
                }
                renderTimeline();
                isInitialLoad = false; // Reset flag
            }
        });
        
        async function handleFile(file) {
            uploadZone.innerHTML = '<div class="icon">‚è≥</div><h4>Nalagam...</h4>';
            
            isInitialLoad = true;
            
            try {
                console.log('[handleFile] Starting upload for:', file.name);
                // Add to creatives list (addCreativeFromFile already pushes to array)
                const creative = await addCreativeFromFile(file);
                console.log('[handleFile] Creative ready. segments:', creative.segments?.length, 'first segment:', JSON.stringify(creative.segments?.[0]));
                
                console.log('Creative added:', creative);
                console.log('Creatives array length:', creatives.length);
                
                // Load this creative (it's the last one added)
                const newIndex = creatives.length - 1;
                loadCreative(newIndex);
                
                // Verify segments are loaded correctly
                console.log('[Mode1] After loadCreative: segments.length =', segments.length, 'creative.segments.length =', creatives[newIndex]?.segments?.length);
                
                // Show preview
                document.getElementById('preview-section').style.display = 'block';
                document.getElementById('video-preview').src = creative.videoUrl;
                uploadZone.innerHTML = `<div class="icon">‚úÖ</div><h4>${file.name}</h4><p>${segments.length} kadrov</p>`;
                uploadZone.classList.add('has-file');
                
                renderTimeline();
                checkReady();
                
            } catch (e) {
                console.error('Upload failed:', e);
                uploadZone.innerHTML = '<div class="icon">‚ùå</div><h4>Napaka</h4>';
            }
        }
        
        function checkReady() {
            const id = document.getElementById('video-id').value.trim();
            const author = document.getElementById('video-author').value.trim();
            // At least one segment with at least one text
            const hasAnyText = segments.length > 0 && segments.some(s => s.texts && s.texts.length > 0);
            
            // Preview only needs video + text
            const previewReady = uploadedFilename && hasAnyText;
            // Generate/Queue also needs ID + Author
            const generateReady = previewReady && id && author;
            
            document.getElementById('btn-preview').disabled = !previewReady;
            document.getElementById('btn-generate').disabled = !generateReady;
            document.getElementById('btn-queue').disabled = !generateReady;
            
            // Save current creative state and update list
            saveCurrentCreative();
            renderCreativesList();
        }
        
        // Listen to naming field changes
        ['video-id', 'video-author', 'video-product', 'video-type'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', checkReady);
                el.addEventListener('change', checkReady);
            }
        });
        
        // Preview button onclick is in HTML
        
        // XHR helpers
        function postJSON(url, data) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', url, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.onload = () => xhr.status >= 200 && xhr.status < 300 ? resolve(JSON.parse(xhr.responseText)) : reject(new Error('Server: ' + xhr.status));
                xhr.onerror = () => reject(new Error('Network error'));
                xhr.send(JSON.stringify(data));
            });
        }
        
        function getJSON(url) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', url, true);
                xhr.onload = () => xhr.status >= 200 && xhr.status < 300 ? resolve(JSON.parse(xhr.responseText)) : reject(new Error('Server: ' + xhr.status));
                xhr.onerror = () => reject(new Error('Network error'));
                xhr.send();
            });
        }
        
        // Flatten segments with multiple texts into individual text entries
        // Empty segments: extend previous text to cover that time
        // Merge consecutive segments with same text into one
        // Minimum text duration: 1 second
        const MIN_TEXT_DURATION = 1.0;
        
        function flattenTexts() {
            const result = [];
            let lastTextEntry = null;
            // Always read checkbox state directly to avoid sync issues
            const ucCheckbox = document.getElementById('uppercase-toggle');
            if (ucCheckbox) useUppercase = ucCheckbox.checked;
            console.log('[flattenTexts] useUppercase=', useUppercase);
            
            segments.forEach(seg => {
                const segTexts = seg.texts || [];
                const segStyle = seg.style; // per-segment style from dropdown
                
                // If segment is empty, extend the last text to cover this segment
                if (segTexts.length === 0) {
                    if (lastTextEntry) {
                        lastTextEntry.end = seg.end;
                    }
                    return;
                }
                
                if (seg.simultaneous && segTexts.length > 1) {
                    // Simultaneous: all texts visible at same time, stacked in CENTER
                    // Ensure minimum duration
                    let segEnd = seg.end;
                    if (segEnd - seg.start < MIN_TEXT_DURATION) {
                        segEnd = seg.start + MIN_TEXT_DURATION;
                    }
                    segTexts.forEach((t, i) => {
                        const entry = {
                            start: seg.start,
                            end: segEnd,
                            text: useUppercase ? t.text.toUpperCase() : t.text,
                            position: i === 0 ? 'center-top' : 'center-bottom',
                            role: t.role || 'solution_benefit',
                            style: t.style || segStyle
                        };
                        result.push(entry);
                        lastTextEntry = entry;
                    });
                } else {
                    // Sequential: split segment time equally among texts
                    const duration = seg.end - seg.start;
                    const perText = Math.max(duration / segTexts.length, MIN_TEXT_DURATION);
                    
                    segTexts.forEach((t, i) => {
                        const entry = {
                            start: seg.start + (i * perText),
                            end: seg.start + ((i + 1) * perText),
                            text: useUppercase ? t.text.toUpperCase() : t.text,
                            role: t.role || 'solution_benefit',
                            style: t.style || segStyle
                        };
                        result.push(entry);
                        lastTextEntry = entry;
                    });
                }
            });
            
            // Merge consecutive entries with same text (and same role)
            const merged = [];
            result.forEach(entry => {
                const last = merged[merged.length - 1];
                // If same text, same role, and consecutive (end of last = start of this, with small tolerance)
                if (last && last.text === entry.text && last.role === entry.role && Math.abs(last.end - entry.start) < 0.1) {
                    // Extend the previous entry
                    last.end = entry.end;
                } else {
                    merged.push({ ...entry });
                }
            });
            
            // Ensure minimum duration for all entries
            merged.forEach(entry => {
                if (entry.end - entry.start < MIN_TEXT_DURATION) {
                    entry.end = entry.start + MIN_TEXT_DURATION;
                }
            });
            
            return merged;
        }
        
        window.previewSLO = async function() {
            // Save current creative first
            saveCurrentCreative();
            
            const creativeIndex = currentCreativeIndex;
            const creative = creatives[creativeIndex];
            const videoFile = creative?.filename || uploadedFilename;
            
            if (!videoFile) {
                alert('Najprej nalo≈æi video!');
                return;
            }
            
            const name = getVideoName('SLO');
            const texts = flattenTexts();
            
            if (!texts || texts.length === 0) {
                alert('Dodaj vsaj en tekst na timeline!');
                return;
            }
            
            // Mark creative as generating (if exists)
            if (creative) {
                creative.previewStatus = 'generating';
                renderCreativesList();
            }
            
            document.getElementById('btn-preview').textContent = '‚è≥ 0%';
            document.getElementById('btn-preview').disabled = true;
            
            // Animate progress during generation
            let fakeProgress = 0;
            const progressInterval = setInterval(() => {
                fakeProgress = Math.min(fakeProgress + Math.random() * 15, 90);
                document.getElementById('btn-preview').textContent = '‚è≥ ' + Math.round(fakeProgress) + '%';
            }, 500);
            
            // Generate preview
            try {
                console.log('Sending preview with style:', selectedStyle, 'fontSize:', fontSize, 'hookStyle:', hookStyle, 'ctaStyle:', ctaStyleValue);
                const data = await postJSON('/launches/api/localizer/preview', {
                    videoClean: videoFile, name, texts, language: 'SLO', style: selectedStyle, fontSize,
                    hookStyle: useHookStyle ? hookStyle : null,
                    ctaStyle: useCtaStyle ? ctaStyleValue : null
                });
                console.log('Preview response:', data);
                
                clearInterval(progressInterval);
                document.getElementById('btn-preview').textContent = '‚úÖ 100%';
                
                if (data.error) throw new Error(data.error);
                
                // Save preview URL to creative (if exists)
                if (creative) {
                    creative.previewUrl = data.videoUrl;
                    creative.previewStatus = 'done';
                    renderCreativesList();
                }
                
                // Show preview with cache buster
                document.getElementById('preview-section').style.display = 'block';
                document.getElementById('preview-section').querySelector('h4').textContent = 'üëÅÔ∏è SLO Preview';
                videoPreview.src = data.videoUrl + '?t=' + Date.now();
                videoPreview.load();
                videoPreview.play();
                
            } catch(e) {
                clearInterval(progressInterval);
                console.error('Preview error:', e);
                if (creative) {
                    creative.previewStatus = 'error';
                    renderCreativesList();
                }
                alert('Napaka: ' + e.message);
            }
            
            setTimeout(() => {
                document.getElementById('btn-preview').textContent = 'üëÅÔ∏è SLO Preview';
                document.getElementById('btn-preview').disabled = false;
            }, 1000);
        };
        
        window.generateAll = async function() {
            // Build naming parts
            const id = document.getElementById('video-id').value.trim();
            const date = document.getElementById('video-date').value;
            const product = document.getElementById('video-product').value;
            const type = document.getElementById('video-type').value;
            const author = document.getElementById('video-author').value.toUpperCase();
            
            // Base name without country code: ID_DATE_PRODUCT_TYPE_AUTHOR
            // Country code will be inserted by server between DATE and PRODUCT
            const namingParts = { id, date, product, type, author };
            const name = `${id}_${date}_${product}_${type}_${author}`; // fallback display name
            
            console.log('Segments before flatten:', JSON.stringify(segments));
            const texts = flattenTexts();
            console.log('Texts after flatten:', JSON.stringify(texts));
            
            if (texts.length === 0) {
                alert('Napaka: Ni tekstov! Dodaj tekste na timeline.');
                return;
            }
            
            document.getElementById('btn-generate').textContent = '‚è≥ Generiram...';
            document.getElementById('btn-generate').disabled = true;
            
            try {
                const data = await postJSON('/launches/api/localizer/generate', {
                    videoClean: uploadedFilename, name, texts, style: selectedStyle, fontSize, namingParts
                });
                if (data.error) throw new Error(data.error);
                
                while (true) {
                    const job = await getJSON(`/launches/api/localizer/job/${data.jobId}`);
                    if (job.status === 'done') {
                        alert('‚úÖ Konƒçano! 7 videov pripravljenih.');
                        window.location.href = `/launches/api/localizer/job/${data.jobId}/zip`;
                        break;
                    } else if (job.status === 'error') { throw new Error(job.error); }
                    const pct = Math.round(((job.completed || 0) / 7) * 100);
                    document.getElementById('btn-generate').textContent = `‚è≥ ${job.completed || 0}/7 (${pct}%)`;
                    await new Promise(r => setTimeout(r, 2000));
                }
            } catch(e) { alert('Napaka: ' + e.message); }
            
            document.getElementById('btn-generate').textContent = 'üöÄ Generiraj 7 dr≈æav';
            document.getElementById('btn-generate').disabled = false;
        };
        
        // === MODE 2: Bulk Localize ===
        const bulkUploadZone = document.getElementById('bulk-upload-zone');
        const bulkFileInput = document.getElementById('bulk-file-input');
        
        if (bulkUploadZone && bulkFileInput) {
            bulkUploadZone.addEventListener('click', () => bulkFileInput.click());
            
            bulkUploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                bulkUploadZone.style.borderColor = '#10b981';
                bulkUploadZone.style.background = '#1a2f1a';
            });
            
            bulkUploadZone.addEventListener('dragleave', () => {
                bulkUploadZone.style.borderColor = '#333';
                bulkUploadZone.style.background = '';
            });
            
            bulkUploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                bulkUploadZone.style.borderColor = '#333';
                bulkUploadZone.style.background = '';
                handleBulkFiles(e.dataTransfer.files);
            });
            
            bulkFileInput.addEventListener('change', () => {
                if (bulkFileInput.files.length) handleBulkFiles(bulkFileInput.files);
            });
        }
        
        // Extract ID from filename (e.g., "ID333_text.mp4" -> "ID333")
        function extractIdFromFilename(filename) {
            // Match ID at start or after underscore
            const match = filename.match(/^(ID\d+)/i) || filename.match(/(ID\d+)/i);
            return match ? match[1].toUpperCase() : null;
        }
        
        // Determine if file is "text" or "clean" version
        function getFileType(filename) {
            const lower = filename.toLowerCase();
            // "without" = brez teksta = clean video
            if (lower.includes('without') || lower.includes('clean') || lower.includes('brez') || lower.includes('_c.') || lower.includes('_c_')) {
                return 'clean';
            }
            return 'text'; // Default to text if not explicitly clean
        }
        
        // Handle bulk file upload
        async function handleBulkFiles(files) {
            bulkUploadZone.innerHTML = '<div class="icon">‚è≥</div><h4>Nalagam...</h4>';
            
            // Upload all files first
            const uploadedFiles = [];
            for (const file of files) {
                if (!file.type.startsWith('video/')) continue;
                
                const formData = new FormData();
                formData.append('video', file, file.name);
                
                try {
                    const response = await fetch('/launches/api/upload-video', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    uploadedFiles.push({
                        originalName: file.name,
                        serverName: data.filename,
                        id: extractIdFromFilename(file.name),
                        type: getFileType(file.name)
                    });
                } catch (e) {
                    console.error('Upload failed:', file.name, e);
                }
            }
            
            // Group by ID and create pairs
            const pairMap = new Map();
            uploadedFiles.forEach(f => {
                if (!f.id) return;
                if (!pairMap.has(f.id)) {
                    pairMap.set(f.id, { id: f.id, textFilename: null, cleanFilename: null, texts: [], analyzed: false, product: 'BOXERS', type: 'NEW', author: '', style: 'white', fontSize: 105 });
                }
                const pair = pairMap.get(f.id);
                if (f.type === 'text') pair.textFilename = f.serverName;
                else pair.cleanFilename = f.serverName;
            });
            
            // Add to videoPairs array
            pairMap.forEach(pair => {
                // Check if already exists
                const existing = videoPairs.find(p => p.id === pair.id);
                if (existing) {
                    if (pair.textFilename) existing.textFilename = pair.textFilename;
                    if (pair.cleanFilename) existing.cleanFilename = pair.cleanFilename;
                } else {
                    videoPairs.push(pair);
                }
            });
            
            // Reset upload zone
            bulkUploadZone.innerHTML = '<div class="icon">üì§</div><h4>Nalo≈æi videe</h4><p style="font-size:11px;">ID123_text.mp4 + ID123_clean.mp4</p>';
            
            renderPairsList();
            updateBulkButtons();
            
            // Select first pair if none selected
            if (currentPairIndex < 0 && videoPairs.length > 0) {
                selectPair(0);
            }
            
            // AUTO-START: Analyze only COMPLETE pairs (have both text AND clean video)
            const toAnalyze = videoPairs.filter(p => p.textFilename && p.cleanFilename && !p.analyzed);
            if (toAnalyze.length > 0) {
                console.log(`Auto-starting analysis for ${toAnalyze.length} complete pairs...`);
                // Small delay to let UI update first
                setTimeout(() => analyzeAllPairs(), 500);
            }
        }
        
        // Render pairs list
        function renderPairsList() {
            const container = document.getElementById('pairs-list');
            if (!container) return;
            
            // Save to localStorage whenever list changes
            saveVideoPairsToStorage();
            
            if (videoPairs.length === 0) {
                container.innerHTML = '<div style="color:#666; font-size:13px; text-align:center; padding:20px;">Nalo≈æi videe za zaƒçetek</div>';
                return;
            }
            
            container.innerHTML = videoPairs.map((pair, idx) => {
                const isSelected = idx === currentPairIndex;
                const hasText = !!pair.textFilename;
                const hasClean = !!pair.cleanFilename;
                const isComplete = hasText && hasClean;
                const isAnalyzed = pair.analyzed && (pair.texts?.length || 0) > 0;
                const isReady = isComplete && isAnalyzed && pair.author;
                const isAnalyzing = pair.analyzing; // Currently being analyzed
                
                const statusIcon = isAnalyzing ? '‚è≥' : isReady ? '‚úÖ' : isAnalyzed ? 'üìù' : isComplete ? 'üîç' : '‚ö†Ô∏è';
                const borderColor = isAnalyzing ? '#fbbf24' : isSelected ? '#10b981' : '#333';
                const bg = isSelected ? '#1a2f1a' : '#0f0f0f';
                
                return `
                    <div onclick="selectPair(${idx})" style="background:${bg}; border:1px solid ${borderColor}; border-radius:8px; padding:10px; margin-bottom:8px; cursor:pointer; position:relative; ${isAnalyzing ? 'animation: pulse 1.5s infinite;' : ''}">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <strong style="color:#10b981;">${pair.id || 'Neznano'}</strong>
                            <div style="display:flex; align-items:center; gap:6px;">
                                <span style="font-size:12px;">${statusIcon}</span>
                                <span onclick="event.stopPropagation(); removePair(${idx})" style="color:#f87171; cursor:pointer; font-size:14px; padding:2px 4px; opacity:0.6;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.6" title="Odstrani par">‚úï</span>
                            </div>
                        </div>
                        <div style="font-size:11px; color:#666; margin-top:4px;">
                            ${hasText ? 'üìù' : '‚ùå'} text ${hasClean ? 'üé¨' : '‚ùå'} clean
                        </div>
                        ${pair.author ? `<div style="font-size:10px; color:#888; margin-top:2px;">${pair.product} ¬∑ ${pair.author}</div>` : ''}
                        ${isAnalyzing ? `<div style="font-size:10px; color:#fbbf24; margin-top:4px;">‚è≥ Analiziram...</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Remove a single pair
        window.removePair = function(index) {
            if (index < 0 || index >= videoPairs.length) return;
            
            videoPairs.splice(index, 1);
            
            // Adjust current index if needed
            if (currentPairIndex >= videoPairs.length) {
                currentPairIndex = videoPairs.length - 1;
            }
            
            // If removed currently selected pair, select another or show empty state
            if (videoPairs.length === 0) {
                currentPairIndex = -1;
                detectedTexts = [];
                document.getElementById('pair-edit-panel').style.display = 'none';
                document.getElementById('no-pair-selected').style.display = 'flex';
            } else if (currentPairIndex >= 0) {
                selectPair(currentPairIndex);
            }
            
            renderPairsList();
            updateBulkButtons();
        };
        
        // Select a pair for editing
        window.selectPair = function(index) {
            // Save current pair first
            if (currentPairIndex >= 0) savePairMetadata();
            
            currentPairIndex = index;
            const pair = videoPairs[index];
            if (!pair) return;
            
            // Show edit panel, hide empty state
            document.getElementById('pair-edit-panel').style.display = 'block';
            document.getElementById('no-pair-selected').style.display = 'none';
            
            // Load pair data into form
            document.getElementById('video-id-2').value = pair.id;
            document.getElementById('video-date-2').value = new Date().toLocaleDateString('sl-SI', { day: '2-digit', month: '2-digit', year: '2-digit' }).replace(/\. /g, '-').replace('.', '');
            document.getElementById('video-product-2').value = pair.product || 'BOXERS';
            document.getElementById('video-type-2').value = pair.type || 'NEW';
            document.getElementById('video-author-2').value = pair.author || '';
            document.getElementById('font-size-2').value = pair.fontSize || 105;
            document.getElementById('font-size-value-2').textContent = (pair.fontSize || 105) + 'px';
            document.getElementById('style-select-2').value = pair.style || 'white';
            document.getElementById('uppercase-2').checked = pair.uppercase || false;
            
            // Update style selector visual
            document.querySelectorAll('.style-box-2').forEach(box => {
                box.style.borderColor = box.dataset.style === pair.style ? '#10b981' : '#333';
            });
            
            // Update status indicators
            document.getElementById('pair-text-status').innerHTML = pair.textFilename ? '‚úÖ Nalo≈æen' : '‚ùå Manjka';
            document.getElementById('pair-clean-status').innerHTML = pair.cleanFilename ? '‚úÖ Nalo≈æen' : '‚ùå Manjka';
            const textsCount = pair.texts?.length || 0;
            document.getElementById('pair-analysis-status').innerHTML = pair.analyzed ? `‚úÖ ${textsCount} tekstov` : '‚è≥ ƒåaka';
            
            // Show video preview if text video exists
            const videoPreviewSection = document.getElementById('video-preview-section-2');
            const videoPreview = document.getElementById('video-preview-2');
            if (pair.textFilename) {
                videoPreviewSection.style.display = 'block';
                videoPreview.src = `/launches/uploads/${pair.textFilename}`;
            } else {
                videoPreviewSection.style.display = 'none';
            }
            
            // Enable/disable analyze button
            document.getElementById('btn-analyze-single').disabled = !pair.textFilename;
            
            // Load detected texts
            detectedTexts = pair.texts || [];
            if (pair.analyzed && detectedTexts.length > 0) {
                document.getElementById('detected-texts').style.display = 'block';
                renderDetectedTexts();
            } else {
                document.getElementById('detected-texts').style.display = 'none';
            }
            
            updateNamePreviewMode2();
            renderPairsList();
            updateBulkButtons();
        };
        
        // Save current pair metadata
        window.savePairMetadata = function() {
            if (currentPairIndex < 0) return;
            const pair = videoPairs[currentPairIndex];
            if (!pair) return;
            
            pair.product = document.getElementById('video-product-2').value;
            pair.type = document.getElementById('video-type-2').value;
            pair.author = document.getElementById('video-author-2').value.toUpperCase();
            pair.style = document.getElementById('style-select-2').value;
            pair.fontSize = parseInt(document.getElementById('font-size-2').value) || 105;
            pair.uppercase = document.getElementById('uppercase-2')?.checked || false;
            
            // Only save texts if detectedTexts has data (don't overwrite with empty array)
            if (detectedTexts && detectedTexts.length > 0) {
                pair.texts = detectedTexts;
            }
            
            renderPairsList();
            updateBulkButtons();
        };
        
        // Analyze single pair with progress animation
        window.analyzeSinglePair = async function() {
            if (currentPairIndex < 0) return;
            const pair = videoPairs[currentPairIndex];
            if (!pair || !pair.textFilename) return;
            
            const startTime = Date.now();
            const btn = document.getElementById('btn-analyze-single');
            btn.disabled = true;
            
            // Mark as analyzing
            pair.analyzing = true;
            renderPairsList();
            
            // Animated progress
            let elapsed = 0;
            const progressInterval = setInterval(() => {
                elapsed = Math.round((Date.now() - startTime) / 1000);
                btn.textContent = `‚è≥ Analiziram... (${elapsed}s)`;
            }, 1000);
            
            document.getElementById('pair-analysis-status').innerHTML = '‚è≥ Analiziram...';
            
            try {
                const response = await fetch('/launches/api/localizer/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: pair.textFilename, mode: 'competitor' })
                });
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                // Process detected texts (include x,y coordinates)
                let rawTexts = (data.texts || []).map(t => ({
                    text: t.text || t.content || '',
                    start: parseFloat(t.start) || t.timestamp || 0,
                    end: parseFloat(t.end) || (t.timestamp || 0) + 2,
                    x: t.x ?? 50,
                    y: t.y ?? 50,
                    position: t.position || 'center',
                    style: pair.style || 'white'
                })).filter(t => t.text.trim());
                
                // Merge consecutive same texts
                detectedTexts = mergeConsecutiveTexts(rawTexts);
                pair.texts = detectedTexts;
                pair.analyzed = true;
                
                // Explicitly save to localStorage immediately after analysis
                saveVideoPairsToStorage();
                
                document.getElementById('detected-texts').style.display = 'block';
                document.getElementById('pair-analysis-status').innerHTML = `‚úÖ ${detectedTexts.length} tekstov`;
                renderDetectedTexts();
                renderPairsList();
                updateBulkButtons();
            } catch (e) {
                alert('Napaka pri analizi: ' + e.message);
                document.getElementById('pair-analysis-status').innerHTML = '‚ùå Napaka';
            }
            
            // Done analyzing
            clearInterval(progressInterval);
            pair.analyzing = false;
            
            btn.disabled = false;
            btn.textContent = 'üîç Analiziraj ta video';
            renderPairsList();
        };
        
        // Analyze all pairs - progressive with time estimate
        // Only analyzes COMPLETE pairs (have both text AND clean video)
        // SEQUENTIAL - one at a time, with global lock
        window.analyzeAllPairs = async function() {
            // Prevent parallel runs
            if (isAnalyzingBulk) {
                console.log('Analysis already running, skipping...');
                return;
            }
            
            const toAnalyze = videoPairs.filter(p => p.textFilename && p.cleanFilename && !p.analyzed && !p.analyzing);
            if (toAnalyze.length === 0) {
                console.log('No pairs to analyze');
                return;
            }
            
            isAnalyzingBulk = true;
            document.getElementById('btn-analyze-all').disabled = true;
            
            let done = 0;
            const total = toAnalyze.length;
            const analysisTimesMs = []; // Track analysis times for ETA
            const AVG_ANALYSIS_TIME_MS = 45000; // ~45s per video average
            let countdownInterval = null;
            let remainingMs = total * AVG_ANALYSIS_TIME_MS;
            
            // Show progress section
            document.getElementById('analysis-progress-section').style.display = 'block';
            
            // Helper to format time
            function formatETA(ms) {
                if (ms < 0) ms = 0;
                const mins = Math.floor(ms / 60000);
                const secs = Math.round((ms % 60000) / 1000);
                if (mins > 0) return `${mins}m ${secs}s`;
                return `${secs}s`;
            }
            
            // Update progress UI
            function updateProgress() {
                const percent = total > 0 ? Math.round((done / total) * 100) : 0;
                document.getElementById('analysis-progress-bar').style.width = percent + '%';
                document.getElementById('analysis-progress-text').textContent = `${done} / ${total} kreativ`;
                document.getElementById('analysis-countdown').textContent = formatETA(remainingMs);
                document.getElementById('btn-analyze-all').textContent = `‚è≥ ${done}/${total}`;
            }
            
            // Start countdown timer (updates every second)
            countdownInterval = setInterval(() => {
                remainingMs -= 1000;
                if (remainingMs < 0) remainingMs = 0;
                document.getElementById('analysis-countdown').textContent = formatETA(remainingMs);
            }, 1000);
            
            updateProgress();
            
            for (const pair of toAnalyze) {
                const startTime = Date.now();
                
                // Mark as currently analyzing
                pair.analyzing = true;
                renderPairsList();
                
                try {
                    const response = await fetch('/launches/api/localizer/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: pair.textFilename, mode: 'competitor' })
                    });
                    const data = await response.json();
                    
                    if (!data.error) {
                        let rawTexts = (data.texts || []).map(t => ({
                            text: t.text || t.content || '',
                            start: parseFloat(t.start) || t.timestamp || 0,
                            end: parseFloat(t.end) || (t.timestamp || 0) + 2,
                            x: t.x ?? 50,
                            y: t.y ?? 50,
                            position: t.position || 'center',
                            style: pair.style || 'white'
                        })).filter(t => t.text.trim());
                        
                        pair.texts = mergeConsecutiveTexts(rawTexts);
                        pair.analyzed = true;
                        
                        // Explicitly save to localStorage immediately after analysis
                        saveVideoPairsToStorage();
                    }
                } catch (e) {
                    console.error('Analysis failed for', pair.id, e);
                }
                
                // Done analyzing this one
                pair.analyzing = false;
                
                // Track analysis time
                const elapsedMs = Date.now() - startTime;
                analysisTimesMs.push(elapsedMs);
                
                done++;
                
                // Recalculate remaining time based on actual performance
                if (analysisTimesMs.length > 0) {
                    const avgTime = analysisTimesMs.reduce((a, b) => a + b, 0) / analysisTimesMs.length;
                    remainingMs = (total - done) * avgTime;
                }
                
                updateProgress();
                
                // PROGRESSIVE: Update UI immediately so user can edit this video
                renderPairsList();
                updateBulkButtons();
                
                // If user is viewing this pair, refresh the detected texts
                if (currentPairIndex >= 0 && videoPairs[currentPairIndex] === pair) {
                    detectedTexts = pair.texts || [];
                    document.getElementById('detected-texts').style.display = detectedTexts.length > 0 ? 'block' : 'none';
                    document.getElementById('pair-analysis-status').innerHTML = pair.analyzed ? `‚úÖ ${pair.texts.length} tekstov` : '‚è≥ ƒåaka';
                    if (detectedTexts.length > 0) renderDetectedTexts();
                }
            }
            
            // Release global lock
            isAnalyzingBulk = false;
            
            // Stop countdown and hide progress
            if (countdownInterval) clearInterval(countdownInterval);
            document.getElementById('analysis-progress-section').style.display = 'none';
            
            document.getElementById('btn-analyze-all').disabled = false;
            document.getElementById('btn-analyze-all').textContent = 'üîç Analiziraj vse';
            
            // Final update
            renderPairsList();
            updateBulkButtons();
            
            // Reload current pair to ensure latest data
            if (currentPairIndex >= 0) selectPair(currentPairIndex);
        };
        
        // Generate all pairs
        window.generateAllPairs = async function() {
            savePairMetadata();
            
            const ready = videoPairs.filter(p => p.textFilename && p.cleanFilename && p.analyzed && p.texts.length > 0 && p.author);
            if (ready.length === 0) {
                alert('Ni pripravljenih kreativ! Potrebuje≈°: text + clean video, analizo, in avtorja.');
                return;
            }
            
            const selectedCountries = getSelectedCountries2();
            if (selectedCountries.length === 0) {
                alert('Izberi vsaj eno dr≈æavo!');
                return;
            }
            
            document.getElementById('btn-generate-all').disabled = true;
            document.getElementById('btn-generate-all').textContent = `‚è≥ 0/${ready.length}`;
            
            const date = new Date().toLocaleDateString('sl-SI', { day: '2-digit', month: '2-digit', year: '2-digit' }).replace(/\. /g, '-').replace('.', '');
            
            let started = 0;
            for (const pair of ready) {
                try {
                    const name = `${pair.id}_${date}_${pair.product}_${pair.type}_${pair.author}`;
                    
                    await postJSON('/launches/api/localizer/generate', {
                        videoClean: pair.cleanFilename,
                        name: name,
                        namingParts: { id: pair.id, date, product: pair.product, type: pair.type, author: pair.author },
                        texts: pair.texts.map(t => ({
                            start: t.start,
                            end: t.end,
                            x: t.x ?? 50,
                            y: t.y ?? 50,
                            text: pair.uppercase ? t.text.toUpperCase() : t.text,
                            style: t.style || pair.style
                        })),
                        style: pair.style,
                        fontSize: pair.fontSize,
                        uppercase: pair.uppercase || false,
                        perTextStyles: true,
                        countries: selectedCountries,
                        source: 'localize-bulk'
                    });
                    
                    started++;
                    document.getElementById('btn-generate-all').textContent = `‚è≥ ${started}/${ready.length}`;
                } catch (e) {
                    console.error('Generate failed for', pair.id, e);
                }
            }
            
            // Generation complete - don't auto-open downloads panel
            // User can click Downloads button to see results
            // Keep pairs in list so user can edit and regenerate
            
            document.getElementById('btn-generate-all').disabled = false;
            document.getElementById('btn-generate-all').textContent = 'üöÄ Generiraj vse';
            
            // Don't clear - keep pairs so user can edit and regenerate
            renderPairsList();
            updateBulkButtons();
        };
        
        // Add all to queue
        window.addAllToQueue = async function() {
            savePairMetadata();
            
            const ready = videoPairs.filter(p => p.textFilename && p.cleanFilename && p.analyzed && p.texts.length > 0 && p.author);
            if (ready.length === 0) {
                alert('Ni pripravljenih kreativ!');
                return;
            }
            
            const selectedCountries = getSelectedCountries2();
            if (selectedCountries.length === 0) {
                alert('Izberi vsaj eno dr≈æavo!');
                return;
            }
            
            const date = new Date().toLocaleDateString('sl-SI', { day: '2-digit', month: '2-digit', year: '2-digit' }).replace(/\. /g, '-').replace('.', '');
            
            let added = 0;
            for (const pair of ready) {
                try {
                    const name = `${pair.id}_${date}_${pair.product}_${pair.type}_${pair.author}`;
                    
                    await postJSON('/launches/api/queue/add', {
                        mode: 'localize',
                        name: name,
                        namingParts: { id: pair.id, date, product: pair.product, type: pair.type, author: pair.author },
                        videoClean: pair.cleanFilename,
                        texts: pair.texts,
                        style: pair.style,
                        fontSize: pair.fontSize,
                        countries: selectedCountries
                    });
                    added++;
                } catch (e) {
                    console.error('Queue add failed for', pair.id, e);
                }
            }
            
            alert(`‚úÖ Dodano ${added} kreativ v vrsto`);
            refreshQueue();
            
            // Clear queued pairs
            videoPairs = videoPairs.filter(p => !ready.includes(p));
            currentPairIndex = -1;
            renderPairsList();
            document.getElementById('pair-edit-panel').style.display = 'none';
            document.getElementById('no-pair-selected').style.display = 'flex';
            updateBulkButtons();
        };
        
        // Clear all pairs
        window.clearAllPairs = function() {
            if (!confirm('Pobri≈°i vse video pare?')) return;
            videoPairs = [];
            currentPairIndex = -1;
            detectedTexts = [];
            renderPairsList();
            document.getElementById('pair-edit-panel').style.display = 'none';
            document.getElementById('no-pair-selected').style.display = 'flex';
            updateBulkButtons();
        };
        
        // Update bulk action buttons state
        function updateBulkButtons() {
            // Only count COMPLETE pairs (both text + clean) for analysis
            const hasUnanalyzed = videoPairs.some(p => p.textFilename && p.cleanFilename && !p.analyzed);
            const hasReady = videoPairs.some(p => p.textFilename && p.cleanFilename && p.analyzed && p.texts.length > 0 && p.author);
            
            const analyzeAllBtn = document.getElementById('btn-analyze-all');
            const generateAllBtn = document.getElementById('btn-generate-all');
            const queueAllBtn = document.getElementById('btn-queue-all');
            
            if (analyzeAllBtn) analyzeAllBtn.disabled = !hasUnanalyzed;
            if (generateAllBtn) generateAllBtn.disabled = !hasReady;
            if (queueAllBtn) queueAllBtn.disabled = !hasReady;
        }
        
        // Mode 2 helper functions
        function checkReadyMode2() {
            // For bulk mode, this is handled by updateBulkButtons()
            updateBulkButtons();
        }
        
        // Init naming for Mode 2
        function initNamingMode2() {
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yy = String(today.getFullYear()).slice(-2);
            document.getElementById('video-date-2').value = `${dd}-${mm}-${yy}`;
            updateNamePreviewMode2();
        }
        
        function updateNamePreviewMode2() {
            const id = document.getElementById('video-id-2')?.value || 'ID';
            const date = document.getElementById('video-date-2')?.value || 'DD-MM-YY';
            const product = document.getElementById('video-product-2')?.value || 'PRODUCT';
            const type = document.getElementById('video-type-2')?.value || 'TYPE';
            const author = document.getElementById('video-author-2')?.value.toUpperCase() || 'XX';
            
            const preview = `${id}_${date}_HR_${product}_${type}_${author}`;
            const el = document.getElementById('name-preview-2');
            if (el) el.textContent = preview;
        }
        
        function getVideoNameMode2(countryCode) {
            const id = document.getElementById('video-id-2')?.value || 'ID';
            const date = document.getElementById('video-date-2')?.value || 'DD-MM-YY';
            const product = document.getElementById('video-product-2')?.value || 'PRODUCT';
            const type = document.getElementById('video-type-2')?.value || 'TYPE';
            const author = document.getElementById('video-author-2')?.value.toUpperCase() || 'XX';
            return `${id}_${date}_${countryCode}_${product}_${type}_${author}`;
        }
        
        setTimeout(initNamingMode2, 100);
        
        // Add listeners for Mode 2 naming fields
        ['video-id-2', 'video-author-2', 'video-product-2', 'video-type-2'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', () => { updateNamePreviewMode2(); checkReadyMode2(); });
                el.addEventListener('change', () => { updateNamePreviewMode2(); checkReadyMode2(); });
            }
        });
        
        window.updateDetectedText = function(index, newText) {
            if (detectedTexts[index]) {
                detectedTexts[index].text = newText;
                updateTextsPreview();
                savePairMetadata();
            }
        };
        
        window.updateDetectedTextStyle = function(index, style) {
            if (detectedTexts[index]) {
                detectedTexts[index].style = style;
                updateTextsPreview();
                savePairMetadata();
            }
        };
        
        const stylePreviewCSS = {
            white: { background: '#fff', color: '#000', textShadow: 'none', border: 'none' },
            black: { background: '#000', color: '#fff', textShadow: 'none', border: '1px solid #333' },
            shadow: { background: 'transparent', color: '#fff', textShadow: '2px 2px 4px #000, -1px -1px 2px #000', border: 'none' },
            rounded: { background: '#fff', color: '#000', textShadow: 'none', border: 'none', borderRadius: '20px' },
            gradient: { background: '#10b981', color: '#fff', textShadow: 'none', border: 'none' },
            outline: { background: 'transparent', color: '#fff', textShadow: 'none', border: '2px solid #fff' },
            red: { background: '#ef4444', color: '#fff', textShadow: 'none', border: 'none' },
            orange: { background: '#f97316', color: '#fff', textShadow: 'none', border: 'none' },
            yellow: { background: '#eab308', color: '#000', textShadow: 'none', border: 'none' },
            green: { background: '#22c55e', color: '#fff', textShadow: 'none', border: 'none' },
            fire: { background: 'linear-gradient(135deg, #ff6600, #ff0000)', color: '#fff', textShadow: 'none', border: 'none' },
            neon: { background: '#000', color: '#0ff', textShadow: '0 0 10px #0ff, 0 0 20px #0ff', border: 'none' },
            explosive: { background: '#7c3aed', color: '#fff', textShadow: 'none', border: 'none' },
            pulse: { background: '#10b981', color: '#fff', textShadow: 'none', border: 'none' },
            urgent: { background: '#dc2626', color: '#fff', textShadow: 'none', border: 'none' },
            gold: { background: '#fbbf24', color: '#000', textShadow: 'none', border: 'none' }
        };
        
        window.updatePreviewMode2 = function() {
            const fontSize = parseInt(document.getElementById('font-size-2')?.value || 105);
            
            // Update font size display
            const fontSizeDisplay = document.getElementById('font-size-value-2');
            if (fontSizeDisplay) fontSizeDisplay.textContent = fontSize + 'px';
            
            // Update the texts preview with current styles
            updateTextsPreview();
        };
        
        window.toggleUppercase = function() {
            const isUppercase = document.getElementById('uppercase-2')?.checked || false;
            // Update preview with uppercase
            updateTextsPreview();
            savePairMetadata();
        };
        
        window.selectGlobalStyle2 = function(style) {
            // Update hidden input
            document.getElementById('style-select-2').value = style;
            // Update visual selection
            document.querySelectorAll('.style-box-2').forEach(box => {
                box.style.borderColor = box.dataset.style === style ? '#10b981' : '#333';
            });
            // Update preview
            updatePreviewMode2();
        };
        
        window.applyGlobalStyleMode2 = function() {
            const globalStyle = document.getElementById('style-select-2').value;
            detectedTexts.forEach(t => {
                t.style = globalStyle;
            });
            renderDetectedTexts();
        };
        
        // Apply selected style to all detected texts and save
        window.applyStyleToAllTexts = function() {
            const globalStyle = document.getElementById('style-select-2').value;
            if (detectedTexts.length === 0) {
                alert('Ni zaznanih tekstov!');
                return;
            }
            detectedTexts.forEach(t => {
                t.style = globalStyle;
            });
            renderDetectedTexts();
            savePairMetadata();
            
            // Visual feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úÖ Dodano!';
            btn.style.background = '#22c55e';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#10b981';
            }, 1500);
        };
        
        window.deleteDetectedText = function(index) {
            detectedTexts.splice(index, 1);
            renderDetectedTexts();
            checkReadyMode2();
        };
        
        function renderDetectedTexts() {
            const container = document.getElementById('texts-list');
            if (!container) return;
            
            if (detectedTexts.length === 0) {
                container.innerHTML = '<div class="empty-state">Ni zaznanih tekstov</div>';
                return;
            }
            
            const styleOptions = `
                <optgroup label="Osnovni">
                    <option value="white">‚¨ú Bela</option>
                    <option value="black">‚¨õ ƒårna</option>
                    <option value="shadow">üå´Ô∏è Senca</option>
                    <option value="rounded">üîò Zaobljeno</option>
                    <option value="gradient">üåà Gradient</option>
                    <option value="outline">‚úèÔ∏è Obroba</option>
                </optgroup>
                <optgroup label="Eksplozivni">
                    <option value="red">üî¥ Rdeƒça</option>
                    <option value="orange">üü† Oran≈æna</option>
                    <option value="yellow">üü° Rumena</option>
                    <option value="fire">üî• Ogenj</option>
                    <option value="neon">‚ö° Neon</option>
                    <option value="explosive">üí• Eksplozija</option>
                    <option value="green">üü¢ Zelena</option>
                    <option value="gold">‚ú® Zlato</option>
                </optgroup>
            `;
            
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <p style="color: #888; font-size: 12px; margin: 0;">
                        üí° Uredi tekste v <strong>sloven≈°ƒçino</strong>. Izberi stil za vsako sekcijo.
                    </p>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="mergeDuplicateTexts()" 
                            style="padding: 6px 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: #888; cursor: pointer; font-size: 12px;">
                            üîó Zdru≈æi duplikate
                        </button>
                        <button id="btn-auto-translate" onclick="autoTranslateToSlovenian()" 
                            style="padding: 6px 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; color: #888; cursor: pointer; font-size: 12px;">
                            ü§ñ AI prevod v SLO
                        </button>
                    </div>
                </div>
                ${detectedTexts.map((t, i) => `
                    <div class="detected-text-item" style="display: flex; gap: 10px; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                        <span style="background: #10b981; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; white-space: nowrap;">
                            ${(t.start || 0).toFixed(1)}s - ${(t.end || 0).toFixed(1)}s
                        </span>
                        <span style="background: #3b82f6; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 500; white-space: nowrap; color: #fff;" title="Pozicija (x%, y%)">
                            üìç ${Math.round(t.x || 50)}%, ${Math.round(t.y || 50)}%
                        </span>
                        <input type="text" value="${(t.text || '').replace(/"/g, '&quot;')}" 
                            onchange="updateDetectedText(${i}, this.value)"
                            onblur="updateDetectedText(${i}, this.value)"
                            style="flex: 1; min-width: 200px; padding: 8px 12px; background: #0f0f0f; border: 1px solid #333; border-radius: 6px; color: #fff; font-size: 14px;">
                        <select onchange="updateDetectedTextStyle(${i}, this.value)" 
                            style="padding: 6px 8px; background: #0f0f0f; border: 1px solid #333; border-radius: 6px; color: #fff; font-size: 12px;">
                            ${styleOptions.replace(`value="${t.style || 'white'}"`, `value="${t.style || 'white'}" selected`)}
                        </select>
                        <button onclick="deleteDetectedText(${i})" 
                            style="background: none; border: none; color: #f87171; cursor: pointer; padding: 5px; font-size: 16px;" 
                            title="Izbri≈°i">üóëÔ∏è</button>
                    </div>
                `).join('')}
                <button onclick="addNewDetectedText()" style="margin-top: 10px; padding: 10px 15px; background: #1a1a1a; border: 1px dashed #333; border-radius: 6px; color: #888; cursor: pointer; width: 100%;">
                    + Dodaj nov tekst
                </button>
            `;
            
            // Update the visual preview
            updateTextsPreview();
        }
        
        function updateTextsPreview() {
            const container = document.getElementById('texts-preview-container');
            if (!container) return;
            
            if (detectedTexts.length === 0) {
                container.innerHTML = '<div style="color:#666; font-size:13px;">Analiziraj video za preview</div>';
                return;
            }
            
            const fontSize = parseInt(document.getElementById('font-size-2')?.value || 105);
            const isUppercase = document.getElementById('uppercase-2')?.checked || false;
            const globalStyle = document.getElementById('style-select-2')?.value || 'white';
            
            // Calculate scale based on actual container width vs video width (1080)
            const containerWidth = container.offsetWidth || 225;
            const videoWidth = 1080;
            const previewScale = containerWidth / videoWidth;
            const previewFontSize = Math.max(Math.round(fontSize * previewScale), 10);
            
            container.innerHTML = detectedTexts.slice(0, 5).map(t => {
                // Always use global style for preview (shows what will be applied)
                const style = stylePreviewCSS[globalStyle] || stylePreviewCSS.white;
                const displayText = isUppercase ? (t.text || '...').toUpperCase() : (t.text || '...');
                return `<div style="
                    background: ${style.background};
                    color: ${style.color};
                    text-shadow: ${style.textShadow};
                    border: ${style.border};
                    border-radius: ${style.borderRadius || '4px'};
                    padding: 4px 12px;
                    font-size: ${previewFontSize}px;
                    font-weight: bold;
                    font-family: 'Noto Sans', Arial, sans-serif;
                    max-width: 90%;
                    text-align: center;
                    word-break: break-word;
                ">${displayText}</div>`;
            }).join('') + (detectedTexts.length > 5 ? `<div style="color:#666; font-size:11px;">+${detectedTexts.length - 5} veƒç...</div>` : '');
        }
        
        window.addNewDetectedText = function() {
            // Add new text at the end of last text or at 0
            const lastEnd = detectedTexts.length > 0 ? detectedTexts[detectedTexts.length - 1].end : 0;
            detectedTexts.push({
                start: lastEnd,
                end: lastEnd + 2,
                text: '',
                position: 'center'
            });
            renderDetectedTexts();
            // Focus on the new input
            setTimeout(() => {
                const inputs = document.querySelectorAll('#texts-list input[type="text"]');
                if (inputs.length > 0) inputs[inputs.length - 1].focus();
            }, 100);
        };
        
        window.mergeDuplicateTexts = function() {
            if (detectedTexts.length < 2) return;
            const before = detectedTexts.length;
            detectedTexts = mergeConsecutiveTexts(detectedTexts);
            const after = detectedTexts.length;
            renderDetectedTexts();
            savePairMetadata(); // Save merged texts
            if (before !== after) {
                console.log(`Merged ${before} texts into ${after}`);
            }
        };
        
        window.autoTranslateToSlovenian = async function() {
            if (detectedTexts.length === 0) return;
            
            const btn = document.getElementById('btn-auto-translate');
            btn.textContent = '‚è≥ Prevajam...';
            btn.disabled = true;
            
            try {
                const transData = await postJSON('/launches/api/localizer/to-slovenian', {
                    texts: detectedTexts.map(t => t.text)
                });
                
                // Update detectedTexts with Slovenian translations
                detectedTexts = detectedTexts.map((t, i) => ({
                    ...t,
                    originalText: t.text,
                    text: transData.translations?.[i] || t.text
                }));
                
                // Merge duplicate texts after translation (same text = one entry)
                detectedTexts = mergeConsecutiveTexts(detectedTexts);
                
                renderDetectedTexts();
                savePairMetadata(); // Save merged texts
            } catch (e) {
                console.error('Translation failed:', e);
                alert('Napaka pri prevajanju: ' + e.message);
            }
            
            btn.textContent = 'ü§ñ AI prevod v SLO';
            btn.disabled = false;
        };
        
        // Merge consecutive texts with same content
        function mergeConsecutiveTexts(texts) {
            if (!texts || texts.length === 0) return [];
            
            // Sort by start time first
            const sorted = [...texts].sort((a, b) => a.start - b.start);
            const merged = [];
            
            for (const t of sorted) {
                const tNorm = (t.text || '').trim().toLowerCase();
                
                // Find existing text with same content that overlaps or is consecutive
                const existing = merged.find(m => {
                    const mNorm = (m.text || '').trim().toLowerCase();
                    if (mNorm !== tNorm) return false;
                    
                    // Check for overlap: t.start <= m.end AND t.end >= m.start
                    const overlaps = t.start <= m.end && t.end >= m.start;
                    // Check for consecutive (within 1s gap)
                    const gap = t.start - m.end;
                    const isConsecutive = gap > 0 && gap <= 1;
                    
                    return overlaps || isConsecutive;
                });
                
                if (existing) {
                    // Merge: extend time range to cover both
                    existing.start = Math.min(existing.start, t.start);
                    existing.end = Math.max(existing.end, t.end);
                } else {
                    // Add new entry
                    merged.push({ ...t });
                }
            }
            
            // Sort result by start time
            return merged.sort((a, b) => a.start - b.start);
        }
        
        // Legacy functions - now handled by bulk mode
        window.analyzeVideo = function() { console.log('Use analyzeSinglePair() for bulk mode'); };
        window.localizeVideo = function() { console.log('Use generateAllPairs() for bulk mode'); };
        
        // ============ QUEUE FUNCTIONS ============
        
        // Add to queue - Mode 1 (library texts)
        window.addToQueue = async function() {
            const id = document.getElementById('video-id').value.trim();
            const date = document.getElementById('video-date').value;
            const product = document.getElementById('video-product').value;
            const type = document.getElementById('video-type').value;
            const author = document.getElementById('video-author').value.toUpperCase();
            const namingParts = { id, date, product, type, author };
            const name = `${id}_${date}_${product}_${type}_${author}`;
            
            const texts = flattenTexts();
            
            if (texts.length === 0) {
                alert('Ni tekstov za dodati!');
                return;
            }
            
            // Get selected countries
            const selectedCountries = getSelectedCountries();
            if (selectedCountries.length === 0) {
                alert('Izberi vsaj eno dr≈æavo!');
                return;
            }
            
            try {
                const data = await postJSON('/launches/api/queue/add', {
                    mode: 'library',
                    name,
                    namingParts,
                    videoClean: uploadedFilename,
                    texts,
                    style: selectedStyle,
                    fontSize,
                    countries: selectedCountries
                });
                
                if (data.error) throw new Error(data.error);
                
                alert(`‚úÖ Dodano v vrsto: ${name} (${selectedCountries.length} dr≈æav)`);
                refreshQueue();
                clearAll();
            } catch(e) {
                alert('Napaka: ' + e.message);
            }
        };
        
        // Add to queue - Mode 2 (localize existing)
        window.addToQueueMode2 = async function() {
            const id = document.getElementById('video-id-2').value.trim();
            const date = document.getElementById('video-date-2').value;
            const product = document.getElementById('video-product-2').value;
            const type = document.getElementById('video-type-2').value;
            const author = document.getElementById('video-author-2').value.toUpperCase();
            const namingParts = { id, date, product, type, author };
            const name = `${id}_${date}_${product}_${type}_${author}`;
            
            const style2 = document.getElementById('style-select-2').value;
            const fontSize2 = parseInt(document.getElementById('font-size-2').value);
            
            // Get selected countries for Mode 2
            const selectedCountries2 = getSelectedCountries2();
            if (selectedCountries2.length === 0) {
                alert('Izberi vsaj eno dr≈æavo!');
                return;
            }
            
            try {
                const data = await postJSON('/launches/api/queue/add', {
                    mode: 'localize',
                    name,
                    namingParts,
                    videoClean: uploadedCleanVideo,
                    texts: detectedTexts.map(t => ({ 
                        start: parseFloat(t.start) || t.timestamp || 0, 
                        end: parseFloat(t.end) || (t.timestamp || 0) + (t.duration || 2), 
                        text: t.text,
                        position: t.position || 'center'
                    })),
                    style: style2,
                    fontSize: fontSize2,
                    countries: selectedCountries2
                });
                
                if (data.error) throw new Error(data.error);
                
                alert(`‚úÖ Dodano v vrsto: ${name} (${selectedCountries2.length} dr≈æav)`);
                refreshQueue();
                
                // Reset Mode 2
                uploadedTextVideo = null;
                uploadedCleanVideo = null;
                detectedTexts = [];
                document.getElementById('upload-zone-text').innerHTML = '<div class="icon">üìù</div><h4>Video Z besedilom</h4><p>Za analizo pozicij tekstov</p>';
                document.getElementById('upload-zone-clean').innerHTML = '<div class="icon">üé¨</div><h4>Video BREZ besedila</h4><p>Za konƒçni render</p>';
                document.getElementById('detected-texts').style.display = 'none';
                document.getElementById('video-name-2').value = '';
                checkReadyMode2();
            } catch(e) {
                alert('Napaka: ' + e.message);
            }
        };
        
        // Refresh queue list
        window.refreshQueue = async function() {
            try {
                const data = await getJSON('/launches/api/queue/list');
                // Filter out completed jobs - they're visible in Downloads
                const queue = (data.queue || []).filter(job => job.status !== 'done');
                
                document.getElementById('queue-count').textContent = `${queue.length} v vrsti`;
                
                if (queue.length === 0) {
                    document.getElementById('queue-list').innerHTML = '<div class="empty-state">ƒåakalna vrsta je prazna</div>';
                } else {
                    document.getElementById('queue-list').innerHTML = queue.map(job => `
                        <div class="queue-item">
                            <div class="queue-item-info">
                                <div class="queue-item-name">${job.name}</div>
                                <div class="queue-item-meta">${job.texts?.length || 0} tekstov ‚Ä¢ ${job.mode === 'library' ? 'Knji≈ænica' : 'Lokalizacija'}</div>
                            </div>
                            <span class="queue-item-status ${job.status}">${
                                job.status === 'pending' ? '‚è≥ ƒåaka' :
                                job.status === 'processing' ? 'üîÑ V teku' :
                                job.status === 'done' ? '‚úÖ Konƒçano' : '‚ùå Napaka'
                            }</span>
                            ${job.status === 'pending' ? `<button class="btn btn-secondary btn-sm" onclick="removeFromQueue('${job.id}')" style="margin-left:10px">üóëÔ∏è</button>` : ''}
                        </div>
                    `).join('');
                }
            } catch(e) {
                console.error('Queue refresh error:', e);
            }
        };
        
        // Remove from queue
        window.removeFromQueue = async function(jobId) {
            if (!confirm('Odstrani iz vrste?')) return;
            try {
                await postJSON('/launches/api/queue/remove', { jobId });
                refreshQueue();
            } catch(e) {
                alert('Napaka: ' + e.message);
            }
        };
        
        // Process queue now
        window.processQueueNow = async function() {
            if (!confirm('Zaƒçni procesiranje vseh v vrsti ZDAJ?')) return;
            try {
                const data = await postJSON('/launches/api/queue/process', {});
                alert(`üöÄ Procesiranje zaƒçeto! ${data.count} job(s) v vrsti.`);
                refreshQueue();
            } catch(e) {
                alert('Napaka: ' + e.message);
            }
        };
        
        // Load queue on page load
        setTimeout(refreshQueue, 500);
        
        // ============ END QUEUE FUNCTIONS ============
        
        // ============ DOWNLOADS PANEL ============
        const FLAGS = { HR: 'üá≠üá∑', CZ: 'üá®üáø', PL: 'üáµüá±', GR: 'üá¨üá∑', IT: 'üáÆüáπ', HU: 'üá≠üá∫', SK: 'üá∏üá∞' };
        const LANGS = ['HR', 'CZ', 'PL', 'GR', 'IT', 'HU', 'SK'];
        let allDownloadJobs = [];
        let downloadedItems = {}; // Will be loaded per user
        let currentDownloadTab = 'library'; // 'library' or 'localize'
        
        window.switchDownloadTab = function(tab) {
            currentDownloadTab = tab;
            // Update tab styles
            document.getElementById('tab-library').style.background = tab === 'library' ? '#10b981' : '#333';
            document.getElementById('tab-library').style.color = tab === 'library' ? '#000' : '#888';
            document.getElementById('tab-localize').style.background = tab === 'localize' ? '#10b981' : '#333';
            document.getElementById('tab-localize').style.color = tab === 'localize' ? '#000' : '#888';
            // Re-render with filter
            filterDownloads();
        };
        
        window.toggleDownloads = function() {
            const panel = document.getElementById('downloads-panel');
            const overlay = document.getElementById('downloads-overlay');
            const isOpen = panel.style.right === '0px';
            panel.style.right = isOpen ? '-450px' : '0px';
            overlay.style.display = isOpen ? 'none' : 'block';
            if (!isOpen) loadDownloads();
        };
        
        async function loadDownloads() {
            try {
                const response = await fetch('/launches/api/localizer/jobs');
                const data = await response.json();
                allDownloadJobs = (data.jobs || []).sort((a, b) => new Date(b.created) - new Date(a.created));
                filterDownloads(); // Apply current tab filter
            } catch (e) {
                document.getElementById('downloads-list').innerHTML = '<div style="color:#f87171; text-align:center;">Napaka pri nalaganju</div>';
            }
        }
        
        window.filterDownloads = function() {
            const query = document.getElementById('downloads-search').value.toLowerCase();
            // Filter by tab using source field
            let filtered = allDownloadJobs.filter(j => {
                const jobSource = j.source || 'library'; // Default to library for old jobs
                return jobSource === currentDownloadTab;
            });
            // Apply search filter
            if (query) {
                filtered = filtered.filter(j => j.name?.toLowerCase().includes(query) || j.id?.toLowerCase().includes(query));
            }
            renderDownloads(filtered);
        };
        
        function renderDownloads(jobs) {
            const container = document.getElementById('downloads-list');
            if (jobs.length === 0) {
                container.innerHTML = '<div style="color:#666; text-align:center; padding:40px;">Ni najdenih videov.<br><br>Uporabi "üöÄ Generiraj zdaj" ali "üåô Dodaj v vrsto" za generiranje.</div>';
                return;
            }
            
            const currentUserUpper = (currentUser || '').toUpperCase();
            
            container.innerHTML = jobs.map(job => {
                const progress = job.completed || 0;
                const total = job.countries?.length || 7;
                const percent = Math.round((progress / total) * 100);
                const statusClass = job.status || 'pending';
                const statusText = statusClass === 'done' ? '‚úÖ Konƒçano' : 
                                   statusClass === 'generating' ? '‚è≥ ' + (job.currentLang || percent + '%') :
                                   statusClass === 'translating' ? 'üîÑ Prevajanje' :
                                   statusClass === 'error' ? '‚ùå Napaka' : '‚è∏Ô∏è V vrsti';
                
                const borderColor = statusClass === 'done' ? '#10b981' : statusClass === 'generating' ? '#fbbf24' : '#333';
                const badgeBg = statusClass === 'done' ? '#10b98133' : statusClass === 'generating' ? '#fbbf2433' : '#333';
                const badgeColor = statusClass === 'done' ? '#10b981' : statusClass === 'generating' ? '#fbbf24' : '#888';
                
                // Check if current user can delete this job
                const jobAuthor = (job.namingParts?.author || '').toUpperCase();
                const canDelete = currentUserUpper && jobAuthor && currentUserUpper === jobAuthor;
                
                let html = '<div style="background:#0f0f0f; border-radius:10px; padding:15px; margin-bottom:12px; border:1px solid ' + borderColor + ';">';
                html += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">';
                html += '<strong style="flex:1;">' + (job.name || job.id) + '</strong>';
                html += '<span style="font-size:12px; padding:3px 8px; border-radius:10px; background:' + badgeBg + '; color:' + badgeColor + '; margin-right:8px;">' + statusText + '</span>';
                if (canDelete) {
                    html += '<button onclick="deleteJob(\'' + job.id + '\')" style="background:#7f1d1d; border:1px solid #ef4444; color:#fff; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;" title="Izbri≈°i">üóëÔ∏è</button>';
                }
                html += '</div>';
                
                if (statusClass !== 'done' && statusClass !== 'error') {
                    html += '<div style="background:#333; border-radius:4px; height:6px; margin-bottom:10px; overflow:hidden;">';
                    html += '<div style="background:#10b981; height:100%; width:' + percent + '%;"></div>';
                    html += '</div>';
                }
                
                if (statusClass === 'done') {
                    const langs = job.countries || LANGS;
                    html += '<div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px;">';
                    langs.forEach(lang => {
                        const key = job.id + '-' + lang;
                        const isDownloaded = downloadedItems[key];
                        const bg = isDownloaded ? '#7f1d1d' : '#1a1a1a';
                        const border = isDownloaded ? '#ef4444' : '#333';
                        html += '<a href="/launches/api/localizer/job/' + job.id + '/video/' + lang + '" download onclick="markDownloaded(\'' + key + '\')" style="display:flex; align-items:center; gap:6px; padding:8px; background:' + bg + '; border-radius:6px; text-decoration:none; color:#fff; font-size:13px; border:1px solid ' + border + ';">';
                        html += '<span>' + FLAGS[lang] + '</span>';
                        html += '<span>' + lang + '</span>';
                        html += '</a>';
                    });
                    html += '</div>';
                }
                
                html += '<div style="font-size:11px; color:#666; margin-top:8px;">' + new Date(job.created).toLocaleString('sl-SI') + '</div>';
                html += '</div>';
                return html;
            }).join('');
        }
        
        window.markDownloaded = function(key) {
            downloadedItems[key] = true;
            localStorage.setItem('downloadedItems', JSON.stringify(downloadedItems));
            setTimeout(() => renderDownloads(allDownloadJobs), 100);
        };
        
        window.deleteJob = async function(jobId) {
            if (!confirm('Ali res ≈æeli≈° izbrisati to kreativo?')) return;
            
            try {
                const response = await fetch('/launches/api/localizer/job/' + jobId, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ author: currentUser })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    alert(data.error || 'Napaka pri brisanju');
                    return;
                }
                
                // Remove from local list and re-render
                allDownloadJobs = allDownloadJobs.filter(j => j.id !== jobId);
                renderDownloads(allDownloadJobs);
            } catch (e) {
                alert('Napaka: ' + e.message);
            }
        };
        
        // Auto-refresh downloads if panel is open
        setInterval(() => {
            const panel = document.getElementById('downloads-panel');
            if (panel.style.right === '0px') {
                // Always refresh if any job is not done
                const hasActiveJobs = allDownloadJobs.some(j => j.status !== 'done' && j.status !== 'error');
                if (hasActiveJobs || allDownloadJobs.length === 0) {
                    loadDownloads();
                }
            }
        }, 2000);
        
        // ============ END DOWNLOADS PANEL ============
        
        // Initialize
        if (checkAuth()) {
            loadUserData();
        }
        renderLibrary();
        setTimeout(updateStylePreview, 150);
        
        // Load saved videoPairs from localStorage (Mode 2)
        if (loadVideoPairsFromStorage() && videoPairs.length > 0) {
            // Switch to Mode 2 (localize/bulk) if we have saved pairs
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.mode-content').forEach(c => c.classList.remove('active'));
            document.querySelector('.mode-tab[data-mode="localize"]').classList.add('active');
            document.getElementById('mode-localize').classList.add('active');
            
            renderPairsList();
            updateBulkButtons();
            
            if (currentPairIndex >= 0 && currentPairIndex < videoPairs.length) {
                selectPair(currentPairIndex);
            }
            console.log('Restored', videoPairs.length, 'video pairs from session');
        }
        
        // Save state before navigating away (to downloads page or refresh)
        window.addEventListener('beforeunload', function() {
            // Save current pair metadata first
            if (currentPairIndex >= 0) savePairMetadata();
            // Then save all to localStorage
            saveVideoPairsToStorage();
        });
        
        // Also save when visibility changes (tab switch, minimize)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                if (currentPairIndex >= 0) savePairMetadata();
                saveVideoPairsToStorage();
            }
        });
    </script>
</body>
</html>
